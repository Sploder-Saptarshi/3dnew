var _____WB$wombat$assign$function_____ = function(name) {return (self._wb_wombat && self._wb_wombat.local_init && self._wb_wombat.local_init(name)) || self[name]; };
if (!self.__WB_pmw) { self.__WB_pmw = function(obj) { this.__WB_source = obj; return this; } }
{
  let window = _____WB$wombat$assign$function_____("window");
  let self = _____WB$wombat$assign$function_____("self");
  let document = _____WB$wombat$assign$function_____("document");
  let location = _____WB$wombat$assign$function_____("location");
  let top = _____WB$wombat$assign$function_____("top");
  let parent = _____WB$wombat$assign$function_____("parent");
  let frames = _____WB$wombat$assign$function_____("frames");
  let opener = _____WB$wombat$assign$function_____("opener");

"PIXI"in window&&(PIXI.RenderTexture.prototype.renderToCanvas=function(e){var t=this.renderer.gl,i=this.textureBuffer.width,s=this.textureBuffer.height,o=new Uint8Array(4*i*s);t.bindFramebuffer(t.FRAMEBUFFER,this.textureBuffer.frameBuffer),t.readPixels(0,0,i,s,t.RGBA,t.UNSIGNED_BYTE,o),t.bindFramebuffer(t.FRAMEBUFFER,null),e.resize(i,s);var n=e.context.getImageData(0,0,i,s);return n.data.set(o),e.context.putImageData(n,0,0),e.canvas},PIXI.RenderTexture.prototype.renderToDataTexture=function(e){var t=this.renderer.gl,i=this.textureBuffer.width,s=this.textureBuffer.height,o=new Uint8Array(4*i*s);t.bindFramebuffer(t.FRAMEBUFFER,this.textureBuffer.frameBuffer),t.readPixels(0,0,i,s,t.RGBA,t.UNSIGNED_BYTE,o),t.bindFramebuffer(t.FRAMEBUFFER,null);var n=e.image;n&&(n.width=i,n.height=s,n.data=o)}),THREE.BoxGeometry=function(e,t,i,s,o,n,a,r){function h(e,t,i,s,o,n,r,h){var l,d,R,P=E.widthSegments,c=E.heightSegments,O=o/2,u=n/2,L=E.vertices.length;"x"===e&&"y"===t||"y"===e&&"x"===t?l="z":"x"===e&&"z"===t||"z"===e&&"x"===t?(l="y",c=E.depthSegments):("z"===e&&"y"===t||"y"===e&&"z"===t)&&(l="x",P=E.depthSegments);var S=P+1,T=c+1,D=o/P,m=n/c,p=new THREE.Vector3;for(p[l]=r>0?1:-1,R=0;T>R;R++)for(d=0;S>d;d++){var f=new THREE.Vector3;f[e]=(d*D-O)*i,f[t]=(R*m-u)*s,f[l]=r,E.vertices.push(f)}for(R=0;c>R;R++)for(d=0;P>d;d++){var g,I=d+S*R,y=d+S*(R+1),_=d+1+S*(R+1),w=d+1+S*R,v=new THREE.Vector2(d/P,1-R/c),A=new THREE.Vector2(d/P,1-(R+1)/c),M=new THREE.Vector2((d+1)/P,1-(R+1)/c),N=new THREE.Vector2((d+1)/P,1-R/c),x=0==d&&2==P||1==P&&i*s==-1;a&&(x=!x),g=x?new THREE.Face3(I+L,y+L,_+L):new THREE.Face3(I+L,y+L,w+L),g.normal.copy(p),g.vertexNormals.push(p.clone(),p.clone(),p.clone()),g.materialIndex=h,E.faces.push(g),E.faceVertexUvs[0].push(x?[v,A,M]:[v,A,N]),g=x?new THREE.Face3(I+L,_+L,w+L):new THREE.Face3(y+L,_+L,w+L),g.normal.copy(p),g.vertexNormals.push(p.clone(),p.clone(),p.clone()),g.materialIndex=h,E.faces.push(g),E.faceVertexUvs[0].push(x?[v.clone(),M.clone(),N]:[A.clone(),M,N.clone()])}}THREE.Geometry.call(this),a=a||!1,this.type="BoxGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:s,heightSegments:o,depthSegments:n},this.widthSegments=s||1,this.heightSegments=o||1,this.depthSegments=n||1,r=r||0;var E=this,l=e/2,d=t/2,R=i/2;if(h("z","y",-1,-1,i,t,l,0),h("z","y",1,-1,i,t,-l,1),h("x","z",1,1,e,i,d,2),h("x","z",1,-1,e,i,-d,3),h("x","y",1,-1,e,t,R,4),h("x","y",-1,-1,e,t,-R,5),this.mergeVertices(),0!=r)for(var P,c,O=this.vertices.length,u=r/t*.5;O--;)P=this.vertices[O],c=P.y/t,P.x*=1+u*c,P.z*=1+u*c},THREE.BoxGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.BoxGeometry.prototype.constructor=THREE.BoxGeometry,THREE.PlaneBufferGeometry=function(e,t,i,s,o){THREE.BufferGeometry.call(this),this.type="PlaneBufferGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:s};for(var n=e/2,a=t/2,r=i||1,h=s||1,E=r+1,l=h+1,d=e/r,R=t/h,P=new Float32Array(E*l*3),c=new Float32Array(E*l*3),O=new Float32Array(E*l*2),u=0,L=0,S=0;l>S;S++)for(var T=S*R-a,D=0;E>D;D++){var m=D*d-n;P[u]=m,P[u+1]=-T,c[u+2]=1,O[L]=D/r,O[L+1]=1-S/h,u+=3,L+=2}u=0;for(var p=new(P.length/3>65535?Uint32Array:Uint16Array)(r*h*6),S=0;h>S;S++)for(var D=0;r>D;D++){var f=D+E*S,g=D+E*(S+1),I=D+1+E*(S+1),y=D+1+E*S,_=0==D&&2==r;o&&(_=!_),_?(p[u]=f,p[u+1]=g,p[u+2]=y,p[u+3]=g,p[u+4]=I,p[u+5]=y):(p[u]=f,p[u+1]=g,p[u+2]=I,p[u+3]=f,p[u+4]=I,p[u+5]=y),u+=6}this.addAttribute("index",new THREE.BufferAttribute(p,1)),this.addAttribute("position",new THREE.BufferAttribute(P,3)),this.addAttribute("normal",new THREE.BufferAttribute(c,3)),this.addAttribute("uv",new THREE.BufferAttribute(O,2))},THREE.PlaneBufferGeometry.prototype=Object.create(THREE.BufferGeometry.prototype),THREE.PlaneBufferGeometry.prototype.constructor=THREE.PlaneBufferGeometry,THREE.PlaneGeometry=function(e,t,i,s){THREE.Geometry.call(this),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:s},this.fromBufferGeometry(new THREE.PlaneBufferGeometry(e,t,i,s))},THREE.PlaneGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.PlaneGeometry.prototype.constructor=THREE.PlaneGeometry;var THREEx=THREEx||{};THREEx.WindowResize=function(e,t){var i=function(){e.setSize(window.innerWidth,window.innerHeight),t.aspect=window.innerWidth/window.innerHeight,t.updateProjectionMatrix()};return window.addEventListener("resize",i,!1),{stop:function(){window.removeEventListener("resize",i)}}},window.SPLODER||(window.SPLODER={}),SPLODER.ACTION_DEFAULT=0,SPLODER.ACTION_DESELECT=1,SPLODER.ACTION_SELECT_POINT=2,SPLODER.ACTION_SELECT_ITEM=3,SPLODER.ACTION_SELECT_WINDOW=4,SPLODER.ACTION_SELECT_ALL=5,SPLODER.ACTION_SELECTION_START=6,SPLODER.ACTION_SELECTION_MOVE=7,SPLODER.ACTION_SELECTION_DUPLICATE=8,SPLODER.ACTION_SELECTION_MIRROR_H=9,SPLODER.ACTION_SELECTION_MIRROR_V=10,SPLODER.ACTION_SELECTION_ROTATE=11,SPLODER.ACTION_SELECTION_RELEASE=12,SPLODER.ACTION_SELECTION_DELETE=13,SPLODER.ACTION_CLIPBOARD_COPY=14,SPLODER.ACTION_CLIPBOARD_PASTE=15,SPLODER.ACTION_CREATE=16,SPLODER.ACTION_TWEAK=17,SPLODER.ACTION_CHANGE=18,SPLODER.ACTION_CHANGE_COMPLETE=19,SPLODER.ACTION_SET_CURRENTSTATE=20,SPLODER.ACTION_CLEAR_STATE=21,SPLODER.ACTION_CLEAR_PROPERTY=22,SPLODER.ACTION_UNDO=23,SPLODER.ACTION_REDO=24,SPLODER.ACTION_CONNECT=25,SPLODER.ACTION_DISCONNECT=26,SPLODER.ACTION_CONTEXT_CHANGE=27,SPLODER.ACTION_RETURNED_ERROR=32,SPLODER._documentConnected=!1,SPLODER._holdInterval=0,SPLODER.bind=function(e,t){return function(){t.apply(e,arguments)}},SPLODER.bindWithFuncRef=function(e,t,i){var s=function(){t.call(e,arguments[0],s,i)};return s},SPLODER.bindInteractions=function(e,t,i,s,o){e&&t&&(e.interactive=!0,e.buttonMode=!0,i&&(e.mousedown=e.touchstart=SPLODER.bind(t,i)),s&&(e.mousemove=e.touchmove=SPLODER.bind(t,s)),o&&(e.mouseup=e.mouseupoutside=e.touchend=e.touchendoutside=SPLODER.bind(t,o)))},SPLODER.connectButtons=function(e,t,i,s,o){t=t||document;var n,a,r=t.getElementsByTagName("a");if(i){for(a=0;a<r.length;a++)n=r.item(a),SPLODER._connectButton(e,n,i,s,o);if(!SPLODER._documentConnected){if(s)for(a=0;a<document.forms.length;a++)document.forms[a].onchange=function(t){s.call(e,t.target)};var h=function(){clearInterval(SPLODER._holdInterval)};document.addEventListener("mouseup",h),document.addEventListener("touchend",h),SPLODER._documentConnected=!0}}},SPLODER._connectButton=function(e,t,i,s,o){var n,a,r=!1,h=function(t){!a&&t&&i.call(e,t.target.dataset.id,t.target,t.target.dataset.value,t),a=!1},E=function(e){clearInterval(SPLODER._holdInterval),n=Date.now(),r=!0,SPLODER._holdInterval=setInterval(function(){l.call(null,e)},125)},l=function(t){t&&t.target&&Date.now()-n>500&&(i.call(e,t.target.dataset.id,t.target,t.target.dataset.value,t),a=!0)},d=function(i){if(clearInterval(SPLODER._holdInterval),r&&i.target.parentNode==t&&(r=!1,o)){var s=i.target;o.call(e,s.dataset.id,s,s.dataset.value,i)}};t.onclick||(t.onclick=h,t.addEventListener("mousedown",E),t.addEventListener("mouseout",d),t.addEventListener("mouseup",d),t.addEventListener("touchstart",E),t.addEventListener("touchend",d))},SPLODER.clearClassListById=function(e){var t=document.getElementById(e);t&&(t.className="")},SPLODER.getClassListById=function(e){return SPLODER.getClassList(document.getElementById(e))},SPLODER.hasClass=function(e,t){var i=SPLODER.getClassListById(e);return i?i.contains(t):void 0},SPLODER.setClass=function(e,t,i){var s=SPLODER.getClassListById(e);s&&(i?s.remove(t):s.add(t))},SPLODER.getClassList=function(e){return e?e.classList:void 0},SPLODER.enableButtons=function(){arguments.length&&SPLODER.setButtonsState(arguments,!0)},SPLODER.disableButtons=function(){arguments.length&&SPLODER.setButtonsState(arguments,!1)},SPLODER.setButtonsState=function(e,t){for(var i=0;i<e.length;i++){var s=document.querySelector('[data-id="'+e[i]+'"]');if(s){var o=s.classList;if(o){t?o.remove("disabled"):o.add("disabled");var n=s.parentNode.parentNode;n&&"LABEL"==n.nodeName&&(t?n.classList.remove("disabled"):n.classList.add("disabled"),"INPUT"==n.firstChild.nodeName&&(n.firstChild.disabled=!t))}}}},SPLODER.buttonIsEnabled=function(e){var t=document.querySelector('[data-id="'+e+'"]');return t?!t.classList.contains("disabled"):!1},SPLODER.hide=function(e){for(var t=$$$(e),i=t.length;i--;)t[i].classList.add("hidden")},SPLODER.parseFloatArray=function(e){if(e instanceof Array)for(var t=e.length;t--;){var i=e[t],s=parseFloat(i);e[t]=isNaN(s)?i:s}return e},SPLODER.shallowCopyUniforms=function(e,t,i){for(var s in t)e.hasOwnProperty(s)&&(i&&-1!=i.indexOf(s)?t[s]=e[s]:t[s].value=e[s].value)},SPLODER.setAttrib=function(e,t,i,s,o,n){s=s||0,o=o||255,e.setAttrib(t,Math.min(o,Math.max(s,i)),n)},SPLODER.incrementAttrib=function(e,t,i,s,o,n){var a=e.getAttrib(t,n);isNaN(a)&&(a=Math.max(0,s)),isNaN(i)||(isNaN(s)&&(s=-1e4),isNaN(o)&&(o=1e4),e.setAttrib(t,Math.max(s,Math.min(o,a+i)),n))},SPLODER.modAttrib=function(e,t,i,s,o){var n=e.getAttrib(t,o);isNaN(n)&&(n=0),isNaN(s)&&(s=360),isNaN(i)||e.setAttrib(t,(n+i)%s,o)},SPLODER.toggleAttrib=function(e,t,i){var s=e.getAttrib(t,i);e.setAttrib(t,1===parseInt(s)?0:1,i)},SPLODER.weightedValue=function(e){e=e||0;var t,i,s,o=0;for(t=1;t<arguments.length;t+=2)i=arguments[t],s=arguments[t+1],o+=(i-1)*s;return o+1+e},SPLODER.lerp=function(e,t,i){return i=Math.max(0,Math.min(1,i)),e+(t-e)*i},SPLODER.easeInQuad=function(e,t,i,s){return e/=s,i*e*e+t},SPLODER.easeOutQuad=function(e,t,i,s){return e/=s,-i*e*(e-2)+t},SPLODER.easeInCubic=function(e,t,i,s){return e/=s,i*e*e*e+t},SPLODER.easeOutCubic=function(e,t,i,s){return e/=s,e--,i*(e*e*e+1)+t},SPLODER.util={},SPLODER.util.modulo=function(e,t){return(e%t+t)%t},SPLODER.util.zeroPad=function(e,t){for(var i=e+"";i.length<t;)i="0"+i;return i},SPLODER.util.isIE=function(){return-1!==navigator.appVersion.indexOf("MSIE")||-1!==navigator.appVersion.indexOf("Trident")},SPLODER.util.supports_html5_storage=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}};var $$=function(){return document.querySelector.apply(document,arguments)},$$$=function(){return document.querySelectorAll.apply(document,arguments)};SPLODER.AtlasLoader=function(e){THREE.Loader.call(this,e),this.withCredentials=!1},SPLODER.AtlasLoader.prototype=Object.create(THREE.Loader.prototype),SPLODER.AtlasLoader.prototype.constructor=SPLODER.AtlasLoader,SPLODER.AtlasLoader.prototype.load=function(e,t,i,s,o,n){var a=new XMLHttpRequest,r=0;a.onreadystatechange=function(){if(a.readyState===a.DONE)if(200===a.status||0===a.status){if(a.responseText){var h=JSON.parse(a.responseText),E=h.metadata;i&&i(h,E,n)}else THREE.error("SPLODER.AtlasLoader: "+t+" seems to be unreachable or the file is empty."),o&&o(a.status,n);e.onLoadComplete()}else THREE.error("SPLODER.AtlasLoader: Couldn't load "+t+" ("+a.status+")"),o&&o(a.status);else a.readyState===a.LOADING?s&&(0===r&&(r=a.getResponseHeader("Content-Length")),s({total:r,loaded:a.responseText.length,data:n})):a.readyState===a.HEADERS_RECEIVED&&void 0!==s&&(r=a.getResponseHeader("Content-Length"))},a.open("GET",t,!0),a.withCredentials=this.withCredentials,a.send(null)},SPLODER.Geom={},SPLODER.Geom.pointWithinRect=function(e,t,i,s){return s=s||1,e>=i.x*s&&t>=i.y*s&&e<=(i.x+i.width)*s&&t<=(i.y+i.height)*s},SPLODER.Geom.distanceBetweenXY=function(e,t){var i=e.x-t.x,s=e.y-t.y;return Math.sqrt(i*i+s*s)},SPLODER.Geom.distanceBetweenXZ=function(e,t){return Math.sqrt(SPLODER.Geom.distanceBetweenSquaredXZ(e,t))},SPLODER.Geom.distanceBetween=function(e,t,i,s){return Math.sqrt(SPLODER.Geom.distanceBetweenSquared(e,t,i,s))},SPLODER.Geom.distanceBetweenSquared=function(e,t,i,s){var o=i-e,n=s-t;return o*o+n*n},SPLODER.Geom.distanceBetweenSquaredXZ=function(e,t){var i=e.x-t.x,s=e.z-t.z;return i*i+s*s},SPLODER.Geom.angleBetween=function(e,t,i,s){return Math.atan2(s-t,i-e)},SPLODER.Geom.closestPtPointSegment=function(e,t,i){var s=i.clone().sub(t),o=e.clone().sub(t).dot(s);return o/=s.dot(s),t.clone().add(s.multiplyScalar(o))},SPLODER.Geom.ccw=function(e,t,i,s,o,n){return(n-t)*(i-e)>(s-t)*(o-e)},SPLODER.Geom.lineIntersectsLine=function(e,t,i,s,o,n,a,r){var h=SPLODER.Geom.ccw;return h(e,t,o,n,a,r)!=h(i,s,o,n,a,r)&&h(e,t,i,s,o,n)!=h(e,t,i,s,a,r)},SPLODER.Geom.lineLineIntersect=function(e,t,i,s,o,n,a,r){var h,E,l,d;h=i-e,E=s-t,l=a-o,d=r-n;var R,P;if(R=(-E*(e-o)+h*(t-n))/(-l*E+h*d),P=(l*(t-n)-d*(e-o))/(-l*E+h*d),R>=0&&1>=R&&P>=0&&1>=P){var c=e+P*h,O=t+P*E;return{x:c,y:O}}return!1},SPLODER.Geom.lineSide=function(e,t,i,s,o,n){return(e-i)*(n-s)-(t-s)*(o-i)>0?1:-1},SPLODER.Geom.rectIntersectsLine=function(e,t,i,s,o,n){var a=e.x,r=e.y,h=a+e.width,E=r+e.height;if(a>t&&a>s||r>i&&r>o)return!1;if(t>h&&s>h||i>E&&o>E)return!1;var l=SPLODER.Geom.lineIntersectsLine,d=SPLODER.Geom.lineSide,R=[];return l(t,i,s,o,a,r,h,r)&&(isNaN(n)||d(t,i,a,r,h,r)==n)&&R.push(SPLODER.Geom.lineLineIntersect(t,i,s,o,a,r,h,r)),l(t,i,s,o,h,r,h,E)&&(isNaN(n)||d(t,i,h,r,h,E)==n)&&R.push(SPLODER.Geom.lineLineIntersect(t,i,s,o,h,r,h,E)),l(t,i,s,o,h,E,a,E)&&(isNaN(n)||d(t,i,h,E,a,E)==n)&&R.push(SPLODER.Geom.lineLineIntersect(t,i,s,o,h,E,a,E)),l(t,i,s,o,a,E,a,r)&&(isNaN(n)||d(t,i,a,E,a,r)==n)&&R.push(SPLODER.Geom.lineLineIntersect(t,i,s,o,a,E,a,r)),R},SPLODER.Geom.gridPointsAlongLine=function(e,t,i,s){for(var o=[],n=Math.abs(i-e),a=i>e?1:-1,r=Math.abs(s-t),h=s>t?1:-1,E=(n>r?n:-r)/2,l=0;;){if(o.push(e),o.push(t),e===i&&t===s)break;var d=E;if(d>-n&&(E-=r,e+=a),r>d&&(E+=n,t+=h),l++,l>512){console.log(o);break}}return o},SPLODER.Geom.resolvePenetrationCircleRect=function(e,t,i,s){var o=e.x,n=e.y,a=o-t,r=n-t,h=o+t,E=n+t;s=s||1;var l=i.x*s,d=i.y*s,R=l+i.width*s,P=d+i.height*s,c=.5*(l+R),O=.5*(d+P);if(a>R||r>P||l>h||d>E)return!1;if(R>o&&P>n&&o>l&&n>d)return!1;var u,L;return o>=l&&R>=o?(e.y=O>=n?d-t:P+t,!0):n>=d&&P>=n?(e.x=c>=o?l-t:R+t,!0):(l>o&&d>n?(u=SPLODER.Geom.distanceBetween(o,n,l,d),L=SPLODER.Geom.angleBetween(o,n,l,d)):o>R&&d>n?(u=SPLODER.Geom.distanceBetween(o,n,R,d),L=SPLODER.Geom.angleBetween(o,n,R,d)):o>R&&n>P?(u=SPLODER.Geom.distanceBetween(o,n,R,P),L=SPLODER.Geom.angleBetween(o,n,R,P)):(u=SPLODER.Geom.distanceBetween(o,n,l,P),L=SPLODER.Geom.angleBetween(o,n,l,P)),t>u?(u-=t,e.x+=u*Math.cos(L),e.y+=u*Math.sin(L),!0):!1)},SPLODER.Geom.polygonArea=function(e){for(var t=0,i=0;i<e.length;i+=2)j=(i+2)%e.length,t+=e[i]*e[j+1],t-=e[j]*e[i+1];return t/2},SPLODER.Geom.polygonIsClockwise=function(e){return SPLODER.Geom.polygonArea(e)>0},SPLODER.Geom.polygonIsClosed=function(e){return e.length>=6&&e[0]==e[e.length-2]&&e[1]==e[e.length-1]},SPLODER.Geom.closePolygon=function(e){e.length>=4&&!SPLODER.Geom.polygonIsClosed(e)&&e.push(e[0],e[1])},SPLODER.ShapeUtils={},SPLODER.ShapeUtils.errorOccured=new signals.Signal,SPLODER.ShapeUtils._compare=function(e,t){var i=e.area(),s=t.area();return s>i?1:i>s?-1:e.type>t.type?1:e.type<t.type?-1:0},SPLODER.ShapeUtils.sortByAreaDesc=function(e){e instanceof Array&&e.sort(SPLODER.ShapeUtils._compare)},SPLODER.ShapeUtils.getBounds=function(e){if(e instanceof Array){var t=e.length,i={x:0,y:0,width:0,height:0,size:0,depth:0};if(t){for(var s,o=1e4,n=1e4,a=-1e4,r=-1e4,h=0;t--;)s=e[t],s instanceof SPLODER.Item&&(o=Math.min(o,s.x),n=Math.min(n,s.y),a=Math.max(a,s.x+s.width),r=Math.max(r,s.y+s.height),h+=s.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH));h/=e.length,i.x=o,i.y=n,i.width=a-o,i.height=r-n,i.size=Math.max(0-o,0-n,a,r),i.depth=h}return i}},SPLODER.ShapeUtils.scaleRect=function(e,t){e.x*=t,e.y*=t,e.width*=t,e.height*=t},SPLODER.ShapeUtils.getFilledGrid=function(e,t){var i,s,o,n,a,r,h=[],E=e.width+2,l=e.height+2;for(r=E*l;r--;)s=r%E,o=Math.floor(r/E),h.unshift(0==s||s==E-1||0==o||o==l-1?-1:0);for(r=t.length;r--;)for(i=t[r],o=0;o<i.height;o++)for(s=0;s<i.width;s++)n=i.x-e.x+s+1,a=i.y-e.y+o+1,h[a*E+n]=-1;var d=function(e,t,i,s,o,n){if(n||(n=[]),!(n[t*E+e]>0||0>e||0>t||e>E-1||t>l-1)){n[t*E+e]=1;var a="g"==i?h[t*E+e]>0:h[t*E+e]==i;a&&(h[t*E+e]=s,d(e,t-1,i,s,o,n),d(e+1,t,i,s,o,n),d(e,t+1,i,s,o,n),d(e-1,t,i,s,o,n),o&&(d(e-1,t-1,i,s,o,n),d(e+1,t-1,i,s,o,n),d(e-1,t+1,i,s,o,n),d(e+1,t+1,i,s,o,n)))}};d(0,0,-1,1,!0);for(var R,P=2,c=2;-1!=h.indexOf(0);)R=h.indexOf(0),s=R%E,o=Math.floor(R/E),d(s,o,0,c),c++,P++;for(c=-2;-1!=h.indexOf(-1);)R=h.indexOf(-1),s=R%E,o=Math.floor(R/E),d(s,o,-1,c),c--;var O=h.concat();d(0,0,"g",0),r=h.length;for(var u=!1;r--;)if(h[r]>0){if(u=!0,!(16>E||16>l))break;O[r]=-2}if(h=O,u&&(console.log("PROBABLE TRIANGULATION ERROR"),SPLODER.ShapeUtils.errorOccured.dispatch(e),E>=16&&l>=16)){var L=Math.floor(h.indexOf(-2)/E)*E,S=L+Math.floor(E/2);if(L>=0)for(L+=E,S+=E,r=L;S>r;r++)2==h[r]&&(h[r]=P)}return{grid:h,w:E}},SPLODER.ShapeUtils.getSegments=function(e,t,i,s){var o,n,a,r=[],h=0,E=0;s=s||0;var l=0,d=2*e.length;if(t&&(h=t.x-1,E=t.y-1,s=t.width+2),o=e.indexOf(i),-1!=o){n=o%s,a=Math.floor(o/s);var R=function(t,i,o,P,c){if(c=c||1,l++,!(l>=d)){if(void 0===P)return void R(t+1,i,o,1,1);if(t==n&&i==a)return void r.push(h+t,E+i);var O=function(e,t){return t*s+e};switch(P){case 0:if(e[O(t,i-1)]!=o)return r.push(h+t,E+i),void R(t+1,i,o,1);if(e[O(t-1,i-1)]!=o)return void R(t,i-1,o,0,c+1);e[O(t-1,i)]!=o&&(r.push(h+t,E+i),R(t-1,i,o,3));break;case 1:if(e[O(t,i)]!=o)return r.push(h+t,E+i),void R(t,i+1,o,2);if(e[O(t,i-1)]!=o)return void R(t+1,i,o,1,c+1);e[O(t-1,i-1)]!=o&&(r.push(h+t,E+i),R(t,i-1,o,0));break;case 2:if(e[O(t-1,i)]!=o)return r.push(h+t,E+i),void R(t-1,i,o,3);if(e[O(t,i)]!=o)return void R(t,i+1,o,2,c+1);e[O(t,i-1)]!=o&&(r.push(h+t,E+i),R(t+1,i,o,1));break;case 3:if(e[O(t-1,i-1)]!=o)return r.push(h+t,E+i),void R(t,i-1,o,0);if(e[O(t-1,i)]!=o)return void R(t-1,i,o,3,c+1);e[O(t,i)]!=o&&(r.push(h+t,E+i),R(t,i+1,o,2))}}};R(n,a,i)}return r},SPLODER.ShapeUtils.getCoordsFromSegments=function(e,t,i,s,o){if(!e)return e;e=e.concat(),o=o||0;var n,a,r,h,E,l,d=[],R=.001,P=[];for(a=e.length;a>=0;){for(n=e.length;n>=0;)n!=a&&e[n]==e[a]&&e[n+1]==e[a+1]&&P.unshift(a),n-=2;a-=2}n=P.length;for(var c;n--;)c=P[n],c>0&&c<e.length-1?(r=e[c],h=e[c+1],E=(e[c-2]+r+e[c+2])/3-r,l=(e[c-1]+h+e[c+3])/3-h,0>E?0>l?(e[c+1]-=R,e.splice(c+2,0,r-R,h)):(e[c]-=R,e.splice(c+2,0,r,h+R)):0>l?(e[c]+=R,e.splice(c+2,0,r,h-R)):(e[c+1]+=R,e.splice(c+2,0,r+R,h))):console.log("ERROR: UNHANDLED TRACE CONDITION. END POINT OF POLY IS DUPE!");var O,u=s==SPLODER.Geom.polygonIsClockwise(e);for(n=0;n<e.length;n+=2)r=e[n],h=e[n+1],O=u?d.unshift:d.push,O.call(d,r*i,h*i);if(SPLODER.Geom.closePolygon(d),0!=o){var L=1e4,S=-1e4,T=1e4,D=-1e4;for(n=0;n<d.length;n+=2)r=d[n],h=d[n+1],L=Math.min(L,r),S=Math.max(S,r),T=Math.min(T,h),D=Math.max(D,h);for(n=0;n<d.length;n+=2)r=d[n],h=d[n+1],r==L?d[n]-=o:r==S&&(d[n]+=o),h==T?d[n+1]-=o:h==D&&(d[n+1]+=o)}return d},SPLODER.ShapeUtils.buildTree=function(e){var t,i,s,o,n;SPLODER.ShapeUtils.sortByAreaDesc(e);var a=[[],[],[]];for(t=e.length;t--;)o=e[t],o.removeAllChildren(),o.parentNode=null,o.type<3&&(a[o.type].unshift(o),2==o.type&&1==o.getAttrib(SPLODER.Item.PROPERTY_LIQUID_HASFLOOR)&&a[0].unshift(o));for(s=0;3>s;s++)for(e=a[s],i=e.length;i--;)if(o=e[i],i>0)for(t=i;t--;)if(n=e[t],n.baseX<=o.baseX&&n.baseY<=o.baseY&&n.baseX+n.width>=o.baseX+o.width&&n.baseY+n.height>=o.baseY+o.height){n.addChild(o);break}},SPLODER.ShapeUtils.getDescendants=function(e){var t=function(e){for(var i=[],s=e.children,o=0;o<s.length;o++)i=i.concat(t(s[o]));return i=i.concat(s)},i=t(e);return SPLODER.ShapeUtils.sortByAreaDesc(i),i},SPLODER.ShapeUtils.getShapes=function(e,t,i,s){var o,n,a,r,h,E;s=s||e,SPLODER.ShapeUtils.buildTree(s);var l=[[],[],[]];o=e.length;for(var d=function(e){if(!e)return!1;if(e.getAttrib(SPLODER.Item.PROPERTY_CEIL))return!0;if(e.children)for(var t=e.children.length;t--;)if(d(e.children[t]))return!0};o--;)r=e[o],(!t||r.getAttrib(SPLODER.Item.PROPERTY_CEIL)||d(r))&&r.type<3&&(t&&r.type!=SPLODER.Item.TYPE_WALL||l[r.type].unshift(r));var R=[];for(perimSegments=[],holeSegments=[],a=0;3>a;a++){e=l[a],n=e.length;for(var P,c,O,u,L,S,T,D,m;n--;){if(h=e[n],S=h.x*i,T=h.y*i,E=h.children,t)for(o=E.length;o--;)if(E[o].getAttrib(SPLODER.Item.PROPERTY_CEIL)||d(E[o])){if(0==a&&E[o].type==SPLODER.Item.TYPE_LIQUID){var p=E[o];E.splice(o,1);for(var f=0;f<p.children.length;f++)d(p.children[f])&&(E=E.concat(p.children[f]))}}else E.splice(o,1);var g=new THREE.Path,I=0;if(c=null,E){for(P=SPLODER.ShapeUtils.getFilledGrid(h,E),c=P.grid,O=c.w,u=2;-1!=c.indexOf(u);){if(L=SPLODER.ShapeUtils.getSegments(c,h,u,O),L.length&&(D=SPLODER.ShapeUtils.getCoordsFromSegments(L,!0,i),D.length))for(perimSegments.push(D),g.moveTo(D[0]-S,D[1]-T),o=2;o<D.length;o+=2)g.lineTo(D[o]-S,D[o+1]-T),I++;u++}for(u=-2;-1!=c.indexOf(u);){if(L=SPLODER.ShapeUtils.getSegments(c,h,u,O),L.length&&(D=SPLODER.ShapeUtils.getCoordsFromSegments(L,!1,i,!0,-.001),D.length))for(holeSegments.push(D),g.moveTo(D[0]-S,D[1]-T),o=2;o<D.length;o+=2)g.lineTo(D[o]-S,D[o+1]-T),I++;u--}}else for(D=[0,0,h.width*i,0,h.width*i,h.height*i,0,h.height*i,0,0],g.moveTo(D[0],D[1]),o=2;o<D.length;o+=2)g.lineTo(D[o],D[o+1]);m=g.toShapes(!0,!1),m.userData={parentNode:h,grid:c},R.push(m)}}return R},SPLODER.ShapeUtils.getPaddedGrid=function(e,t,i,s){for(var o,n,a=[],r=2*s,h=0;i+r>h;h++)for(var E=0;t+r>E;E++)o=h*(i+r)+E,n=(h-s)*i+(E-s),a[o]=s>E||s>h||E>=t+s||h>=i+s?0:e[n];return a},SPLODER.ShapeUtils.getGeometryFromTexture=function(e,t,i,s){var o,n,a,r=t[1],h=t[0],E=t[2],l=t[3];i=i||1,s=s||i;var d=document.createElement("canvas");d.width=E+2,d.height=l+2;var R=d.getContext("2d");R.drawImage(e,h,r,E,l,1,1,d.width-2,d.height-2),E+=2,l+=2;var P=[],c=R.getImageData(0,0,E,l),O=c.data,u=0,L=0,S=1e4,T=1e4;for(n=0;l>n;n++)for(o=0;E>o;o++)a=n*E+o,O[4*a+3]>.5?(P[a]=1,u=Math.min(o,u),S=Math.max(o,S),L=Math.min(n,L),T=Math.max(n,T)):P[a]=0;var D=.5*E*i,m=.5*l*i,p=SPLODER.ShapeUtils.getSegments(P,null,1,E);if(p.length){var f=SPLODER.ShapeUtils.getCoordsFromSegments(p,!0,i,!0,.01);if(f.length){var g=new THREE.Path;g.moveTo(f[0]-D,0-f[1]+m);for(var I=2;I<f.length;I+=2)g.lineTo(f[I]-D,0-f[I+1]+m)}}var y=g.toShapes(!0,!0),_={bevelEnabled:!1,amount:s};try{var w=new THREE.ExtrudeGeometry(y,_);return SPLODER.MeshUtils.applyVoxelMapping(w,E-2,l-2,i,u,L,S-u,T-L),w}catch(v){console.log(v.stack)}},SPLODER.MeshUtils={},SPLODER.MeshUtils.getPlaneGeometry=function(e,t,i,s,o,n,a,r){n=n||1,a=a||1;var h=new THREE.PlaneGeometry(e,t,n,a,r);return i=i||0,s=s||0,o=o||0,h.applyMatrix((new THREE.Matrix4).makeTranslation(i,s,o)),h},SPLODER.MeshUtils.getBoxGeometry=function(e,t,i,s,o,n,a,r,h,E,l){a=a||1,r=r||1,h=h||1;var d=new THREE.BoxGeometry(e,t,i,a,r,h,E,l);return s=s||0,o=o||0,n=n||0,d.applyMatrix((new THREE.Matrix4).makeTranslation(s,o,n)),d},SPLODER.MeshUtils.transformUVs=function(e,t,i,s,o,n,a,r,h,E,l,d,R,P,c,O,u,L,S,T){t=t||0,i=i||0;var D,m,p,f,g,I,y,_,w,v,A,M=e.faceVertexUvs;for(g=M.length;g--;)for(_=M[g],I=_.length;I--;)for(w=_[I],v=e.faces[I],D=s,m=o,p=n,f=a,v.normal.y>0||v.normal.y<0&&T?(D=O,m=u,p=L,f=S):v.normal.y<0?(D=s,m=o+a-1,p=n,f=1):v.normal.x<0?(D=d,m=R,p=P,f=c):v.normal.x>0?(D=d+P,m=R,p=0-P,f=c):v.normal.z<0&&(D=r,m=h,p=E,f=l),D+=.01,m+=.01,p>0?p-=.02:(p+=.02,D-=.02),f-=.02,y=w.length;y--;){A=w[y];var N=A.x,x=1-A.y;A.x=t+D+p*N,A.y=i+m+f*x,A.x/=16,A.y/=16,A.y=1-A.y}e.uvsNeedUpdate=!0},SPLODER.MeshUtils.applyVoxelMapping=function(e,t,i,s){e.computeBoundingBox();var o,n,a,r,h,E,l,d,R,P=e.faceVertexUvs;o=P.length;for(var c=["a","b","c"];o--;)for(r=P[o],n=r.length;n--;)for(h=r[n],E=e.faces[n],R=E.normal,a=h.length;a--;){l=e.vertices[E[c[a]]],d=h[a];var O=l.x+t*s*.5,u=l.y+i*s*.5;O/=t*s,u/=i*s,R.x<0?O+=.001:R.x>0&&(O-=.001),R.y<0?u+=.001:R.y>0&&(u-=.001),d.x=O,d.y=u}e.uvsNeedUpdate=!0},SPLODER.MeshUtils.offsetUVsRecursive=function(e,t,i){var s,o,n,a,r,h;if(i instanceof THREE.Mesh){var E=i.geometry.faceVertexUvs;for(n=E.length;n--;)for(a=E[n],o=a.length;o--;)for(r=a[o],s=r.length;s--;)h=r[s],h.x*=16,h.y=1-h.y,h.y*=16,h.x+=e,h.y+=t,h.x/=16,h.y/=16,h.y=1-h.y;i.geometry.uvsNeedUpdate=!0}if(i.children)for(s=i.children.length;s--;)SPLODER.MeshUtils.offsetUVsRecursive(e,t,i.children[s])},SPLODER.MeshUtils.destroyMesh=function(e,t){if(e instanceof THREE.Group||e instanceof THREE.Mesh){if(e.children)for(var i,s=e.children.length;s--;)i=e.children[s],e.remove(i),SPLODER.MeshUtils.destroyMesh(i,t);if(e.userData&&e.userData.biped&&e.userData.biped.destroy(),e instanceof THREE.Mesh){e.geometry.dispose(),e.geometry=null;var o=e.material;t||(o.defines=o.uniforms=o.defaultAttributeValues=o.vertexShader=o.fragmentShader=null,e.material.dispose()),e.material=null}}},SPLODER.SceneAssets=function(){var e=null,t=16,i=1,s=null,o=null,n={},a=[],r=[],h=[],E=[],l=[],d=0,R=0,P=0,c=0,O=!0,u=this;this.prepared=null,this.forcedUpdateOnly=!0;var L=function(){var t,o,d,R,P=n;for(P.time={type:"f",value:0},P.lightMap={type:"t",value:s.texture},P.lightMapSize={type:"v4",value:s.size},P.cameraAngle={type:"v3",value:new THREE.Vector3},P.pixelRatio={type:"f",value:i},P.lights={type:"fv",value:[]},t=0;96>t;t++)P.lights.value.push(0);for(R=e.types,t=0;t<R.length;t++)if("shader"==e.materials[t]){a[t]=document.getElementById("vertexShader_"+R[t]).innerHTML,r[t]=document.getElementById("fragmentShader_"+R[t]).innerHTML,h[t]=THREE.UniformsUtils.merge([THREE.UniformsLib.fog]),E[t]&&(d=E[t],h[t].textureMap={type:"t",value:d},h[t].textureMapSize={type:"v2",value:new THREE.Vector2(d.image.width,d.image.height)});var c,O=e.types[t],u=e.uniformsKeys[O];for(o=0;o<u.length;o++)if(c=u[o],-1!=e.globalUniformsKeys.indexOf(c))h[t][c]=P[c];else switch(c){case"textureSet":h[t].textureSet={type:"fv1",value:[1,1,1]};break;case"frames":h[t].frames={type:"fv1",value:[0,0,16,16,0,0,16,16,0,0,16,16]};break;case"selected":case"ceiling":case"nofollow":case"noOverlap":case"spherical":h[t][c]={type:"1i",value:0}}l[t]=new THREE.ShaderMaterial({uniforms:h[t],vertexShader:a[t],fragmentShader:r[t],fog:!0,side:e.side[t],vertexColors:e.colors[t],transparent:e.transparent[t]})}else"basic"==e.materials[t]&&(l[t]=new THREE.MeshBasicMaterial({blending:THREE.AdditiveBlending,side:THREE.DoubleSide,color:255,transparent:e.transparent[t],depthWrite:e.depth[t],depthTest:e.depth[t]}))},S=function(){R++,R==d&&(L(),u.prepared.dispatch(!0))},T=function(){for(var i,o,n=e.maps,a=0;a<n.length;a++)i=n[a],i&&(d++,o=E[a]=THREE.ImageUtils.loadTexture(i.src,null,SPLODER.bind(u,S)),o.wrapS=i.wrapS,o.wrapT=i.wrapT,o.magFilter=i.magFilter,o.minFilter=i.minFilter,i.repeat&&o.repeat.set(1/t,1/t));s=(new SPLODER.ShaderLightMap).init()},D=function(e,t,i){o[i]=e.frames,c++,c==P&&T()},m=function(){for(var t,i,s=e.atlases,o=0;o<s.length;o++)t=s[o],t&&(P++,i=new SPLODER.AtlasLoader,i.load(i,s[o],SPLODER.bind(this,D),null,null,o))};this.init=function(e,s){return t=e,i=s,o=[],this.prepared=new signals.Signal,this},this.load=function(){var t=document.getElementById("assets_manifest").innerHTML;e=JSON.parse(t),m()},this.setLightMapDirty=function(){O=!0},this.updateLightMap=function(e,t,i){if((!this.forcedUpdateOnly||i)&&O){s.update(e,t);for(var o=0;o<l.length;o++)l[o].needsUpdate=!0;O=!1}},this.assignUniformValue=function(e,t){n[e]&&(n[e].value=t)},this.getNewMaterial=function(t){var i=l[t],s=i.clone();return i instanceof THREE.ShaderMaterial&&SPLODER.shallowCopyUniforms(h[t],s.uniforms,e.globalUniformsKeys),s},this.setAltTexture=function(e,t){h[t]&&(e.uniforms.textureMap=h[t].textureMap,e.uniforms.textureMapSize=h[t].textureMapSize)},this.getSpritesheetTexture=function(e){return E[e]},this.getTextureFrames=function(e,t){return o[e]?o[e][Math.min(t,o[e].length-1)]:void 0},this.getTextureSet=function(e,t){switch(void 0===t&&(t=e.type),t){case SPLODER.Item.TYPE_WALL:case SPLODER.Item.TYPE_PLATFORM:var i=e.getAttribs(SPLODER.Item.PROPERTY_FLOORTEXTURE,SPLODER.Item.PROPERTY_BOTTOMWALLTEXTURE,SPLODER.Item.PROPERTY_BOTTOMWALLCORNICETEXTURE),s=e.getAttribs(SPLODER.Item.PROPERTY_CEILTEXTURE,SPLODER.Item.PROPERTY_TOPWALLTEXTURE,SPLODER.Item.PROPERTY_TOPWALLCORNICETEXTURE);return-1==i[2]&&(i[2]=i[1]),-1==s[0]&&(s[0]=i[0]),-1==s[1]&&(s[1]=i[1]),-1==s[2]&&(s[2]=s[1]),[i,s];case SPLODER.Item.TYPE_PANEL:case SPLODER.Item.TYPE_ITEM:var o=e.getAttribs(SPLODER.Item.PROPERTY_TEXTURE1,SPLODER.Item.PROPERTY_TEXTURE2,SPLODER.Item.PROPERTY_TEXTURE3);return-1==o[1]&&(o[1]=o[0]),-1==o[2]&&(o[2]=o[0]),o;case SPLODER.Item.TYPE_BIPED:return[e.getAttribs(SPLODER.Item.PROPERTY_TEXTURE1)]}},this.getTotalTextures=function(e){return o[e]?o[e].length:0},this.setTime=function(e){n.time.value=e}},SPLODER.SceneAssets.TYPE_WALLS=0,SPLODER.SceneAssets.TYPE_LIQUIDS=1,SPLODER.SceneAssets.TYPE_PANELS=2,SPLODER.SceneAssets.TYPE_SKIES=3,SPLODER.SceneAssets.TYPE_ITEMS=4,SPLODER.SceneAssets.TYPE_BIPEDS=5,SPLODER.SceneAssets.TYPE_LIQUIDMASK=6,SPLODER.SceneAssets.itemTypeMap=[0,0,1,2,4,5],SPLODER.Treenode=function(){this.defaults=null;var e=this,t=null,i=[];this.addChild=function(e){var t=i.indexOf(e);-1==t&&(i.push(e),e.parentNode=this)},this.removeChild=function(e){var t=i.indexOf(e);-1!=t&&i.splice(t,1)},this.removeAllChildren=function(){for(var e,t=i.length;t--;)e=i[t],e.parentNode==this&&(e.parentNode=null);i=[]},Object.defineProperty(this,"numChildren",{get:function(){return i.length}}),Object.defineProperty(this,"children",{get:function(){return i.concat()}}),Object.defineProperty(this,"parentNode",{get:function(){return t},set:function(i){t&&t.removeChild(e),t=i,t&&t.addChild(this)}}),Object.defineProperty(this,"root",{get:function(){return t?t.root:e}})},SPLODER.Treenode.applyAttribs=function(e,t){if(t instanceof Array)for(var i=0;i<t.length;i++)e.setAttrib(i,t[i])},SPLODER.States=function(){var e;this.init=function(){return e=[[]],this},this.initWithValues=function(e){if(this.init(),e instanceof Array)for(var t=e.length;t--;)this.setValue(t,e[t],0)},this.clearState=function(t){e[t]=[]},this.hasState=function(t){return isNaN(t)&&(t=0),e[t]instanceof Array&&e[t].length},this.hasFrame=function(t,i){return t>=0&&i>=0&&e[i]instanceof Array&&void 0!=e[i][t]?!0:!1},this.hasFrames=function(t){if(t>=0)for(var i=1;i<e.length;i++)if(e[i]instanceof Array&&void 0!=e[i][t])return!0;return!1},this.offsetFrames=function(t,i){if(t>=0)for(var s=1;s<e.length;s++)e[s]instanceof Array&&!isNaN(e[s][t])&&(e[s][t]+=i)},this.hasValue=function(t,i){return isNaN(i)&&(i=0),e[i]instanceof Array?void 0!=e[i][t]&&null!=e[i][t]:!1},this.getValue=function(t,i){return isNaN(i)&&(i=0),e[i]instanceof Array?e[i][t]:null},this.setValue=function(t,i,s){isNaN(s)&&(s=0),e[s]||(e[s]=[]),e[s][t]=i},this.serialize=function(){return JSON.stringify(e)},this.unserialize=function(t){var i,s;try{i=JSON.parse(t),i instanceof Array?e=i:this.init()}catch(o){if(console.log("JSON ERROR:",o),console.log(t),"string"==typeof t&&(t=t.split(",")),t instanceof Array)for(var n=0;n<t.length;n++)s=t[n],s&&("number"==typeof s?this.setValue(n,s):-1!=s.indexOf(".")?this.setValue(n,parseFloat(s)):isNaN(s)?this.setValue(n,s):this.setValue(n,parseInt(s)))}}},SPLODER.Rect=function(e,t,i,s,o){this.id=null,this.type=e||0,this.x=t||0,this.y=i||0,this.width=s||0,this.height=o||0;var n=this;Object.defineProperty(this,"area",{value:function(){return n.type>=4?0:n.width*n.height},writable:!1}),this.clone=function(){var e=new SPLODER.Rect(this.type,this.x,this.y,this.width,this.height);return e.id=this.id,e}},SPLODER.Rect.prototype.serialize=function(){return[this.id,this.type,this.x,this.y,this.width,this.height].join(",")},SPLODER.Rect.prototype.unserialize=function(e,t,i){if(e){var s=["id","type","x","y","width","height"];i&&(s=s.concat(i));for(var o=e.split(","),n=0;n<o.length;n++)s[n]&&(0==n&&t||(this[s[n]]=parseInt(o[n])))}},SPLODER.Item=function(e,t,i,s,o,n){SPLODER.Treenode.call(this),SPLODER.Rect.call(this,e,t,i,s,o);var a=t||0,r=i||0;this.defaults=SPLODER.Item.defaultsByType[this.type],this.states=new SPLODER.States;var h=0,E=this;Object.defineProperty(this,"x",{get:function(){var e=E.type;return e!=SPLODER.Item.TYPE_PLATFORM&&e!=SPLODER.Item.TYPE_ITEM&&e!=SPLODER.Item.TYPE_BIPED?a:a+E.getAttrib(SPLODER.Item.PROPERTY_OFFSET_X)},set:function(e){if(!isNaN(e)){var t=E.type;t!=SPLODER.Item.TYPE_PLATFORM&&t!=SPLODER.Item.TYPE_ITEM&&t!=SPLODER.Item.TYPE_BIPED||0==E.currentState?a=e:E.setAttrib(SPLODER.Item.PROPERTY_OFFSET_X,e-a)}}}),Object.defineProperty(this,"y",{get:function(){var e=E.type;return e!=SPLODER.Item.TYPE_PLATFORM&&e!=SPLODER.Item.TYPE_ITEM&&e!=SPLODER.Item.TYPE_BIPED?r:r+E.getAttrib(SPLODER.Item.PROPERTY_OFFSET_Y)
},set:function(e){if(!isNaN(e)){var t=E.type;t!=SPLODER.Item.TYPE_PLATFORM&&t!=SPLODER.Item.TYPE_ITEM&&t!=SPLODER.Item.TYPE_BIPED||0==E.currentState?r=e:E.setAttrib(SPLODER.Item.PROPERTY_OFFSET_Y,e-r)}}}),Object.defineProperty(this,"baseX",{get:function(){return a}}),Object.defineProperty(this,"baseY",{get:function(){return r}}),Object.defineProperty(this,"currentState",{get:function(){return E.type!=SPLODER.Item.TYPE_PLATFORM||E.root==E?h:E.root?E.root.currentState:0},set:function(e){isNaN(e)||(E.type!=SPLODER.Item.TYPE_PLATFORM||E.root==E?h=e:E.root?E.root.currentState=e:h=0)}}),this.getAttrib=function(e,t){return isNaN(t)&&(t=this.currentState),this.type!=SPLODER.Item.TYPE_PLATFORM||this.root==this||e!=SPLODER.Item.PROPERTY_OFFSET_X&&e!=SPLODER.Item.PROPERTY_OFFSET_Y?this.states.hasValue(e,t)?this.states.getValue(e,t):this.states.hasValue(e,0)?this.states.getValue(e,0):this.parentNode?this.parentNode.getAttrib(e):this.defaults&&this.defaults.hasOwnProperty(e)?this.defaults[e]:-1:this.root.getAttrib(e)},this.hasOwnAttrib=function(e,t){return isNaN(t)&&(t=this.currentState),this.states.hasValue(e,t)||this.states.hasValue(e,0)},this.setAttrib=function(e,t,i){isNaN(i)&&(i=this.currentState),(null===t||t!==t)&&(t=void 0),this.states.setValue(e,t,i)},this.clearAttrib=function(e,t){isNaN(t)&&(t=this.currentState),this.states.setValue(e,void 0,t)},this.getAttribs=function(){if(arguments&&arguments.length>0){for(var e=[],t=0;t<arguments.length;t++)e.push(E.getAttrib(arguments[t]));return e}},n?this.states.initWithValues(n):this.states.init(),this.clone=function(){var e=new SPLODER.Item(this.type,this.baseX,this.baseY,this.width,this.height);return e.id=this.id,e.states.unserialize(this.states.serialize()),e},this.serialize=function(){return[this.id,this.type,this.baseX,this.baseY,this.width,this.height].join(",")+","+this.states.serialize()},this.unserialize=function(e,t){if(e){SPLODER.Rect.prototype.unserialize.call(this,e,t);var i=e.split(","),s=i.slice(6).join(",");this.states.unserialize(s),this.defaults=SPLODER.Item.defaultsByType[this.type]}}},SPLODER.Item.prototype=Object.create(SPLODER.Rect.prototype),SPLODER.Item.prototype.constructor=SPLODER.Item,SPLODER.Item.PROPERTY_TYPE=0,SPLODER.Item.TYPE_WALL=0,SPLODER.Item.TYPE_PLATFORM=1,SPLODER.Item.TYPE_LIQUID=2,SPLODER.Item.TYPE_PANEL=3,SPLODER.Item.TYPE_ITEM=4,SPLODER.Item.TYPE_BIPED=5,SPLODER.Item.TYPE_LIGHT=6,SPLODER.Item.TYPE_FILTER_WALL_LIQUID=7,SPLODER.Item.typeStrings=["wall","platform","liquid","panel","item","biped","light"],SPLODER.Item.PROPERTY_ROTATION=0,SPLODER.Item.PROPERTY_FLOORDEPTH=1,SPLODER.Item.PROPERTY_CEILDEPTH=2,SPLODER.Item.PROPERTY_OFFSET_X=3,SPLODER.Item.PROPERTY_OFFSET_Y=4,SPLODER.Item.PROPERTY_TEXTURE1=5,SPLODER.Item.PROPERTY_TEXTURE2=6,SPLODER.Item.PROPERTY_TEXTURE3=7,SPLODER.Item.PROPERTY_FLOORTEXTURE=5,SPLODER.Item.PROPERTY_BOTTOMWALLTEXTURE=6,SPLODER.Item.PROPERTY_BOTTOMWALLCORNICETEXTURE=7,SPLODER.Item.PROPERTY_CEILTEXTURE=8,SPLODER.Item.PROPERTY_TOPWALLTEXTURE=9,SPLODER.Item.PROPERTY_TOPWALLCORNICETEXTURE=10,SPLODER.Item.PROPERTY_LIGHTLEVEL=11,SPLODER.Item.PROPERTY_LIGHTEFFECT=12,SPLODER.Item.PROPERTY_LIQUIDLEVEL=13,SPLODER.Item.PROPERTY_LIQUIDTYPE=14,SPLODER.Item.PROPERTY_LIQUID_HASFLOOR=17,SPLODER.Item.PROPERTY_POWER=11,SPLODER.Item.PROPERTY_COLOR=12,SPLODER.Item.PROPERTY_CEIL=15,SPLODER.Item.PROPERTY_CEIL_SKY=16,SPLODER.Item.PROPERTY_HEALTH=18,SPLODER.Item.PROPERTY_STRENGTH=19,SPLODER.Item.PROPERTY_RANGE=20,SPLODER.Item.PROPERTY_ARMOR=21,SPLODER.Item.PROPERTY_SPEED=22,SPLODER.Item.PROPERTY_SCORE=23,SPLODER.Item.PROPERTY_SOLID=24,SPLODER.Item.PROPERTY_GRAVITY=25,SPLODER.Item.PROPERTY_AUTOCREATE=26,SPLODER.Item.PROPERTY_LIBRARY=27,SPLODER.Item.PROPERTY_TOPLEFT=30,SPLODER.Item.PROPERTY_TOPRIGHT=31,SPLODER.Item.PROPERTY_BOTTOMRIGHT=32,SPLODER.Item.PROPERTY_BOTTOMLEFT=33,SPLODER.Item.defaults=[],SPLODER.Item.defaultsByType=[],function(e){e.defaults[e.PROPERTY_ROTATION]=0,e.defaults[e.PROPERTY_FLOORDEPTH]=64,e.defaults[e.PROPERTY_CEILDEPTH]=80,e.defaults[e.PROPERTY_OFFSET_X]=0,e.defaults[e.PROPERTY_OFFSET_Y]=0,e.defaults[e.PROPERTY_LIGHTLEVEL]=160,e.defaults[e.PROPERTY_LIGHTEFFECT]=0,e.defaults[e.PROPERTY_FLOORTEXTURE]=7,e.defaults[e.PROPERTY_BOTTOMWALLTEXTURE]=7,e.defaults[e.PROPERTY_BOTTOMWALLCORNICETEXTURE]=-1,e.defaults[e.PROPERTY_CEILTEXTURE]=-1,e.defaults[e.PROPERTY_TOPWALLTEXTURE]=-1,e.defaults[e.PROPERTY_TOPWALLCORNICETEXTURE]=-1,e.defaults[e.PROPERTY_CEIL]=1,e.defaults[e.PROPERTY_CEIL_SKY]=0,e.defaults[e.PROPERTY_LIQUIDLEVEL]=62,e.defaults[e.PROPERTY_LIQUIDTYPE]=0,e.defaults[e.PROPERTY_LIQUID_HASFLOOR]=1,e.defaults[SPLODER.Item.PROPERTY_HEALTH]=100,e.defaults[SPLODER.Item.PROPERTY_STRENGTH]=20,e.defaults[SPLODER.Item.PROPERTY_RANGE]=20,e.defaults[SPLODER.Item.PROPERTY_ARMOR]=0,e.defaults[SPLODER.Item.PROPERTY_SPEED]=10,e.defaults[SPLODER.Item.PROPERTY_SCORE]=10,e.defaults[SPLODER.Item.PROPERTY_SOLID]=1,e.defaults[SPLODER.Item.PROPERTY_GRAVITY]=1,e.defaults[SPLODER.Item.PROPERTY_AUTOCREATE]=1,e.defaults[SPLODER.Item.PROPERTY_LIBRARY]=0;for(var t=e.TYPE_WALL;t<=e.TYPE_LIGHT;t++)e.defaultsByType[t]=e.defaults.concat();e.defaultsByType[e.TYPE_PLATFORM][e.PROPERTY_FLOORDEPTH]=66,e.defaultsByType[e.TYPE_PLATFORM][e.PROPERTY_CEILDEPTH]=2,e.defaultsByType[e.TYPE_LIQUID][e.PROPERTY_FLOORDEPTH]=56,e.defaultsByType[e.TYPE_LIQUID][e.PROPERTY_CEIL]=0,e.defaultsByType[e.TYPE_LIQUID][e.PROPERTY_FLOORTEXTURE]=1,e.defaultsByType[e.TYPE_PANEL][e.PROPERTY_TEXTURE1]=70,e.defaultsByType[e.TYPE_PANEL][e.PROPERTY_TEXTURE2]=-1,e.defaultsByType[e.TYPE_PANEL][e.PROPERTY_TEXTURE3]=-1,e.defaultsByType[e.TYPE_ITEM][e.PROPERTY_TEXTURE1]=34,e.defaultsByType[e.TYPE_ITEM][e.PROPERTY_TEXTURE2]=-1,e.defaultsByType[e.TYPE_ITEM][e.PROPERTY_TEXTURE3]=-1,e.defaultsByType[e.TYPE_LIGHT][e.PROPERTY_COLOR]=0,e.defaultsByType[e.TYPE_LIGHT][e.PROPERTY_POWER]=20}(SPLODER.Item),SPLODER.BipedPoses=function(){var e,t,i,s,o,n,a,r,h,E,l,d,R,P,c,O,u,L,S,T,D,m,p={},f={},g=this;this.initWithElements=function(p,f,y,_,w,v,A,M,N,x,Y,C,b,U){e=p,t=f,i=y,s=_,o=w,n=o.children[0],a=v,r=A,h=M,E=r.children[0],l=h.children[0],d=N,R=x,P=d.children[0],c=R.children[0],O=Y,u=C,L=b,S=U,I(),T="",D=0;var V=p.currentState;return m=setInterval(function(){if(V!=p.currentState){var e=["idle","walk","attack","defend","ouch","die","push","dance","shrug","facepalm","sit","watch"];V=p.currentState,V<e.length&&g.pose(e[V])}g.update()},10),this};var I=function(e){e||(e=t),p[e.uuid]=e.rotation.clone(),f[e.uuid]=e.position.clone(),e.children.forEach(I)},y=function(e){e||(e=t),e.rotation.copy(p[e.uuid]),e.position.copy(f[e.uuid]),e.children.forEach(y)};this.pose=function(e){e!=T&&(T=e,D=Date.now())},this.update=function(m){y();var f,I,_,w,v,A,M,N,x,Y=Date.now()-D,C=e.getAttrib(SPLODER.Biped.PROPERTY_BEASTLY)/255,b=e.getAttrib(SPLODER.Biped.PROPERTY_GENDER)/128,U=2-b,V=e.getAttrib(SPLODER.Biped.PROPERTY_HEIGHT)/800+.3,F=e.getAttrib(SPLODER.Biped.PROPERTY_WEIGHT)/400+.5;switch(T){case"run":f=Y/50,I=Math.sin(f),_=Math.cos(f);case"walk":f||(f=Y/150,I=Math.sin(f),_=Math.cos(f)),i.rotation.x+=-.2,i.rotation.z+=.05*I*b,s.rotation.x+=.1+.1*I,s.rotation.z+=0-.05*I*b,h.position.y-=Math.min(0,8*_),r.position.y+=Math.max(0,8*_),h.rotation.x+=.2+.35*I*F,r.rotation.x+=.2-.35*I*F,l.rotation.x+=.5-h.rotation.x-p[l.uuid].x,E.rotation.x+=.5-r.rotation.x-p[E.uuid].x,O.rotation.x+=-.2-.1*I,u.rotation.x+=-.2-.1*I,A=1,M=1,L&&(A*=.5),S&&(M*=.25),d.rotation.x+=-.2+.35*I*M,d.rotation.z+=Math.abs(.15*_)*b,R.rotation.x+=-.2-.35*I*A,R.rotation.z+=0-Math.abs(.15*_)*b,P.rotation.x+=-.75+h.rotation.x*M,c.rotation.x+=-.75+r.rotation.x*A,L&&(c.rotation.y-=.35),S&&(P.rotation.z-=.75,P.rotation.y+=.35-.3*I),n.rotation.y+=0-.25*Math.sin(.25*f),n.rotation.x-=.1+.1*I,n.rotation.z+=.05*I*b*2,a.emote(":)");break;case"idle":f=Y/500,I=Math.sin(f),_=Math.cos(f),i.rotation.z+=.03*I*b,s.rotation.z+=0-.03*I*b,n.rotation.z-=0-.03*I*b,r.rotation.z-=.03*I*b,h.rotation.z-=.03*I*b,d.rotation.z+=.03*I*b,R.rotation.z+=.03*I*b,P.rotation.x-=.2,c.rotation.x-=.2,i.rotation.x+=.03*I*U-I*C*.05,s.rotation.x+=0-.03*I*U+I*C*.1,n.rotation.x-=0-.03*I*U+I*C*.1,r.rotation.x-=(-.03+.03*I)*U+I*C*.05,h.rotation.x-=(-.03+.03*I)*U+I*C*.05,r.rotation.z+=I*C*.05,h.rotation.z-=I*C*.05,E.rotation.x-=.03*I*U-I*C*.2,l.rotation.x-=.03*I*U-I*C*.2,t.position.y-=I*C*2,d.rotation.x+=.03*I*U,R.rotation.x+=.03*I*U,P.rotation.x-=.2*U,c.rotation.x-=.2*U,S&&(d.rotation.x-=.5+.2*I,P.rotation.z-=.95,P.rotation.y=.25+.05*I),a.emote(":|");break;case"attack":v=1,Y>400&&(v-=.01*(Y-400)),f=(Y+250)/150,f-=Math.sin(f),I=Math.sin(f),_=Math.cos(f),s.rotation.y-=.8*I*v,s.rotation.z+=.2*I*v,t.rotation.y+=.2*(-1.57+_)*v,o.rotation.y-=.2*(-1.57+_)*v,L?(R.rotation.z+=1.25*_*v,R.rotation.x-=(1.57-1.57*_)*v,c.rotation.x+=.65*_*v):(R.rotation.z+=.5*_,R.rotation.y-=I,R.rotation.x+=1*I,c.rotation.x-=.95+1*I),S?(d.rotation.x-=.5+.2*I,d.rotation.y+=.8*I*v,P.rotation.z-=.95,P.rotation.x-=.25,P.rotation.y+=.35):d.rotation.x-=1*I,a.emote(">:("),Y>500&&g.pose("idle");break;case"defend":v=1,Y>900&&(v-=.01*(Y-900)),N=2-C,f=Math.min(250,Y)/150,I=Math.sin(f),_=Math.cos(f),s.rotation.y-=.4*I*v*N,s.rotation.x-=.2*I*v*N,o.rotation.x-=.75*I*v,n.rotation.x+=.75*I*v,n.position.z-=8*I*v,n.position.y-=8*I*v,R.position.z+=8*I*v*N,R.rotation.x-=.75*I*v*N,R.rotation.y+=.75*I*v*N,R.rotation.z+=.5*I*v*N,c.rotation.x-=.75*I*v,c.rotation.y-=.5*I*v,d.rotation.x-=1*I*v*N,d.rotation.y-=1.5*I*v*N,P.rotation.x-=.75*I*v,P.rotation.y+=2.5*I*v,h.rotation.x+=.25*I*v,l.rotation.x-=.25*I*v,r.rotation.x-=.15*I*v,E.rotation.x+=.15*I*v,L&&(R.rotation.y+=C),S&&(d.rotation.y-=C),a.emote("=O"),Y>1e3&&g.pose("idle");break;case"watch":f=Y/100,I=Math.sin(f),_=Math.cos(f),a.emote(":/");var z=t.parent.rotation.y;z<2*Math.PI&&(z+=2*Math.PI),n.rotation.x-=0-.03*I,n.rotation.y=0-z-.5*Math.PI-SPLODER.Geom.angleBetween(editor.previewArea.camera.position.x,editor.previewArea.camera.position.z,t.parent.position.x,t.parent.position.z),n.rotation.y<0-Math.PI&&(n.rotation.y+=2*Math.PI),n.rotation.y=Math.max(-1,Math.min(1,n.rotation.y));break;case"ouch":v=1,Y>300&&(v-=.01*(Y-300)),f=Y/100,I=Math.sin(f),_=Math.cos(f),s.rotation.x-=.4*I*v,t.rotation.x-=.4*I*v*C,t.rotation.z+=.4*I*v,t.position.y+=32*I*v,o.rotation.x+=.75*I*v,n.rotation.x-=.5*I*v,n.position.z-=16*I*v,n.position.y-=8*I*v,h.rotation.z-=1*I*v,r.rotation.z+=1*I*v,A=v,M=v,R.rotation.z-=2*I*A,d.rotation.z+=2*I*M,R.position.x+=8*I*v,d.position.x-=8*I*v,a.emote("o_o"),Y>400&&(a.emote(":|"),g.pose("idle"));break;case"sit":f=1.5,I=Math.sin(f),_=Math.cos(f),N=1.5-.4*C,x=2-C,t.position.y-=56,i.rotation.x-=.3*I*N,s.rotation.x+=.1*I*x,h.rotation.x-=.8*I*N,r.rotation.x-=.8*I*N,l.rotation.x+=.5*I*N,E.rotation.x+=.5*I*N;break;case"die":if(f=SPLODER.easeInCubic(Y,0,1,1e3),I=Math.sin(Math.min(125,Y)/125),t.rotation.z=.5*I,t.rotation.y+=SPLODER.easeOutCubic(Math.min(500,Y),0,6.28318,500),t.rotation.x=SPLODER.lerp(t.rotation.x,0-.5*Math.PI,2*f),t.position.y-=SPLODER.lerp(0,160*V,2*f),i.position.z*=1-Math.min(1,f),s.position.z*=1-Math.min(1,f),h.rotation.x=SPLODER.lerp(h.rotation.x,0-.5*Math.PI,2*f),r.rotation.x=SPLODER.lerp(r.rotation.x,0-.5*Math.PI,2*f),h.rotation.z=0-.5*I,r.rotation.z=I,R.rotation.z=0-I,R.rotation.x=SPLODER.lerp(R.rotation.x,0-.5*Math.PI,2*f),d.rotation.z=I,d.rotation.x=SPLODER.lerp(d.rotation.x,0-.5*Math.PI,2*f),a.emote("(O"),Y>1e3){f=SPLODER.easeInCubic(Math.min(500,Y-1e3),0,1,500);var B=function(e,t){if(t=t||0,!(t>3)){t>0&&(e.rotation.x*=1-f,e.rotation.y*=1-f,2>=t&&(e.position.z-=6*f));for(var i=e.children.length;i--;)B(e.children[i],t+1)}};B(t)}break;case"push":f=SPLODER.easeInQuad(Y,0,1,125),I=Math.sin(Math.min(200,Y)/70),h.rotation.x=0-I,r.rotation.x=.5-1.5*I,l.rotation.x=I,E.rotation.x=I,i.rotation.x=0-.25*I,s.rotation.x=.25*I,t.position.y-=16*I,t.rotation.x+=.1*Math.min(1,f),R.rotation.x=SPLODER.lerp(R.rotation.x,0-.55*Math.PI,f),R.rotation.z=SPLODER.lerp(R.rotation.z,.125*Math.PI,f),c.rotation.x=-2+Math.min(2,f),d.rotation.x=SPLODER.lerp(d.rotation.x,0-.55*Math.PI,f),d.rotation.z=SPLODER.lerp(d.rotation.z,0-.125*Math.PI,f),P.rotation.x=-2+Math.min(2,f),a.emote(">:("),Y>750&&(a.emote(":|"),g.pose("idle"));break;case"dance":f=Y/250,I=Math.sin(f),w=Math.sin(2*f),_=Math.cos(f),i.rotation.z=.2*I,s.rotation.z=.2*_,o.rotation.z=0-.2*_,o.rotation.x=0-.2*w,n.rotation.x=.2*w-.5*C,n.position.z-=4*w,r.rotation.z=0-.2*I,h.rotation.z=0-.2*I,d.rotation.y=-.5,R.rotation.y=.5,d.position.y+=4-8*I,R.position.y+=4+8*I,P.rotation.x=-1.57,c.rotation.x=-1.57,L&&(c.rotation.y-=.5,R.rotation.y-=C),S&&(P.rotation.y+=.5,d.rotation.y+=C),a.emote("=D");break;case"shrug":f=Y/250,I=Math.sin(f),_=Math.cos(f),n.position.y-=4*I,d.rotation.y=.5*I,R.rotation.y=0-.5*I,d.position.y+=8*I,R.position.y+=8*I,P.rotation.x+=0-I,c.rotation.x+=0-I,a.emote("//-_-"),Y>750&&(a.emote(":|"),g.pose("idle"));break;case"facepalm":2e3>Y?(f=SPLODER.easeOutQuad(Math.min(Y,1e3),0,1e3,750),a.emote("//-_-")):(f=500-SPLODER.easeOutQuad(Math.min(Y,2500)-2e3,0,500,500),a.emote(":|")),f=Math.min(2,f/400),I=Math.sin(f),w=2e3>Y?Math.sin(Y/150):0,_=Math.cos(f),n.rotation.x+=.5*I,n.rotation.y+=.25*w,s.rotation.x+=.25*I,d.rotation.x=0-1.57*I,R.rotation.x=0-1.57*I,d.rotation.y=-.5+.85*_,R.rotation.y=.5-.85*_,P.rotation.x+=0-I,c.rotation.x+=0-I,L&&(c.rotation.x+=.5*I,c.rotation.y-=2*I),S&&(P.rotation.x+=.5*I,P.rotation.y+=2*I),Y>3e3&&(a.emote(":|"),g.pose("idle"))}},this.destroy=function(){clearInterval(m),m=null}},SPLODER.BipedFace=function(){var e,t,i,s,o,n,a,r,h,E,l,d,R,P,c,O,u,L,S,T,D;this.initWithRectAndMaterial=function(n,a,r,h){return e=n,t=a,i=r||0,s=h||0,o=new THREE.Group,o.userData.face=this,this};var m=function(i,s,o,n,a,r,h){var E=SPLODER.MeshUtils.getPlaneGeometry(i,s,o,n,a,r,h),l=new THREE.Mesh(E,t);return l.userData.rect=e,l};this.build=function(){var t,T=e.getAttrib(SPLODER.Biped.PROPERTY_BEASTLY)/128;n=m(12,12),t=n.geometry,SPLODER.MeshUtils.transformUVs(t,i,s,44,19,4,4),o.add(n),a=m(12,12),t=a.geometry,SPLODER.MeshUtils.transformUVs(t,i,s,32,19,4,4),o.add(a),r=m(6,6),t=r.geometry,SPLODER.MeshUtils.transformUVs(t,i,s,44,23,4,4),n.add(r),h=m(6,6),t=h.geometry,SPLODER.MeshUtils.transformUVs(t,i,s,32,23,4,4),a.add(h),E=m(14,14,0,-7),t=E.geometry,SPLODER.MeshUtils.transformUVs(t,i,s,40,29,3,2.5),n.add(E),l=m(14,14,0,-7),t=l.geometry,SPLODER.MeshUtils.transformUVs(t,i,s,40,29,3,2.5),a.add(l),d=m(14,2,0,-1,0),t=d.geometry,SPLODER.MeshUtils.transformUVs(t,i,s,43,30,5,2),d.rotation.x=100*Math.PI/180,d.position.y=-14,d.position.z=2,E.add(d),d=d.clone(),d.rotation.y=Math.PI,E.add(d),R=m(14,2,0,-1,0),t=R.geometry,SPLODER.MeshUtils.transformUVs(t,i,s,43,30,5,2),R.rotation.x=100*Math.PI/180,R.position.y=-14,R.position.z=2,l.add(R),R=R.clone(),R.rotation.y=Math.PI,l.add(R),P=m(14+SPLODER.weightedValue(0,T,2),4+SPLODER.weightedValue(0,T,2)),t=P.geometry,SPLODER.MeshUtils.transformUVs(t,i,s,44,27,4,2),n.add(P),c=m(14+SPLODER.weightedValue(0,T,2),4+SPLODER.weightedValue(0,T,2)),t=c.geometry,SPLODER.MeshUtils.transformUVs(t,i,s,40,27,4,2),a.add(c),O=new THREE.Group,O.position.y=-16,o.add(O),L=m(16,2,0,0,0,8,1),t=L.geometry,SPLODER.MeshUtils.transformUVs(t,i,s,32,27,8,1),L.position.z=.1,O.add(L),S=m(16,2,0,-1,0,8,1),t=S.geometry,SPLODER.MeshUtils.transformUVs(t,i,s,32,27.5,8,3),O.add(S),u=m(8,4,0,-2,0),t=u.geometry,SPLODER.MeshUtils.transformUVs(t,i,s,32,31,8,1),O.add(u),u.visible=!1,p();{var D=[":|",":)",";)",":]",":P","(O",":(","-_-",">:(","^-^",">:)",":'(","o_O",":/","=O",":D","XD",":)"];D[0]}};var p=function(){var t=e.getAttrib(SPLODER.Biped.PROPERTY_GENDER)/128,i=e.getAttrib(SPLODER.Biped.PROPERTY_BEASTLY)/128,s=e.getAttrib(SPLODER.Biped.PROPERTY_STRENGTH)/128;n.position.x=8+SPLODER.weightedValue(0,t,.5),n.position.y=0,n.position.y-=2*SPLODER.weightedValue(-.5,i,1),n.rotation.z=.1*SPLODER.weightedValue(-.5,i,1),n.scale.set(1,1,1),n.scale.multiplyScalar(SPLODER.weightedValue(0,t,.125)),a.position.x=-8-SPLODER.weightedValue(0,t,.5),a.position.y=0,a.position.y-=2*SPLODER.weightedValue(-.5,i,1),a.rotation.z=-.1*SPLODER.weightedValue(-.5,i,1),a.scale.set(1,1,1),a.scale.multiplyScalar(SPLODER.weightedValue(0,t,.125)),r.position.set(0,-2,.1),h.position.set(0,-2,.1),E.position.set(0,7,.2),E.scale.y=.25,l.position.set(0,7,.2),l.scale.y=.25,P.position.y=8-2*SPLODER.weightedValue(-2,i,1),P.position.z=.3,P.scale.set(1,1,1),P.rotation.z=0,c.position.y=8-2*SPLODER.weightedValue(-2,i,1),c.position.z=.3,c.scale.set(1,1,1),c.rotation.z=0,O.position.y=-16+Math.max(0,SPLODER.weightedValue(0,s,-2)),O.scale.y=1,O.scale.x=SPLODER.weightedValue(.25,i,.5),L.position.y=2,S.position.y=2;var o=function(e,t){e.y=t>8?-2:0};L.geometry.vertices.map(o,null,0),L.geometry.verticesNeedUpdate=!0,S.geometry.vertices.map(o,null,6),S.geometry.verticesNeedUpdate=!0,u.position.y=1,u.position.z=.1,u.rotation.x=.25*-Math.PI,u.visible=!1};this.emote=function(e){var t,i,s=1.5,o=!0;switch(p(),e){case":)":case"=)":t=function(e,t){e.y=Math.sin(.2*e.x-1.57)*s,t>8&&(e.y-=o?2:i+2)},c.rotation.z=.1,P.rotation.z=0-c.rotation.z;break;case"^-^":case"^_^":case"^^":P.position.y+=2,c.position.y+=2,r.position.y+=2,h.position.y+=2,E.scale.y=l.scale.y=.4,O.position.y+=2,O.scale.x=2;break;case":]":case"O:)":t=function(e,t){e.y=Math.abs(e.x)>2?2*Math.sin(.2*e.x-1.57)+1.5:0,t>8&&(e.y-=o?2:i+2)},c.rotation.z=.1,P.rotation.z=0-c.rotation.z,P.position.y-=1,c.position.y-=1,r.position.y=1,h.position.y=1,E.scale.y=l.scale.y=.4,O.scale.x=2;break;case":(":t=function(e,t){s=2,e.y=Math.sin(.2*e.x+1.57)*s,t>8&&(e.y-=o?2:i+2)},c.rotation.z=.4,P.rotation.z=0-c.rotation.z;break;case":'(":case":'-(":t=function(e,t){e.y=Math.abs(e.x)>2?0-3*Math.sin(.2*e.x-1.57)-2:0,t>8&&(e.y-=o?2:i+2)},a.rotation.z=.4,n.rotation.z=0-a.rotation.z,c.rotation.z=.3,P.rotation.z=0-c.rotation.z,n.scale.y=a.scale.y=.5,O.position.y+=2,P.scale.y=c.scale.y=1.5,E.scale.y=l.scale.y=1;break;case"<O":case"(O":t=function(e,t){s=2,o?e.y=Math.sin(.2*e.x+1.57)*s+(8>=t?2:0):(i=Math.abs(6*Math.sin(Date.now()/100)),e.y=t>8?i-4:Math.sin(.2*e.x+1.57)*s+1)},a.rotation.z=.4,n.rotation.z=0-a.rotation.z,n.scale.y=a.scale.y=.5,P.scale.y=c.scale.y=1.5,E.scale.y=l.scale.y=1;break;case">:(":case">:[":t=function(e,t){s=2,e.y=Math.sin(.2*e.x+1.57)*s,t>8&&(e.y-=o?2:i+2)},O.scale.x*=1.25,n.scale.y*=.85,a.scale.y*=.85,c.rotation.z=-.4,P.rotation.z=0-c.rotation.z;break;case">:)":t=function(e,t){e.y=Math.abs(e.x)>2?2*Math.sin(.2*e.x-1.57)+1.5:0,t>8&&(e.y-=o?2:i+2)},O.scale.x=2,O.position.y+=2,n.scale.y*=.85,a.scale.y*=.85,c.rotation.z=-.4,P.rotation.z=0-c.rotation.z;break;case"-_-":case"-__-":case"-___-":t=function(e,t){s=1,e.y=Math.cos(.4*e.x-1.57)*s,t>8&&(e.y-=o?2:i+2)},r.position.y=-1,h.position.y=-1,c.rotation.z=-.1,P.rotation.z=0-c.rotation.z,P.position.y-=1,c.position.y-=1,E.scale.y=l.scale.y=.6,O.scale.x*=.5;break;case"//-_-":t=function(e,t){s=1,e.y=Math.cos(.4*e.x-1.57)*s,t>8&&(e.y-=o?2:i+2)},c.rotation.z=-.1,P.rotation.z=0-c.rotation.z,P.position.y-=2,c.position.y-=2,E.scale.y=l.scale.y=1,O.scale.x*=1.5;break;case"o_O":case"O_o":case"o_o":t=function(e,t){e.y=-5,t>8&&(e.y-=o?2:i+2)},O.scale.x=.25,O.position.y+=4,n.scale.multiplyScalar(1.1),c.rotation.z=.1,P.rotation.z=0-c.rotation.z,P.position.y+=2,c.position.y+=2,E.scale.y=l.scale.y=.1;break;case":O":case":o":case":-O":case"=O":t=function(e,t){!o&&t>8&&(e.y=0-(.5*i+6))},O.scale.x=.75,n.scale.multiplyScalar(1.1),c.rotation.z=.1,P.rotation.z=0-c.rotation.z,P.position.y+=2,c.position.y+=2,E.scale.y=l.scale.y=.1;break;case":D":case"=D":t=function(e,t){i=Math.max(i,4),e.y=Math.sin(.2*e.x-1.57)*s,t>8&&(e.y-=o?2:i+2),u.position.y=3-i},a.rotation.z=.1,n.rotation.z=0-a.rotation.z,c.rotation.z=.1,P.rotation.z=0-c.rotation.z;break;case"XD":t=function(e,t){i=Math.max(i,4),e.y=Math.sin(.2*e.x-1.57)*s,t>8&&(e.y-=o?2:i+2)},a.rotation.z=.1,n.rotation.z=0-a.rotation.z,c.rotation.z=.3,P.rotation.z=0-c.rotation.z,n.scale.y=a.scale.y=.5,P.scale.y=c.scale.y=1.5,E.scale.y=l.scale.y=1,O.scale.x=1.5;break;case";)":t=function(e,t){i=0,e.y=Math.cos(.5*e.x+1.2)*s*.5+.2*e.x+(t>8?0-(i+2):0)},a.rotation.z=.1,n.rotation.z=0-a.rotation.z,c.rotation.z=.1,P.rotation.z=0-c.rotation.z,n.scale.y=.5,P.scale.y=1.5,E.scale.y=1;break;case":P":t=function(e,t){i=0,Math.abs(e.x)>2&&(e.y=Math.sin(.2*e.x-1.57)+1+(t>8?0-(i+2):0))},a.rotation.z=.1,n.rotation.z=0-a.rotation.z,c.rotation.z=.1,P.rotation.z=0-c.rotation.z,u.visible=!0;break;case":/":t=function(e,t){e.y=Math.cos(.4*e.x-1.57)*s,t>8&&(e.y-=o?2:i+2)},c.rotation.z=-.1,P.rotation.z=0-c.rotation.z,P.position.y+=2,c.position.y-=1,E.scale.y=l.scale.y=.4;break;default:t=function(e,t){e.y=0,t>8&&(e.y-=o?2:i+2)},c.rotation.z=.1,P.rotation.z=0-c.rotation.z}t&&(L.geometry.vertices.map(t,null,0),L.geometry.verticesNeedUpdate=!0,o=!1,S.geometry.vertices.map(t,null,6),S.geometry.verticesNeedUpdate=!0)},this.destroy=function(){clearInterval(T),clearInterval(D),T=D=null},Object.defineProperty(this,"mesh",{get:function(){return o}})},SPLODER.BipedItem=function(){var e,t,i,s;this.initWithRectAndMaterial=function(e,o,n){return t=e,i=o,s=n,this},this.build=function(){var o,n=t.getAttrib(SPLODER.Biped.PROPERTY_HEIGHT)/255+.5,a=t.getAttrib(SPLODER.Biped.PROPERTY_STRENGTH)/128,r=t.getAttrib(SPLODER.Biped.PROPERTY_GENDER)/128;o=SPLODER.ShapeUtils.getGeometryFromTexture(i.uniforms.textureMap.value.image,s,3,8),o&&(e=new THREE.Mesh(o,i),e.rotation.x=1.57,e.position.z=11*SPLODER.weightedValue(0,a,.35,r,-.25),e.position.y=0-32*SPLODER.weightedValue(0,n,.5)+4,e.userData.rect=t,i.uniforms.noOverlap.value=1,i.uniformsNeedUpdate=!0)},Object.defineProperty(this,"mesh",{get:function(){return e}})},SPLODER.Biped=function(){var e,t,i,s,o,n,a,r,h,E,l,d,R,P,c,O,u,L,S,T,D,m,p,f,g,I,y,_,w,v,A,M,N,x,Y,C,b,U,V;this.poses=null,this.initWithRectAndMaterial=function(i,s,h,E){return e=i,t=s,o=h||0,n=E||0,a=new THREE.Group,a.userData.biped=this,r=new THREE.Group,r.userData.biped=this,a.add(r),U=[],V=[s],this},this.setItemMaterials=function(e,t,o,n){s=e,x=t,i=o,N=n,V.push(s,i)};var F=function(i,s,o,n,a,r,h,E){var l=SPLODER.MeshUtils.getPlaneGeometry(i,s,o,n,a,r,h,E),d=new THREE.Mesh(l,t);return d.userData.rect=e,d},z=function(i,s,o,n,a,r,h,E,l,d,R){var P=SPLODER.MeshUtils.getBoxGeometry(i,s,o,n,a,r,h,E,l,d,R),c=new THREE.Mesh(P,t);return c.userData.rect=e,c};this.build=function(){var V,B,H=e.getAttrib(SPLODER.Biped.PROPERTY_HEIGHT)/255+.5,G=e.getAttrib(SPLODER.Biped.PROPERTY_WEIGHT)/255+.5,k=e.getAttrib(SPLODER.Biped.PROPERTY_STRENGTH)/128,W=e.getAttrib(SPLODER.Biped.PROPERTY_GENDER)/128,X=e.getAttrib(SPLODER.Biped.PROPERTY_HEADSIZE)/128,j=e.getAttrib(SPLODER.Biped.PROPERTY_HEADTHICK)/128,Q=e.getAttrib(SPLODER.Biped.PROPERTY_BEASTLY)/128;r.position.y=96*SPLODER.weightedValue(0,H,.5),b=F(80*SPLODER.weightedValue(0,G,.5),48*SPLODER.weightedValue(0,G,.5,k,.25)),b.material=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:.2}),b.position.y=4,b.rotation.x=0-.5*Math.PI,a.add(b),b=b.clone(),b.material=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:.1}),b.scale.multiplyScalar(1.5),b.position.y=3,a.add(b),h=z(60*SPLODER.weightedValue(0,G,.5),32*SPLODER.weightedValue(0,H,.5),32*SPLODER.weightedValue(0,G,.5,k,.25),0,-16*SPLODER.weightedValue(0,H,.5),0,2,1,1),B=h.geometry,V=B.vertices,SPLODER.MeshUtils.transformUVs(B,o,n,3,19,10,5,19,19,10,5,3,19,1,5,3,19,1,1),V[0].x-=4-8*SPLODER.weightedValue(-1,G,1),V[1].x-=4-8*SPLODER.weightedValue(-1,G,1),V[4].x+=4-8*SPLODER.weightedValue(-1,G,1),V[5].x+=4-8*SPLODER.weightedValue(-1,G,1),V[1].y+=8*SPLODER.weightedValue(0,H,.5),V[4].y+=8*SPLODER.weightedValue(0,H,.5),V[8].y+=8*SPLODER.weightedValue(0,H,.5),V[1].z+=4,V[4].z+=4,V[8].z+=4,V[3].z-=12*SPLODER.weightedValue(-.5,G,.5),V[11].z-=12*SPLODER.weightedValue(-.5,G,.5),V[6].z-=12*SPLODER.weightedValue(-.5,G,.5),V[0].z+=64*SPLODER.weightedValue(-.9,G,.25)-4*Q,V[5].z+=64*SPLODER.weightedValue(-.9,G,.25)-4*Q,V[9].z+=64*SPLODER.weightedValue(-.9,G,.25)-4*Q,V[2].z+=16*SPLODER.weightedValue(-.5,Q,.5),V[7].z+=16*SPLODER.weightedValue(-.5,Q,.5),V[10].z+=16*SPLODER.weightedValue(-.5,Q,.5),V[2].x+=16*SPLODER.weightedValue(-.5,Q,.5),V[7].x-=16*SPLODER.weightedValue(-.5,Q,.5),V[3].x+=8*SPLODER.weightedValue(-.5,Q,.5),V[6].x-=9*SPLODER.weightedValue(-.5,Q,.5),h.rotation.x-=.1*SPLODER.weightedValue(-.5,Q,1),h.position.z-=12*SPLODER.weightedValue(-.5,Q,1),r.add(h),E=z(68*SPLODER.weightedValue(0,G,.5),48*SPLODER.weightedValue(0,H,.5),32*SPLODER.weightedValue(0,G,.5,k,.25),0,24*SPLODER.weightedValue(0,H,.5),0,2,2,1),B=E.geometry,V=B.vertices,SPLODER.MeshUtils.transformUVs(B,o,n,3,11,10,8,19,11,10,8,3,11,1,8,3,11,10,1),V[2].z+=5+2*SPLODER.weightedValue(0,W,.5),V[9].z+=5+2*SPLODER.weightedValue(0,W,.5),V[16].z+=5*SPLODER.weightedValue(0,W,.5),V[17].z-=0,V[2].z+=5*SPLODER.weightedValue(0,G,1),V[9].z+=5*SPLODER.weightedValue(0,G,1),V[16].z+=5*SPLODER.weightedValue(0,G,1),V[0].x-=0-3*SPLODER.weightedValue(-.75,k,1,G,.25),V[1].x-=0-3*SPLODER.weightedValue(-.75,k,1,G,.25),V[2].x-=0-3*SPLODER.weightedValue(-.75,k,1,G,.25),V[3].x-=0-3*SPLODER.weightedValue(-.75,k,1,G,.25),V[6].x+=0-3*SPLODER.weightedValue(-.75,k,1,G,.25),V[7].x+=0-3*SPLODER.weightedValue(-.75,k,1,G,.25),V[8].x+=0-3*SPLODER.weightedValue(-.75,k,1,G,.25),V[9].x+=0-3*SPLODER.weightedValue(-.75,k,1,G,.25),V[4].x-=8-8*SPLODER.weightedValue(-1,G,1),V[5].x-=8-8*SPLODER.weightedValue(-1,G,1),V[10].x+=8-8*SPLODER.weightedValue(-1,G,1),V[11].x+=8-8*SPLODER.weightedValue(-1,G,1),V[4].z+=80*SPLODER.weightedValue(-.9,G,.25),V[14].z+=80*SPLODER.weightedValue(-.9,G,.25),V[11].z+=80*SPLODER.weightedValue(-.9,G,.25),V[4].y+=Math.min(0,80*SPLODER.weightedValue(-.9,Q,.25)),V[14].y+=Math.min(0,80*SPLODER.weightedValue(-.9,Q,.25)),V[11].y+=Math.min(0,80*SPLODER.weightedValue(-.9,Q,.25)),E.rotation.x+=.3*SPLODER.weightedValue(-.5,Q,1),E.position.z-=12*SPLODER.weightedValue(-.5,Q,1),r.add(E),l=z(32*SPLODER.weightedValue(0,G,.8),24*SPLODER.weightedValue(0,H,.5),18*SPLODER.weightedValue(0,G,.8),0,12*SPLODER.weightedValue(0,H,.5),0),l.position.y+=42*SPLODER.weightedValue(0,H,.5),SPLODER.MeshUtils.transformUVs(l.geometry,o,n,6,10,4,1,22,10,4,1,6,10,4,1,6,10,1,1),l.rotation.x+=.3*SPLODER.weightedValue(-.5,Q,1),E.add(l),d=z(42*SPLODER.weightedValue(0,G,.25),48*SPLODER.weightedValue(0,j,.25),42*SPLODER.weightedValue(0,G,.25),0,24*SPLODER.weightedValue(0,j,.25),4,1,1,1,!1,0-SPLODER.weightedValue(0,k,16)),d.position.y+=12*SPLODER.weightedValue(0,H,.5,j,.5),d.position.z+=12*SPLODER.weightedValue(-.5,Q,.5),d.rotation.x-=.6*SPLODER.weightedValue(-.5,Q,1),.25>Q&&(d.rotation.x-=.25-SPLODER.weightedValue(0,Q,1)),SPLODER.MeshUtils.transformUVs(d.geometry,o,n,4,1,8,9,20,1,8,9,36,1,8,9,36,11,8,8),d.scale.multiplyScalar(.25+SPLODER.weightedValue(0,X,.25)),l.add(d),R=z(42*SPLODER.weightedValue(0,G,.25),8*SPLODER.weightedValue(0,j,.25),1,0,4*SPLODER.weightedValue(0,j,.25),0,1,1,1,!1),SPLODER.MeshUtils.transformUVs(R.geometry,o,n,4,0,8,1,20,0,8,1,0,0,0,0,0,0,0,0),R.position.y+=48*SPLODER.weightedValue(0,j,.25),R.position.z+=18*SPLODER.weightedValue(0,G,.25),d.add(R),P=z(24,48*SPLODER.weightedValue(0,j,.25),2,33*SPLODER.weightedValue(0,G,.25)-1,24*SPLODER.weightedValue(0,j,.25),0,1,1,1,!0),SPLODER.MeshUtils.transformUVs(P.geometry,o,n,12,1,4,9,16,1,-4,9,0,0,0,0,0,0,0,0),d.add(P),c=z(24,48*SPLODER.weightedValue(0,j,.25),2,-33*SPLODER.weightedValue(0,G,.25)+1,24*SPLODER.weightedValue(0,j,.25),0),SPLODER.MeshUtils.transformUVs(c.geometry,o,n,0,1,4,9,4,1,-4,9,0,0,0,0,0,0,0,0),d.add(c),O=z(1,48*SPLODER.weightedValue(0,j,.25),24,0,24*SPLODER.weightedValue(0,j,.25),-29*SPLODER.weightedValue(0,G,.25)),SPLODER.MeshUtils.transformUVs(O.geometry,o,n,0,0,0,0,0,0,0,0,32,1,4,9,0,0,0,0),d.add(O),u=(new SPLODER.BipedFace).initWithRectAndMaterial(e,t,o,n),u.build(),u.mesh.position.z=26.2*Math.max(.75,SPLODER.weightedValue(0,G,.25,j,.0125)),u.mesh.position.y=24*SPLODER.weightedValue(0,j,.25,k,.125),u.mesh.rotation.x=0-SPLODER.weightedValue(-1,k,.08),u.mesh.scale.y=1*SPLODER.weightedValue(0,j,.25),d.add(u.mesh),p=z(50*SPLODER.weightedValue(0,G,.25),64*SPLODER.weightedValue(0,j,.25),44*SPLODER.weightedValue(0,G,.25),0,20*SPLODER.weightedValue(0,j,.25),0,1,2,1,!1,0-SPLODER.weightedValue(0,k,24)),B=p.geometry,V=B.vertices,SPLODER.MeshUtils.transformUVs(p.geometry,o,n,36,19,8,8,36,19,1,8,36,19,.9,8,36,19,8,1),V[2].y-=20,V[3].y-=20,V[8].y-=20,V[9].y-=20,V[2].z-=8,V[9].z-=8,V[4].z-=20,V[5].z+=20,V[10].z+=20,V[11].z-=20,d.add(p),f=F(96*SPLODER.weightedValue(0,G,.5),84*SPLODER.weightedValue(0,H,.5),0,42*SPLODER.weightedValue(0,H,.5),0),SPLODER.MeshUtils.transformUVs(f.geometry,o,n,64,5,-16,14),f.position.z-=20*SPLODER.weightedValue(0,G,.5,k,.25),f.rotation.x=0-15*Math.PI/180,E.add(f),f=F(96*SPLODER.weightedValue(0,G,.5),84*SPLODER.weightedValue(0,H,.5),0,42*SPLODER.weightedValue(0,H,.5),0),f.rotation.x=0-15*Math.PI/180,f.position.z-=20*SPLODER.weightedValue(0,G,.5,k,.25),f.rotation.y=Math.PI,SPLODER.MeshUtils.transformUVs(f.geometry,o,n,48,5,16,14),E.add(f),g=F(96*SPLODER.weightedValue(0,G,.5),72*SPLODER.weightedValue(0,H,.5),0,-36*SPLODER.weightedValue(0,H,.5),0,2,1),B=g.geometry,V=B.vertices,SPLODER.MeshUtils.transformUVs(g.geometry,o,n,64,19,-16,12),V[5].y-=16*SPLODER.weightedValue(0,H,1),V[4].y-=16*SPLODER.weightedValue(0,H,1),V[3].y-=16*SPLODER.weightedValue(0,H,1),V[5].x+=16*SPLODER.weightedValue(0,G,.5),V[3].x-=16*SPLODER.weightedValue(0,G,.5),g.position.z-=20*SPLODER.weightedValue(0,G,.5,k,.25),g.rotation.x=18*Math.PI/180-SPLODER.weightedValue(-.9,Q,.5),E.add(g),I=g,g=F(96*SPLODER.weightedValue(0,G,.5),72*SPLODER.weightedValue(0,H,.5),0,-36*SPLODER.weightedValue(0,H,.5),0,2,1),B=g.geometry,V=B.vertices,SPLODER.MeshUtils.transformUVs(g.geometry,o,n,48,19,16,12),V[5].y-=16*SPLODER.weightedValue(0,H,1),V[4].y-=16*SPLODER.weightedValue(0,H,1),V[3].y-=16*SPLODER.weightedValue(0,H,1),V[5].x+=16*SPLODER.weightedValue(0,G,.5),V[3].x-=16*SPLODER.weightedValue(0,G,.5),g.rotation.x=18*Math.PI/180-SPLODER.weightedValue(-.9,Q,.5),g.position.z-=20*SPLODER.weightedValue(0,G,.5,k,.25),g.position.y+=.5,g.rotation.y=Math.PI,E.add(g),L=z(20*SPLODER.weightedValue(0,G,.5,k,.25),40*SPLODER.weightedValue(0,H,.5),20*SPLODER.weightedValue(0,G,.5,k,.25),0,-16*SPLODER.weightedValue(0,H,.5),0,1,1,1,!0,SPLODER.weightedValue(0,G,64)),B=L.geometry,V=B.vertices,SPLODER.MeshUtils.transformUVs(B,o,n,9,24,4,4,19,24,4,4,9,24,1,4,9,24,1,1),V[2].z-=2,V[7].z-=2,L.position.x+=14*SPLODER.weightedValue(0,G,.25),L.position.y-=28*SPLODER.weightedValue(0,H,.5),L.rotation.x-=.2*SPLODER.weightedValue(0,Q,1)*Math.min(1,G),L.rotation.z+=.2*SPLODER.weightedValue(0,Q,1)*Math.min(1,G),L.rotation.y+=.2*SPLODER.weightedValue(0,Q,1)*Math.min(1,G),h.add(L),T=z(22*SPLODER.weightedValue(0,G,.25,k,.25),32*SPLODER.weightedValue(0,H,.5),20*SPLODER.weightedValue(0,G,.25,k,.25),0,-16*SPLODER.weightedValue(0,H,.5),0,1,3,1,!0),B=T.geometry,V=B.vertices,SPLODER.MeshUtils.transformUVs(B,o,n,9,28,4,4,19,28,4,4,9,28,1,4,9,28,1,1),V[0].y+=10,V[9].y+=10,V[4].y+=5,V[6].y+=5,V[13].y+=5,V[15].y+=5,V[4].z+=10,V[6].z+=10,V[13].z+=10,V[15].z+=10,T.position.y=-36*SPLODER.weightedValue(0,H,.5),T.rotation.x+=.4*SPLODER.weightedValue(0,Q,1),L.add(T),S=z(20*SPLODER.weightedValue(0,G,.5,k,.25),40*SPLODER.weightedValue(0,H,.5),20*SPLODER.weightedValue(0,G,.5,k,.25),0,-16*SPLODER.weightedValue(0,H,.5),0,1,1,1,!1,SPLODER.weightedValue(0,G,64)),B=S.geometry,V=B.vertices,SPLODER.MeshUtils.transformUVs(B,o,n,3,24,4,4,25,24,4,4,3,24,1,4,3,24,1,1),V[2].z-=2,V[7].z-=2,S.position.x-=14*SPLODER.weightedValue(0,G,.25),S.position.y-=28*SPLODER.weightedValue(0,H,.5),S.rotation.y-=.2*SPLODER.weightedValue(0,Q,1)*Math.min(1,G),S.rotation.z-=.2*SPLODER.weightedValue(0,Q,1)*Math.min(1,G),S.rotation.x-=.2*SPLODER.weightedValue(0,Q,1)*Math.min(1,G),h.add(S),D=z(22*SPLODER.weightedValue(0,G,.25,k,.25),32*SPLODER.weightedValue(0,H,.5),20*SPLODER.weightedValue(0,G,.25,k,.25),0,-16*SPLODER.weightedValue(0,H,.5),0,1,3,1),B=D.geometry,V=B.vertices,SPLODER.MeshUtils.transformUVs(B,o,n,3,28,4,4,25,28,4,4,3,28,1,4,3,28,1,1),V[0].y+=10,V[9].y+=10,V[4].y+=5,V[6].y+=5,V[13].y+=5,V[15].y+=5,V[4].z+=10,V[6].z+=10,V[13].z+=10,V[15].z+=10,D.position.y=-36*SPLODER.weightedValue(0,H,.5),D.rotation.x+=.4*SPLODER.weightedValue(0,Q,1),S.add(D),m=z(60*SPLODER.weightedValue(0,G,.5),48*SPLODER.weightedValue(0,H,.5),32*SPLODER.weightedValue(0,G,.5,k,.25),0,-24*SPLODER.weightedValue(0,H,.5),0,3),B=m.geometry,V=B.vertices,SPLODER.MeshUtils.transformUVs(B,o,n,7,24,2,6,23,24,2,6,7,24,1,6,7,24,1,1),V[2].x+=6*SPLODER.weightedValue(0,W,.25),V[3].x+=6*SPLODER.weightedValue(0,W,.25),V[6].x-=6*SPLODER.weightedValue(0,W,.25),V[7].x-=6*SPLODER.weightedValue(0,W,.25),V[1].z-=12*SPLODER.weightedValue(-.5,G,.5),V[4].z-=12*SPLODER.weightedValue(-.5,G,.5),V[8].z-=12*SPLODER.weightedValue(-.5,G,.5),V[9].z-=12*SPLODER.weightedValue(-.5,G,.5),V[3].z-=24*SPLODER.weightedValue(0,W,.25),V[6].z-=24*SPLODER.weightedValue(0,W,.25),V[14].z-=24*SPLODER.weightedValue(0,W,.25),V[15].z-=24*SPLODER.weightedValue(0,W,.25),V[12].z+=16*SPLODER.weightedValue(0,W,.25),V[13].z+=16*SPLODER.weightedValue(0,W,.25),V[2].z+=8*SPLODER.weightedValue(0,W,.25),V[7].z+=8*SPLODER.weightedValue(0,W,.25),V[0].z+=16*SPLODER.weightedValue(-.5,Q,.5),V[5].z+=16*SPLODER.weightedValue(-.5,Q,.5),V[10].z+=16*SPLODER.weightedValue(-.5,Q,.5),V[11].z+=16*SPLODER.weightedValue(-.5,Q,.5),V[0].x+=16*SPLODER.weightedValue(-.5,Q,.5),V[5].x-=16*SPLODER.weightedValue(-.5,Q,.5),V[2].x+=16*SPLODER.weightedValue(-.5,Q,.5),V[7].x-=16*SPLODER.weightedValue(-.5,Q,.5),V[1].x+=8*SPLODER.weightedValue(-.5,Q,.5),V[4].x-=8*SPLODER.weightedValue(-.5,Q,.5),V[3].x+=8*SPLODER.weightedValue(-.5,Q,.5),V[6].x-=8*SPLODER.weightedValue(-.5,Q,.5),V[3].y+=16*SPLODER.weightedValue(-.5,Q,.5),V[6].y+=16*SPLODER.weightedValue(-.5,Q,.5),V[14].y+=16*SPLODER.weightedValue(-.5,Q,.5),V[15].y+=16*SPLODER.weightedValue(-.5,Q,.5),m.position.y=-32*SPLODER.weightedValue(0,H,.5),h.add(m),y=z(16*SPLODER.weightedValue(0,k,.35),42*SPLODER.weightedValue(0,H,.5),20*SPLODER.weightedValue(0,k,.35,W,-.25),0,-20*SPLODER.weightedValue(0,H,.5),0,1,1,1,!0,Math.max(0,SPLODER.weightedValue(0,k,24))),B=y.geometry,V=B.vertices,SPLODER.MeshUtils.transformUVs(B,o,n,13,11,3,7,16,11,3,7,15,11,1,7,15,11,1,1),V[4].y+=5,V[5].y+=5,V[3].z+=5*SPLODER.weightedValue(0,k,.35,W,-.25),V[6].z+=5*SPLODER.weightedValue(0,k,.35,W,-.25),y.position.x=40*SPLODER.weightedValue(0,G,.5)+SPLODER.weightedValue(0,k,4),y.position.y+=42*SPLODER.weightedValue(0,H,.5),y.rotation.z+=.2*SPLODER.weightedValue(0,Q,1),y.rotation.x-=.4*SPLODER.weightedValue(0,Q,1),E.add(y),_=z(16*SPLODER.weightedValue(0,k,.35),42*SPLODER.weightedValue(0,H,.5),20*SPLODER.weightedValue(0,k,.35,W,-.25),0,-20*SPLODER.weightedValue(0,H,.5),0,1,1,1,!1,Math.max(0,SPLODER.weightedValue(0,k,24))),B=_.geometry,V=B.vertices,SPLODER.MeshUtils.transformUVs(B,o,n,0,11,3,7,29,11,3,7,0,11,1,7,0,11,1,1),V[0].y+=5,V[1].y+=5,V[3].z+=5*SPLODER.weightedValue(0,k,.35,W,-.25),V[6].z+=5*SPLODER.weightedValue(0,k,.35,W,-.25),_.position.x=-40*SPLODER.weightedValue(0,G,.5)-SPLODER.weightedValue(0,k,4),_.position.y+=42*SPLODER.weightedValue(0,H,.5),_.rotation.z-=.2*SPLODER.weightedValue(0,Q,1),_.rotation.x-=.4*SPLODER.weightedValue(0,Q,1),E.add(_),w=z(18*SPLODER.weightedValue(0,k,.35),42*SPLODER.weightedValue(0,H,.5),22*SPLODER.weightedValue(0,k,.35,W,-.25),0,-21*SPLODER.weightedValue(0,H,.5),0,1,4,1,!0),B=w.geometry,V=B.vertices,SPLODER.MeshUtils.transformUVs(B,o,n,13,18,3,6,16,18,3,6,15,18,1,6,15,18,1,1),V[1].y+=10,V[10].y+=10,V[4].x-=3,V[4].z-=3,V[5].x-=3,V[5].z+=3,V[14].x+=3,V[14].z+=3,V[15].x+=3,V[15].z-=3,V[8].x-=3,V[8].z-=3,V[9].x-=3,V[9].z+=3,V[18].x+=3,V[18].z+=3,V[19].x+=3,V[19].z-=3,w.position.y=-40*SPLODER.weightedValue(0,H,.5),w.rotation.z-=.2*SPLODER.weightedValue(0,Q,1),w.rotation.x-=.2*SPLODER.weightedValue(0,Q,1),y.add(w),i&&N&&(A=(new SPLODER.BipedItem).initWithRectAndMaterial(e,i,N),A.build(),A.mesh.rotation.y=1.57,A.mesh.position.x+=8,w.add(A.mesh)),v=z(18*SPLODER.weightedValue(0,k,.35),42*SPLODER.weightedValue(0,H,.5),22*SPLODER.weightedValue(0,k,.35,W,-.25),0,-21*SPLODER.weightedValue(0,H,.5),0,1,4,1),B=v.geometry,V=B.vertices,SPLODER.MeshUtils.transformUVs(B,o,n,0,18,3,6,29,18,3,6,0,18,1,6,0,18,1,1),V[1].y+=10,V[10].y+=10,V[4].x-=3,V[4].z-=3,V[5].x-=3,V[5].z+=3,V[14].x+=3,V[14].z+=3,V[15].x+=3,V[15].z-=3,V[8].x-=3,V[8].z-=3,V[9].x-=3,V[9].z+=3,V[18].x+=3,V[18].z+=3,V[19].x+=3,V[19].z-=3,v.position.y=-40*SPLODER.weightedValue(0,H,.5),v.rotation.z+=.2*SPLODER.weightedValue(0,Q,1),v.rotation.x-=.2*SPLODER.weightedValue(0,Q,1),_.add(v),Y=F(21*SPLODER.weightedValue(0,k,.35,W,-.25),22*SPLODER.weightedValue(0,H,.5),0,11*SPLODER.weightedValue(0,H,.5),0),Y.position.y-=53.25*SPLODER.weightedValue(0,H,.5),Y.position.x+=8.75*SPLODER.weightedValue(0,k,.35),Y.rotation.y=.5*Math.PI,SPLODER.MeshUtils.transformUVs(Y.geometry,o,n,13,24,5,5),w.add(Y),Y=Y.clone(),Y.rotation.y=.5*-Math.PI,w.add(Y),C=F(21*SPLODER.weightedValue(0,k,.35,W,-.25),22*SPLODER.weightedValue(0,H,.5),0,11*SPLODER.weightedValue(0,H,.5),0),C.position.y-=53.25*SPLODER.weightedValue(0,H,.5),C.position.x-=8.75*SPLODER.weightedValue(0,k,.35),C.rotation.y=.5*-Math.PI,SPLODER.MeshUtils.transformUVs(C.geometry,o,n,13,24,5,5),v.add(C),C=C.clone(),C.rotation.y=.5*Math.PI,v.add(C),s&&x&&(M=(new SPLODER.BipedItem).initWithRectAndMaterial(e,s,x),M.build(),v.add(M.mesh)),B=h.geometry,V=B.vertices,V[0].x-=4*SPLODER.weightedValue(-1,W,1),V[1].x-=4*SPLODER.weightedValue(-1,W,1),V[4].x+=4*SPLODER.weightedValue(-1,W,1),V[5].x+=4*SPLODER.weightedValue(-1,W,1),B=E.geometry,V=B.vertices,V[4].x-=4*SPLODER.weightedValue(-1,W,1),V[5].x-=4*SPLODER.weightedValue(-1,W,1),V[10].x+=4*SPLODER.weightedValue(-1,W,1),V[11].x+=4*SPLODER.weightedValue(-1,W,1),V[2].y+=4*SPLODER.weightedValue(-1,W,1),V[9].y+=4*SPLODER.weightedValue(-1,W,1),V[2].z+=4*SPLODER.weightedValue(-1,W,1),V[9].z+=4*SPLODER.weightedValue(-1,W,1),V[0].y-=4*SPLODER.weightedValue(-.5,W,1),V[1].y-=4*SPLODER.weightedValue(-.5,W,1),V[6].y-=4*SPLODER.weightedValue(-.5,W,1),V[7].y-=4*SPLODER.weightedValue(-.5,W,1),V[0].z-=4*SPLODER.weightedValue(-1,W,1,G,.5),V[1].z+=4*SPLODER.weightedValue(-1,W,1,G,.5),V[6].z+=4*SPLODER.weightedValue(-1,W,1,G,.5),V[7].z-=4*SPLODER.weightedValue(-1,W,1,G,.5),y.position.y-=4*SPLODER.weightedValue(-.5,W,1),_.position.y-=4*SPLODER.weightedValue(-.5,W,1);
var K=function(e){U.push(e.geometry);for(var t=e.children.length;t--;)K(e.children[t])};K(r),this.poses=(new SPLODER.BipedPoses).initWithElements(e,r,h,E,l,u,L,S,y,_,g,I,M,A)};var B=function(e,t,i){i=i||r,SPLODER.MeshUtils.offsetUVsRecursive(e,t,i)};this.destroy=function(){u&&(u.destroy(),u=null),this.poses&&(this.poses.destroy(),this.poses=null)},Object.defineProperty(this,"skinX",{get:function(){return o},set:function(e){if(!isNaN(e)){var t=e-o;B(t,0),o=e}}}),Object.defineProperty(this,"skinY",{get:function(){return n},set:function(e){if(!isNaN(e)){var t=e-n;B(0,t),n=e}}}),Object.defineProperty(this,"mesh",{get:function(){return a}}),Object.defineProperty(this,"itemLeft",{get:function(){return A}}),Object.defineProperty(this,"itemRight",{get:function(){return M}}),Object.defineProperty(this,"geometries",{get:function(){return U}}),Object.defineProperty(this,"materials",{get:function(){return V}})},SPLODER.Biped.PROPERTY_SKIN=5,SPLODER.Biped.PROPERTY_HEIGHT=6,SPLODER.Biped.PROPERTY_WEIGHT=7,SPLODER.Biped.PROPERTY_STRENGTH=8,SPLODER.Biped.PROPERTY_GENDER=9,SPLODER.Biped.PROPERTY_HEADSIZE=10,SPLODER.Biped.PROPERTY_HEADTHICK=11,SPLODER.Biped.PROPERTY_BEASTLY=12,SPLODER.Biped.PROPERTY_ITEMFRAME_RIGHT=13,SPLODER.Biped.PROPERTY_ITEMFRAME_LEFT=14,function(e,t){e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_SKIN]=0,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_HEIGHT]=128,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_WEIGHT]=128,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_STRENGTH]=128,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_GENDER]=128,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_HEADSIZE]=128,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_HEADTHICK]=128,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_BEASTLY]=64,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_ITEMFRAME_RIGHT]=-1,e.defaultsByType[e.TYPE_BIPED][t.PROPERTY_ITEMFRAME_LEFT]=-1}(SPLODER.Item,SPLODER.Biped),SPLODER.ImageMap=function(){var e=0;this.canvas=null,this.context=null;var t,i,s,o;this.initWithDefaultValue=function(t){return e=t,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this};var n=function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},a=function(e,o,n,a,r){var h,E,l,d,R,P,c;for(r=r||0,l=o.x-t,d=o.y-i,R=l+o.width,P=d+o.height,E=d;P>E;E++)for(h=l;R>h;h++)c=E*s+h,c*=4,n[c]=Math.min(255,Math.max(0,10*a)),n[c+1]=Math.min(255,Math.max(0,r)),n[c+2]=0,n[c+3]=255},r=function(e,t,i){if(e){var s=e.items.concat();s.reverse();for(var o,n,r,h=e.items.length;h--;)o=s[h],o.type==SPLODER.Item.TYPE_WALL&&(r=o.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),n=o.getAttrib(SPLODER.Item.PROPERTY_CEIL)?o.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH):128,a(i,o,t,Math.max(0,n-r),o.getAttrib(SPLODER.Item.PROPERTY_LIGHTLEVEL)+o.getAttrib(SPLODER.Item.PROPERTY_LIGHTEFFECT)))}};this.getData=function(e,t,i,s){return s=s||0,this.context.getImageData(e,t,1,1).data[s]},this.updateBounds=function(e,a){var r=e.bounds;t=r.x-a,i=r.y-a,s=Math.min(2048,n(r.width+2*a)),o=Math.min(2048,n(r.height+2*a))},this.update=function(a,h,E){E=E||0;var l=a.bounds;t=l.x-E,i=l.y-E,s=this.canvas.width=Math.min(2048,n(l.width+2*E)),o=this.canvas.height=Math.min(2048,n(l.height+2*E));var d=this.canvas.getContext("2d");d.clearRect(0,0,s,o);var R=new THREE.Color(16776960);R.multiplyScalar(e/255),d.fillStyle="#"+R.getHexString(),d.fillRect(0,0,s,o);var P,c,O,u,L=d.getImageData(0,0,s,o),S=L.data;if(r(a,S,E),E>0&&(d.fillRect(0,0,E,o),d.fillRect(0,0,s,E),d.fillRect(s-E,0,E,o),d.fillRect(0,o-E,s,E)),h){var T=h.length;for(u=0,O=0;o>O;O++){for(c=0;12>c;c++)P=O*s+c,P*=4,T>u&&(S[P+2]=h[u]),u++;if(u>=T)break}}T>u&&console.log("WARNING: All lights could not fit into space"),d.putImageData(L,0,0)}},SPLODER.Store=function(){this.id=0,this.items=null,this.bounds=null,this.duplicatedItems=null,this.selection=null,this.nextItemId=1,this.changed=null,this.bookmarked=null,this.ItemClass=SPLODER.Rect,this.init=function(){return this.id=SPLODER.Store._nextId,SPLODER.Store._nextId++,this.items=[],this.bounds={x:0,y:0,width:0,height:0,size:0},this.duplicatedItems=[],this.selection=[],this.changed=new signals.Signal,this.bookmarked=new signals.Signal,this},this.registerWithDispatcher=function(e){e&&e.add(this.onAction,this)},this.addItem=function(e,t,i,s,o,n){var a=new this.ItemClass(e,t,i,s,o);return a.id=this.nextItemId,this.nextItemId++,this.items.push(a),SPLODER.ShapeUtils.sortByAreaDesc(this.items),n||this.updateBounds(),a},this.updateBounds=function(){this.bounds=SPLODER.ShapeUtils.getBounds(this.items)},this.serialize=function(e){var t=e?!1:!0;e=e||this.items;var i,s=[],o=this.selection,n=[];for(i=e.length;i--;)s.unshift(e[i].serialize());if(t)for(i=o.length;i--;)n.unshift(o[i].id);return s.join("|").split("null").join("@")+"~"+n.join("|")},this.unserialize=function(e,t){if(e){var i=[],s=[];if(e=e.split("@").join("null"),e.indexOf("~")>=0){var o,n=e.split("~"),a=n[0].split("|"),r=n[1].split("|");for(o=0;o<r.length;o++)r[o]=parseInt(r[o]);if(a.length)for(o=0;o<a.length;o++){var h=new this.ItemClass;h.unserialize(a[o]),isNaN(h.id)||(i.push(h),t||(this.nextItemId=Math.max(this.nextItemId,h.id)),r.length&&r.indexOf(h.id)>=0&&s.push(h))}if(SPLODER.ShapeUtils.sortByAreaDesc(i),SPLODER.ShapeUtils.sortByAreaDesc(s),t)return this.changed.dispatch(SPLODER.ACTION_CONTEXT_CHANGE),i;this.nextItemId++,this.items=i,this.selection=s,this.updateBounds(),this.changed.dispatch(SPLODER.ACTION_CONTEXT_CHANGE)}}},this.saveUndo=function(){this.bookmarked.dispatch(this.id)},this.restoreUndo=function(e){this.unserialize(e),this.changed.dispatch(SPLODER.ACTION_UNDO)},this.redo=function(e){this.unserialize(e),this.changed.dispatch(SPLODER.ACTION_REDO)},this.hasSelection=function(e){return void 0===e?this.selection.length>0:this.selection.length==e},this.selectionType=function(){var e=this.selection;if(0==e.length)return-1;for(var t=e[0].type,i=e.length;i--;)if(e[i].type!=t)return-2;return t},this.deleteSelection=function(){for(var e,t=this.selection,i=this.items,s=t.length;s--;)e=i.indexOf(t[s]),e>=0&&i.splice(e,1);this.selection=[],this.updateBounds()},this.getItemById=function(e){for(var t=this.items,i=t.length;i--;)if(t[i].id==e)return t[i];return null},this.filterType=function(e,t){if(void 0!=t&&e!==t){if(t!=SPLODER.Item.TYPE_FILTER_WALL_LIQUID)return!1;if(e!=SPLODER.Item.TYPE_WALL&&e!=SPLODER.Item.TYPE_LIQUID)return!1}return!0},this.getItemsUnderPoint=function(e,t,i,s,o,n,a){i=i||0,s=s||this.items;for(var r,h=s.length,E=o?[]:null;h--;)if(r=s[h],this.filterType(r.type,n))if((r.type==SPLODER.Item.TYPE_ITEM||r.type==SPLODER.Item.TYPE_BIPED)&&SPLODER.Geom.distanceBetweenSquared(e,t,r.x,r.y)<=4){if(!o)return r;E.push(r)}else if(r.type==SPLODER.Item.TYPE_LIGHT&&SPLODER.Geom.distanceBetweenSquared(e,t,r.x,r.y)<=2){if(!o)return r;E.push(r)}else if(e>=r.x-i&&t>=r.y-i&&e<=r.x+r.width+i&&t<=r.y+r.height+i){if(!o)return a?[r].concat(SPLODER.ShapeUtils.getDescendants(r)):r;E.push(r)}return E&&(SPLODER.ShapeUtils.sortByAreaDesc(E),E.reverse()),E},this.getItemUnderPoint=function(e,t,i,s,o){return this.getItemsUnderPoint(e,t,i,null,!1,s,o)},this.selectionIsUnderPoint=function(e,t,i){return this.getItemsUnderPoint(e,t,i,this.selection)},this.itemIsSelected=function(e,t){return-1!==this.selection.indexOf(e)?t?1==this.selection.length:!0:!1},this.itemWithIdIsSelected=function(e,t){var i=this.getItemById(e);return i?this.itemIsSelected(i,t):!1},this.getItemsWithinRect=function(e,t,i,s,o){for(var n,a=this.items,r=a.length,h=[];r--;)n=a[r],this.filterType(n.type,o)&&e<=n.x&&t<=n.y&&e+i>=n.x+n.width&&t+s>=n.y+n.height&&h.push(n);return h},this.getItemsIntersectingRect=function(e,t,i,s,o){for(var n,a=this.items,r=a.length,h=[];r--;)n=a[r],this.filterType(n.type,o)&&(n.x>e+i||n.x+n.width<e||n.y>t+s||n.y+n.height<t||h.push(n));return h},this.getItemsByType=function(e){for(var t,i=[],s=this.items.length;s--;)t=this.items[s],this.filterType(t.type,e)&&i.unshift(t);return i}},SPLODER.Store._nextId=1,SPLODER.Store.prototype.onAction=function(e){console.log("ABSTRACT METHOD CALLED: OVERRIDE!",e)},SPLODER.Store.prototype.copySelectionAsClipboard=function(){var e=this.selection,t={modelId:this.id,bounds:SPLODER.ShapeUtils.getBounds(e),data:""};if(e.length){for(var i=[],s=0;s<e.length;s++)item=e[s],i.push(item.serialize());t.data=i.join("|")}return t},SPLODER.Store.prototype.pasteSelectionFromClipboard=function(e,t){if(e&&e.modelId==this.id&&e.data){this.saveUndo();for(var i=e.data.split("|"),s=this.selection=[],o=0;o<i.length;o++)item=this.addItem(),item.unserialize(i[o],!0),s.push(item);return this.updateBounds(),t!==!1&&s.length>1&&SPLODER.ShapeUtils.sortByAreaDesc(s),this.changed.dispatch(SPLODER.ACTION_CLIPBOARD_PASTE,s),s}},SPLODER.ItemStore=function(){SPLODER.Store.call(this);var e=0;Object.defineProperty(this,"level",{get:function(){return e},set:function(t){isNaN(t)||(e=t)}}),this.ItemClass=SPLODER.Item,this.addItem=function(e,t,i,s,o,n,a){var r=new SPLODER.Item(e,t,i,s,o,n);return r.id=this.nextItemId,this.nextItemId++,this.items.push(r),SPLODER.ShapeUtils.sortByAreaDesc(this.items),a||this.updateBounds(),r},this.onAction=function(e){var t,i,s,o,n,a,r,h,E,l,d,R,P,c,O,u=e[0];switch(u){case SPLODER.ACTION_DESELECT:this.selection.length&&(this.saveUndo(),this.selection=[],this.changed.dispatch(u));break;case SPLODER.ACTION_SELECT_POINT:i=e[1],s=e[2];var L=e[3],S=e[4],T=this.getItemUnderPoint(i,s,0,null,S);if(o=this.selection,T instanceof Array)return this.saveUndo(),this.selection=T,void this.changed.dispatch(u,this.selection);if(r=T){var D=5;if(i-r.x>D&&s-r.y>D&&r.x+r.width-i>D&&r.y+r.height-s>D)return this.itemIsSelected(r)&&(this.saveUndo(),this.selection=[]),void this.changed.dispatch(SPLODER.ACTION_DESELECT)}L?r&&!this.itemIsSelected(r)?(this.saveUndo(),o.push(r),SPLODER.ShapeUtils.sortByAreaDesc(o)):r||o.length&&(this.saveUndo(),this.selection=[]):r&&!this.itemIsSelected(r)?(this.saveUndo(),this.selection=[r]):o.length&&(this.saveUndo(),this.selection=[]),this.changed.dispatch(u,this.selection);break;case SPLODER.ACTION_SELECT_ITEM:e[1]instanceof SPLODER.Rect?(this.selection=[this.getItemById(e[1].id)],this.changed.dispatch(u,this.selection)):isNaN(e[1])||(this.selection=[this.getItemById(e[1])],this.changed.dispatch(u,this.selection));break;case SPLODER.ACTION_SELECT_WINDOW:r=e[1],this.selection=this.getItemsWithinRect(r.x,r.y,r.width,r.height),SPLODER.ShapeUtils.sortByAreaDesc(this.selection),this.changed.dispatch(u,this.selection);break;case SPLODER.ACTION_SELECT_ALL:this.saveUndo(),this.selection=this.items.concat(),SPLODER.ShapeUtils.sortByAreaDesc(this.selection),this.changed.dispatch(u,this.selection);break;case SPLODER.ACTION_SELECTION_START:this.saveUndo();break;case SPLODER.ACTION_SELECTION_MOVE:for(t=this.selection.length;t--;)r=this.selection[t],r.x+=e[1],r.y+=e[2],0==r.currentState&&r.states&&(r.states.hasFrames(SPLODER.Item.PROPERTY_OFFSET_X)&&r.states.offsetFrames(SPLODER.Item.PROPERTY_OFFSET_X,0-e[1]),r.states.hasFrames(SPLODER.Item.PROPERTY_OFFSET_Y)&&r.states.offsetFrames(SPLODER.Item.PROPERTY_OFFSET_Y,0-e[2]));this.updateBounds(),this.changed.dispatch(u,this.selection);break;case SPLODER.ACTION_SELECTION_DUPLICATE:for(this.saveUndo(),o=this.selection,this.selection=[],n=this.duplicatedItems=[],t=o.length;t--;)h=o[t],E=this.addItem(),E.unserialize(h.serialize(),!0),n.unshift(h),this.selection.unshift(E);this.updateBounds(),this.changed.dispatch(u,this.selection);break;case SPLODER.ACTION_SELECTION_MIRROR_H:o=this.selection,o.length>1&&(this.saveUndo(),d=SPLODER.ShapeUtils.getBounds(o),o.forEach(function(e){e.x=2*d.x+d.width-e.x-e.width}),this.updateBounds(),this.changed.dispatch(u,this.selection));break;case SPLODER.ACTION_SELECTION_MIRROR_V:o=this.selection,o.length>1&&(this.saveUndo(),d=SPLODER.ShapeUtils.getBounds(o),o.forEach(function(e){e.y=2*d.y+d.height-e.y-e.height}),this.updateBounds(),this.changed.dispatch(u,this.selection));break;case SPLODER.ACTION_SELECTION_ROTATE:o=this.selection,o.length>0&&(this.saveUndo(),d=SPLODER.ShapeUtils.getBounds(o),o.forEach(function(t){var i=t.x,s=t.y,o=t.width,n=t.height,a=d.width,r=d.height,h=Math.floor(.5*(a-r)),E=Math.floor(.5*(r-a));t.x=d.x+r-(s-d.y)-n+h,t.y=d.y+(i-d.x)+E,t.width=n,t.height=o,t.type==SPLODER.Item.TYPE_BIPED&&SPLODER.modAttrib(t,SPLODER.Item.PROPERTY_ROTATION,90*e[1],360)}),this.updateBounds(),this.changed.dispatch(u,this.selection));break;case SPLODER.ACTION_SELECTION_RELEASE:if(o=this.selection.concat(),n=this.duplicatedItems,o.length&&n.length&&o[0].x==n[0].x&&o[0].y==n[0].y&&o[0].width==n[0].width&&o[0].height==n[0].height)return this.saveUndo(),this.deleteSelection(),this.duplicatedItems=[],void this.changed.dispatch(SPLODER.ACTION_SELECTION_DELETE,o);n.length&&this.changed.dispatch(u,o),this.duplicatedItems=[];break;case SPLODER.ACTION_SELECTION_DELETE:this.selection.length&&(o=this.selection.concat(),this.saveUndo(),this.deleteSelection(),this.changed.dispatch(u,o));break;case SPLODER.ACTION_CREATE:this.saveUndo(),l=e[1],i=e[2],s=e[3];var m=SPLODER.Item,p=this.getItemUnderPoint(i,s,0,m.TYPE_WALL);if(E=this.addItem(l,i,s,e[4],e[5]),this.selection=[E],p){var f=p.getAttrib(m.PROPERTY_FLOORDEPTH);l==m.TYPE_PLATFORM?E.setAttrib(m.PROPERTY_FLOORDEPTH,f+2):l==m.TYPE_PANEL||l==m.TYPE_ITEM||l==m.TYPE_BIPED?E.setAttrib(m.PROPERTY_FLOORDEPTH,f):l==SPLODER.Item.TYPE_LIQUID&&(E.setAttrib(m.PROPERTY_LIQUIDLEVEL,f-2),E.setAttrib(m.PROPERTY_FLOORDEPTH,f-8))}else l==SPLODER.Item.TYPE_WALL?(E.setAttrib(m.PROPERTY_FLOORDEPTH,64),E.setAttrib(m.PROPERTY_CEILDEPTH,80)):l==SPLODER.Item.TYPE_PLATFORM?(E.setAttrib(m.PROPERTY_FLOORDEPTH,66),E.setAttrib(m.PROPERTY_CEILDEPTH,2)):l==SPLODER.Item.TYPE_LIQUID&&(E.setAttrib(m.PROPERTY_FLOORDEPTH,56),E.setAttrib(m.PROPERTY_LIQUIDLEVEL,62));this.changed.dispatch(u,this.selection[0]);break;case SPLODER.ACTION_TWEAK:for(a=e[1],P=e[2],c=e[3],-1==a?o=this.selection:(r=this.getItemById(a),o=[r]),t=0;t<o.length;t++)switch(r=o[t],r.type){case SPLODER.Item.TYPE_BIPED:switch(P){case SPLODER.Biped.PROPERTY_HEIGHT:case SPLODER.Biped.PROPERTY_WEIGHT:case SPLODER.Biped.PROPERTY_STRENGTH:case SPLODER.Biped.PROPERTY_GENDER:case SPLODER.Biped.PROPERTY_HEADSIZE:case SPLODER.Biped.PROPERTY_HEADTHICK:case SPLODER.Biped.PROPERTY_BEASTLY:SPLODER.setAttrib(r,P,c,0,255,0);break;default:SPLODER.setAttrib(r,P,c,0,100,0)}break;default:SPLODER.setAttrib(r,P,c,0,100,0)}this.changed.dispatch(u,o,P);break;case SPLODER.ACTION_CHANGE:for(a=e[1],P=e[2],c=e[3],O=e[4],-1==a?o=this.selection:(r=this.getItemById(a),o=[r]),t=0;t<o.length;t++)if(r=o[t],r.type==SPLODER.Item.TYPE_BIPED)r.setAttrib(P,c,0);else switch(P){case SPLODER.Item.PROPERTY_TOPLEFT:r.width+=r.x-c,r.height+=r.y-O,r.x=c,r.y=O;break;case SPLODER.Item.PROPERTY_TOPRIGHT:r.width=c-r.x,r.height+=r.y-O,r.y=O;break;case SPLODER.Item.PROPERTY_BOTTOMRIGHT:r.width=c-r.x,r.height=O-r.y;break;case SPLODER.Item.PROPERTY_BOTTOMLEFT:r.width+=r.x-c,r.height=O-r.y,r.x=c;break;case SPLODER.Item.PROPERTY_FLOORDEPTH:case SPLODER.Item.PROPERTY_CEILDEPTH:r.type==SPLODER.Item.TYPE_LIQUID&&P==SPLODER.Item.PROPERTY_CEILDEPTH&&(P=SPLODER.Item.PROPERTY_LIQUIDLEVEL),SPLODER.incrementAttrib(r,P,c,0,128,r.currentState);break;case SPLODER.Item.PROPERTY_LIGHTLEVEL:case SPLODER.Item.PROPERTY_POWER:r.type==SPLODER.Item.TYPE_LIGHT?SPLODER.incrementAttrib(r,P,.5*c,0,100,0):SPLODER.incrementAttrib(r,P,c,0,240,0);break;case SPLODER.Item.PROPERTY_LIGHTEFFECT:case SPLODER.Item.PROPERTY_COLOR:SPLODER.modAttrib(r,P,c,9,0),console.log(r.getAttrib(P));break;case SPLODER.Item.PROPERTY_FLOORTEXTURE:case SPLODER.Item.PROPERTY_CEILTEXTURE:case SPLODER.Item.PROPERTY_BOTTOMWALLTEXTURE:case SPLODER.Item.PROPERTY_BOTTOMWALLCORNICETEXTURE:case SPLODER.Item.PROPERTY_TOPWALLTEXTURE:case SPLODER.Item.PROPERTY_TOPWALLCORNICETEXTURE:case SPLODER.Item.PROPERTY_LIQUIDTYPE:this.saveUndo(),r.type==SPLODER.Item.TYPE_LIQUID&&P==SPLODER.Item.PROPERTY_CEILTEXTURE&&(P=SPLODER.Item.PROPERTY_LIQUIDTYPE),O?SPLODER.incrementAttrib(r,P,c,0,512):r.setAttrib(P,c);break;case SPLODER.Item.PROPERTY_CEIL:case SPLODER.Item.PROPERTY_CEIL_SKY:case SPLODER.Item.PROPERTY_LIQUID_HASFLOOR:SPLODER.toggleAttrib(r,P,0),console.log(r,P,r.getAttrib(P))}SPLODER.ShapeUtils.sortByAreaDesc(this.items),this.updateBounds(),this.changed.dispatch(u,o,P);break;case SPLODER.ACTION_CHANGE_COMPLETE:a=e[1],r=this.getItemById(a),this.changed.dispatch(u,r);break;case SPLODER.ACTION_SET_CURRENTSTATE:for(o=this.selection,t=o.length,t||(o=this.items,t=o.length);t--;)r=o[t],r.currentState=e[2];this.changed.dispatch(u,this.selection);break;case SPLODER.ACTION_CLEAR_STATE:for(this.saveUndo(),R=e[2],o=this.selection,t=o.length,t||(o=this.items,t=o.length);t--;)o[t].states.clearState(R),this.changed.dispatch(u,this.selection);break;case SPLODER.ACTION_CLEAR_PROPERTY:for(this.saveUndo(),P=e[2],o=this.selection,t=o.length;t--;)o[t].clearAttrib(P),this.changed.dispatch(u,this.selection);break;default:this.changed.dispatch(u)}SPLODER.ShapeUtils.buildTree(this.items)}},SPLODER.ItemStore.prototype=Object.create(SPLODER.Store.prototype),SPLODER.ItemStore.prototype.constructor=SPLODER.ItemStore,SPLODER.ItemStore.LIGHT_COLOR_CHOICES=[16777215,16764057,16750950,16724736,16711935,10040319,13311,52479,65280],SPLODER.Levels=function(){this.id=null,this.changed=null,this.bookmarked=null;var e=null,t=this;this.model=null,this.envModel=null;var i=0,s=0,o=1;Object.defineProperty(this,"currentLevel",{get:function(){return s},set:function(e){a(e)}}),this.initWithModels=function(t,i){return this.id=SPLODER.Store._nextId,SPLODER.Store._nextId++,e=[],this.model=t,this.envModel=i,this.changed=new signals.Signal,this.bookmarked=new signals.Signal,this},this.initWithModelAndData=function(e,t){this.initWithModel(e),n(t)},this.registerWithDispatcher=function(e){e&&e.add(this.onAction,this)},this.getLevelNums=function(){return e.reduce(function(e,t,i){return t&&t instanceof Array&&e.push(i),e},[])},this.saveUndo=function(){this.bookmarked.dispatch(this.id)},this.restoreUndo=function(e){n(e,SPLODER.ACTION_UNDO),this.changed.dispatch(SPLODER.ACTION_UNDO)},this.redo=function(e){n(e,SPLODER.ACTION_REDO),this.changed.dispatch(SPLODER.ACTION_REDO)},this.serialize=function(){for(var t=[],n=0;n<e.length;n++)t[n]=e[n]instanceof Array?this.model.serialize(e[n]):null;return console.log("SERIALIZING"),console.log(t),t.join("_#_")+"_#_"+i+","+s+","+o};var n=function(i,n){var r=i.split("_#_");e=[];for(var h=0;h<r.length-1;h++)console.log(h,r[h]),e[h]=r[h]&&r[h].length?t.model.unserialize(r[h],!0):h<r.length-1?null:[];var E=SPLODER.parseFloatArray(r[r.length-1].split(","));E.length&&(o=E[2],t.model.nextItemId=o=Math.max(t.model.nextItemId,o),n==SPLODER.ACTION_UNDO?a(E[0],!0):a(E[1],!0)),console.log("current level",s,"max item id",o)},a=function(n,a){if(s!=n&&!isNaN(n)&&n>=0){if(!e[n]){if(n!=e.length)return;e[n]=[]}a||(e[s]=t.model.items),o=Math.max(t.model.nextItemId,o),t.model.selection=[],t.model.items=e[n],i=s,s=t.envModel.currentLevel=n,a||t.saveUndo(),t.changed.dispatch(SPLODER.ACTION_CONTEXT_CHANGE)}},r=function(){a(e.length),t.saveUndo(),t.changed.dispatch(SPLODER.ACTION_CHANGE)},h=function(){if(e[s]instanceof Array&&e[s].length>0){var i=e[s].concat();r(),e[s]=t.model.items=i,t.saveUndo(),t.changed.dispatch(SPLODER.ACTION_CHANGE)}},E=function(){if(console.log("DELETING",e[s]),0!=s&&e[s]instanceof Array){var i=s;a(0),e[i]=null,t.saveUndo(),t.changed.dispatch(SPLODER.ACTION_CHANGE)}};this.onAction=function(e){var t=e[0],i=e[1];switch(t){case SPLODER.ACTION_SELECT_ITEM:a(i);break;case SPLODER.ACTION_SELECTION_DUPLICATE:h();break;case SPLODER.ACTION_SELECTION_DELETE:E();break;case SPLODER.ACTION_CREATE:r()}}},SPLODER.EnvModel=function(){this.id=null,this.changed=null,this.bookmarked=null;var e=null,t=0,i=this;Object.defineProperty(this,"currentLevel",{get:function(){return t},set:function(e){o(e)}}),this.init=function(){return this.id=SPLODER.Store._nextId,SPLODER.Store._nextId++,e=[],this.changed=new signals.Signal,this.bookmarked=new signals.Signal,this},this.initWithData=function(e){this.init(),s(e)},this.setEnv=function(i,s){i=i||0,e[t]||(e[t]=[]),e[t][i]=s},this.getEnvs=function(){return e[t]||[]},this.hasEnv=function(i){return e&&e[t]&&e[t][i]},this.registerWithDispatcher=function(e){e&&e.add(this.onAction,this)},this.saveUndo=function(){this.bookmarked.dispatch(this.id)},this.restoreUndo=function(e){s(e),this.changed.dispatch(SPLODER.ACTION_UNDO)},this.redo=function(e){s(e),this.changed.dispatch(SPLODER.ACTION_REDO)},this.serialize=function(){for(var t=[],i=0;i<e.length;i++)t[i]=e[i]instanceof Array?e[i].join(","):"";return t.join("|")};var s=function(t){for(var s=t.split("|"),o=0;o<s.length;o++)e[o]=s[o]?SPLODER.parseFloatArray(s[o].split(",")):[];i.changed.dispatch([SPLODER.EnvModel.ENVIRONMENT,SPLODER.ACTION_CHANGE])},o=function(e){!isNaN(e)&&e>=0&&(t=e,i.changed.dispatch([SPLODER.EnvModel.ENVIRONMENT,SPLODER.ACTION_CONTEXT_CHANGE,t]))};this.onAction=function(e){if(e){var t=e[0];switch(t){case SPLODER.ACTION_CHANGE:switch(console.log(e),e[2]){case SPLODER.EnvModel.PROPERTY_SKY_COLOR:this.saveUndo();var i=e[3],s=e[4]||0;this.setEnv(SPLODER.EnvModel.PROPERTY_SKY_COLOR,i.getHex(),s),this.changed.dispatch([SPLODER.EnvModel.ENVIRONMENT,SPLODER.ACTION_CHANGE,SPLODER.EnvModel.PROPERTY_SKY_COLOR,i])}}}}},SPLODER.EnvModel.ENVIRONMENT=-10,SPLODER.EnvModel.PROPERTY_SKY_COLOR=0,SPLODER.ModelHistory=function(){var e=null,t=null,i=null,s=null,o=null,n={data:"",modelId:0};this.changed=new signals.Signal,Object.defineProperty(this,"clipboardModelId",{get:function(){return n.modelId}}),Object.defineProperty(this,"hasUndos",{get:function(){return t&&t.length>0}}),Object.defineProperty(this,"hasRedos",{get:function(){return i&&i.length>0}}),this.init=function(){return e=[],t=[],s=[],i=[],o=[],localStorage&&localStorage.getItem("com.sploder.3deditor.history")?this.importHistory(localStorage.getItem("com.sploder.3deditor.history")):this["import"]("==527,0,-18,-18,36,36,[[@,80]]|509,0,-16,-16,32,32,[[@,64,84,@,@,@,@,@,@,@,@,50,7]]|510,0,-7,-6,14,12,[[@,55],[@,68]]|526,2,-7,-6,14,12,[[@,60]]|532,0,-3,-6,6,9,[[@,63]]|521,0,-7,6,14,2,[[@,63]]|518,0,-7,-10,14,2,[[@,66]]|520,0,-7,8,14,2,[[@,66]]|524,0,-7,-8,14,2,[[@,63]]|517,0,9,-6,2,12,[[@,66]]|522,0,7,-6,2,12,[[@,63]]|523,0,-9,-6,2,12,[[@,63]]|519,0,-11,-6,2,12,[[@,66]]|514,0,7,-10,4,4,[[@,84]]|515,0,-11,6,4,4,[[@,84]]|516,0,7,6,4,4,[[@,84]]|511,0,-11,-10,4,4,[[@,84]]|512,5,13,0,0,0,[[@,72,@,@,@,34,35,36]]|513,6,0,0,0,0,[[@,64]]~==1,1,-46,-2,12,4,0,1,2,0,1,0,0,0,0,0|2,2,-28,-2,12,4,0,2,5,4,0,1,1,1,3,6,1,3,2|3,3,8,-4,12,4,0,1,11,0,1,0,2,2|6,3,0,9,12,4,0,0,3,0,0|4,4,-16,9,10,4,0,1,6,0,1,0,0,5,0,3,3|5,5,-7,-4,8,4,0,1,3,0,1,0,1,12,0,1,3|11,6,4,2,4,4,0,1,5,1,1,,,3~"),this},this.registerModel=function(t){t.bookmarked.add(this.handleBookmark,this),e[t.id]=t},this.getModelById=function(t){return e[t]},this.copyToClipboard=function(){for(var t,i=e.length;i--;)if(t=e[i],t&&"hasSelection"in t&&t.hasSelection())return n=t.copySelectionAsClipboard(),this.changed.dispatch(n.modelId),!0;return!1},this.pasteFromClipboard=function(e){if(n.modelId&&n.data){var t=this.getModelById(n.modelId);if(t){var i=t.pasteSelectionFromClipboard(n);if(i&&e){var s=n.bounds.x+.5*n.bounds.width,o=n.bounds.y+.5*n.bounds.height,a=Math.floor(e.x-s),r=Math.floor(e.y-o);i.forEach(function(e){e.x+=a,e.y+=r})}return!0}}return!1},this.handleBookmark=function(e){this.saveUndo(e)},this.saveUndo=function(n){var a=e[n];if(a){var r=a.serialize();if(t.length&&t[0]==r)return;t.unshift(r),s.unshift(n),t.length>24&&(t.pop(),s.pop()),i=[],o=[],this.changed.dispatch(n),localStorage&&localStorage.setItem("com.sploder.3deditor.history",this.exportHistory())}},this.saveAll=function(){for(var t=0;t<e.length;t++)this.saveUndo(t);console.log("SAVED ALL MODELS")},this.restoreUndo=function(){if(t.length&&s.length){var n,a=s[0],r=e[a];if(r){var h=r.serialize();t[0]==h&&(t.shift(),s.shift()),t.length&&s.length&&(i.unshift(h),o.unshift(a),n=t.shift(),a=s.shift(),r=e[a],r&&(r.restoreUndo(n),this.changed.dispatch(a))),localStorage&&localStorage.setItem("com.sploder.3deditor.history",this.exportHistory())}}},this.redo=function(){if(i.length){var n=i.shift(),a=o.shift(),r=e[a];if(r){var h=r.serialize();t.unshift(h),s.unshift(a),r.redo(n),this.changed.dispatch(a),localStorage&&localStorage.setItem("com.sploder.3deditor.history",this.exportHistory())}}},this.restoreModelFromString=function(t,i){var s=e[i];s&&s.redo(t)},this["export"]=function(){for(var t="",i=0;i<e.length;i++)e[i]&&(t+=e[i].serialize()),i!=e.length-1&&(t+="==");return t=t.split("NaN,").join(",")},this["import"]=function(t){for(var i=t.split("=="),s=0;s<e.length;s++)e[s]&&i[s]&&(console.log(e[s]),e[s].unserialize(i[s]))},this.exportHistory=function(){return(t.join("==")+"```"+s.join("==")+"```"+i.join("==")+"```"+o.join("==")).split("NaN,").join(",")},this.importHistory=function(e){var n=e.split("```");t=n[0].split("=="),s=n[1].split("=="),SPLODER.parseFloatArray(s),i=n[2].split("=="),o=n[3].split("=="),SPLODER.parseFloatArray(o)},this.restore=function(){for(var e=[],i=0;i<t.length;i++){var o=s[i];-1==e.indexOf(o)&&(e.push(o),this.restoreModelFromString(t[i],s[i]))}}},SPLODER.FlowNode=function(e,t,i,s,o){SPLODER.Rect.call(this,e,t,i,s,o),this.flowId=0,this.verb="",this.target="",this.amount=0,this.operator="";var n=[];this.children=[],this.childrenTerminal=[],this.defaults=SPLODER.FlowNode.defaultsByType[this.type],this.addChild=function(e,t){-1==this.children.indexOf(e)&&(t=t||0,this.children.push(e),this.childrenTerminal.push(t))},this.removeChild=function(e){var t=this.children.indexOf(e);-1!=t&&(this.children.splice(t,1),this.childrenTerminal.splice(t,1))},this.getAttrib=function(e){return n?isNaN(n[e])?this.defaults&&!isNaN(this.defaults[e])?this.defaults[e]:0:n[e]:-1},this.setAttrib=function(e,t){n&&(n[e]=t)},this.getAttribs=function(){return n},this.clone=function(){var e=new SPLODER.FlowNode(this.type,this.x,this.y,this.width,this.height);return e.id=this.id,e.flowId=this.flowId,e.init().unserialize(this.serialize())},this.serialize=function(){return SPLODER.Rect.prototype.serialize.call(this)+","+[this.flowId,this.children.length].concat(this.children,this.childrenTerminal,n).join(",")},this.unserialize=function(e,t){SPLODER.Rect.prototype.unserialize.call(this,e,t);for(var i=e.split(",").slice(6),s=i.length;s--;)i[s]=parseFloat(i[s]);this.flowId=i.shift();var o=i.shift();o?(this.children=i.slice(0,o),this.childrenTerminal=i.slice(o,o+o)):(this.children=[],this.childrenTerminal=[]),isNaN(this.flowId)&&(this.flowId=0),n=i.slice(2*o)||[],this.defaults=SPLODER.FlowNode.defaultsByType[this.type]},this.toString=function(e,t){if(!e)return"no model found";t=t||0;var i=[],s=SPLODER.FlowNode.typeVerbStrings[this.type],o=this.getAttrib(SPLODER.FlowNode.PROPERTY_SUBTYPE),n=this.getAttrib(SPLODER.FlowNode.PROPERTY_OPERATOR),a=this.getAttrib(SPLODER.FlowNode.PROPERTY_TARGET_TYPE),r=this.getAttrib(SPLODER.FlowNode.PROPERTY_TARGET);this.type==SPLODER.FlowNode.TYPE_CONDITION&&5>=o&&(n=0),s&&i.push(s),o&&i.push(SPLODER.FlowNode.subtypeStrings[this.type][o]),n&&i.push(SPLODER.FlowNode.operatorStrings[n]),a&&i.push(SPLODER.FlowNode.targetTypeStrings[a]),a!=SPLODER.FlowNode.TARGET_TYPE_NONE&&void 0!==r&&(this.type==SPLODER.FlowNode.TYPE_ACTION&&a==SPLODER.FlowNode.TARGET_TYPE_NUMBER&&r>=0&&(r="+"+r),i.push(r));var h=i.concat();if(this.type==SPLODER.FlowNode.TYPE_LOOP)this.children.length&&(i.push("FROM INSTRUCTION"),i.push('"'+e.getItemById(this.children[0]).toString(e,t+999)+'"'));else if(24>t)for(var E=0;E<this.children.length;E++){var l="",d=null,R="";l=this.type==SPLODER.FlowNode.TYPE_TRIGGER?0==this.childrenTerminal[E]?", then with object A (self):":", then with object B:":0==this.childrenTerminal[E]?", then":this.type==SPLODER.FlowNode.TYPE_TRIGGER?", then with B":", "+h.join(" ").split("IF ").join("OTHERWISE IF NOT (")+"), then",d=e.getItemById(this.children[E]),d&&(R=d.toString(e,t+1),R&&(i.push(l),i.push(R)))}return i.join(" ").split("  ").join(" ").split(" , ").join(", ")}},SPLODER.FlowNode._nextId=1,SPLODER.FlowNode.SCOPE_GAME=0,SPLODER.FlowNode.SCOPE_SECTOR=1,SPLODER.FlowNode.SCOPE_PANEL=2,SPLODER.FlowNode.SCOPE_ITEM=3,SPLODER.FlowNode.SCOPE_BIPED=4,SPLODER.FlowNode.TYPE_TRIGGER=1,SPLODER.FlowNode.TYPE_CONDITION=2,SPLODER.FlowNode.TYPE_ACTION=3,SPLODER.FlowNode.TYPE_CONTEXT=4,SPLODER.FlowNode.TYPE_DELAY=5,SPLODER.FlowNode.TYPE_LOOP=6,SPLODER.FlowNode.typeStrings=["","event","condition","action","context","delay","loop"],SPLODER.FlowNode.PROPERTY_SUBTYPE=0,SPLODER.FlowNode.PROPERTY_OPERATOR=1,SPLODER.FlowNode.PROPERTY_TARGET_TYPE=2,SPLODER.FlowNode.PROPERTY_TARGET=3,SPLODER.FlowNode.TRIGGER_EVERYFRAME=1,SPLODER.FlowNode.TRIGGER_START=2,SPLODER.FlowNode.TRIGGER_COLLISION=3,SPLODER.FlowNode.TRIGGER_CRUSH=4,SPLODER.FlowNode.TRIGGER_ENTER=5,SPLODER.FlowNode.TRIGGER_EXIT=6,SPLODER.FlowNode.TRIGGER_EMPTY=7,SPLODER.FlowNode.TRIGGER_NEAR=8,SPLODER.FlowNode.TRIGGER_SEE=9,SPLODER.FlowNode.TRIGGER_TEXT=10,SPLODER.FlowNode.TRIGGER_STATE_CHANGED=10,SPLODER.FlowNode.TRIGGER_HEALTH_CHANGED=11,SPLODER.FlowNode.TRIGGER_PLAYER_SCORED=12,SPLODER.FlowNode.TRIGGER_ITEM_PICKED_UP=13,SPLODER.FlowNode.TRIGGER_ITEM_DESTROYED=14,SPLODER.FlowNode.CONDITION_TOUCHING=1,SPLODER.FlowNode.CONDITION_HAS=2,SPLODER.FlowNode.CONDITION_CONTAINS=3,SPLODER.FlowNode.CONDITION_TAG_MATCHES=4,SPLODER.FlowNode.CONDITION_STATE_MATCHES=5,SPLODER.FlowNode.CONDITION_PROPERTY_HEALTH=6,SPLODER.FlowNode.CONDITION_PROPERTY_STRENGTH=7,SPLODER.FlowNode.CONDITION_PROPERTY_RANGE=8,SPLODER.FlowNode.CONDITION_PROPERTY_ARMOR=9,SPLODER.FlowNode.CONDITION_PROPERTY_MEMORY=10,SPLODER.FlowNode.CONDITION_PROPERTY_SCORE=11,SPLODER.FlowNode.ACTION_GOTO_STATE=1,SPLODER.FlowNode.ACTION_ALLOW=2,SPLODER.FlowNode.ACTION_DISALLOW=3,SPLODER.FlowNode.ACTION_CHANGE_PROPERTY_HEALTH=4,SPLODER.FlowNode.ACTION_CHANGE_PROPERTY_STRENGTH=5,SPLODER.FlowNode.ACTION_CHANGE_PROPERTY_RANGE=6,SPLODER.FlowNode.ACTION_CHANGE_PROPERTY_ARMOR=7,SPLODER.FlowNode.ACTION_CHANGE_PROPERTY_MEMORY=8,SPLODER.FlowNode.ACTION_SPAWN_ITEM=9,SPLODER.FlowNode.ACTION_TELEPORT=10,SPLODER.FlowNode.ACTION_PICKUP=11,SPLODER.FlowNode.ACTION_DROP=12,SPLODER.FlowNode.ACTION_SHOW_TEXT=13,SPLODER.FlowNode.ACTION_SOLID_OFF=14,SPLODER.FlowNode.ACTION_SOLID_ON=15,SPLODER.FlowNode.ACTION_DESTROY=16,SPLODER.FlowNode.ACTION_LOSE_GAME=17,SPLODER.FlowNode.ACTION_WIN_GAME=18,SPLODER.FlowNode.ACTION_FOLLOW=19,SPLODER.FlowNode.ACTION_ATTACK=20,SPLODER.FlowNode.ACTION_FLEE=21,SPLODER.FlowNode.ACTION_GUARD=22,SPLODER.FlowNode.CONTEXT_SUBJECT=1,SPLODER.FlowNode.DELAY_WAIT=1,SPLODER.FlowNode.LOOP_REPEAT=1,SPLODER.FlowNode.OPERATOR_NONE=0,SPLODER.FlowNode.OPERATOR_EQUALS=1,SPLODER.FlowNode.OPERATOR_NOTEQUALS=2,SPLODER.FlowNode.OPERATOR_GREATERTHAN=3,SPLODER.FlowNode.OPERATOR_LESSTHAN=4,SPLODER.FlowNode.TARGET_TYPE_NONE=0,SPLODER.FlowNode.TARGET_TYPE_NUMBER=1,SPLODER.FlowNode.TARGET_TYPE_STATE=2,SPLODER.FlowNode.TARGET_TYPE_TAG=3,SPLODER.FlowNode.TARGET_TYPE_TEXT=4,SPLODER.FlowNode.TAG_ANY=0,SPLODER.FlowNode.TAG_PLAYER=-1,SPLODER.FlowNode.TAG_GROUP_GOOD=-2,SPLODER.FlowNode.TAG_GROUP_BAD=-3,SPLODER.FlowNode.rectWidths=[12,12,12,12,10,8,4],SPLODER.FlowNode.typeVerbStrings=["","ON","IF","","","","REPEAT"],SPLODER.FlowNode.subtypeStrings=[[""],["","frame","start","collision","crush","enter sector","exit sector","sector empty","near","see","text button","state changed","health changed","player scored","item picked up","item destroyed"],["","tagged","state is","picked up","contains","touching","health","strength","range","armor","memory","score"],["","goto","allow","disallow","health","strength","range","armor","memory","spawn item","teleport to","pick up","drop","show text","solid off","solid on","self-destruct","lose game","win game","follow","attack","flee","guard"],["","TELL A","TELL B","TELL"],["","WAIT"],["","LOOP"]],SPLODER.FlowNode.subtypeTargetTypes=function(){var e=SPLODER.FlowNode.TARGET_TYPE_NONE,t=SPLODER.FlowNode.TARGET_TYPE_NUMBER,i=SPLODER.FlowNode.TARGET_TYPE_STATE,s=SPLODER.FlowNode.TARGET_TYPE_TAG,o=SPLODER.FlowNode.TARGET_TYPE_TEXT;return[[e],[e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e],[e,s,i,s,s,s,t,t,t,t,t,t],[e,i,e,e,t,t,t,t,t,s,s,s,s,o,e,e,e,e,e,s,s,s,s],[e,e,e,s],[e,t],[e,t]]
}(),SPLODER.FlowNode.triggerTerminals=[0,1,1,2,2,2,2,1,2,2,1,1,2,1,1,1],SPLODER.FlowNode.triggerTypesByScope=[[0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0]],SPLODER.FlowNode.actionTypesByScope=[[0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0][0],[0,1,1,1,1,1,1,1,1,1,0,0,0,0,1,1,1,0,0,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,0,0,1,1,1,0,0,0,0,1,1,1,1]],SPLODER.FlowNode.operatorStrings=["","equal to","not equal to","greater than","less than"],SPLODER.FlowNode.operatorSymbols=["","==","!=",">","<"],SPLODER.FlowNode.targetTypeStrings=["","","state","tag"],SPLODER.FlowNode.tagStrings=["any","player","good group","evil group"],SPLODER.FlowNode.defaults=[],SPLODER.FlowNode.defaultsByType=[],function(e){e.defaults[e.PROPERTY_SUBTYPE]=1,e.defaults[e.PROPERTY_OPERATOR]=SPLODER.FlowNode.OPERATOR_NONE,e.defaults[e.PROPERTY_TARGET_TYPE]=SPLODER.FlowNode.TARGET_TYPE_NUMBER,e.defaults[e.PROPERTY_TARGET]=1;for(var t=e.TYPE_TRIGGER;t<=e.TYPE_LOOP;t++)e.defaultsByType[t]=e.defaults.concat();e.defaultsByType[e.TYPE_TRIGGER][e.PROPERTY_SUBTYPE]=SPLODER.FlowNode.CONDITION_TOUCHING,e.defaultsByType[e.TYPE_TRIGGER][e.PROPERTY_TARGET_TYPE]=SPLODER.FlowNode.TARGET_TYPE_NONE,e.defaultsByType[e.TYPE_TRIGGER][e.PROPERTY_TARGET]=0,e.defaultsByType[e.TYPE_CONDITION][e.PROPERTY_SUBTYPE]=SPLODER.FlowNode.CONDITION_TOUCHING,e.defaultsByType[e.TYPE_CONDITION][e.PROPERTY_OPERATOR]=SPLODER.FlowNode.OPERATOR_EQUALS,e.defaultsByType[e.TYPE_CONDITION][e.PROPERTY_TARGET_TYPE]=SPLODER.FlowNode.TARGET_TYPE_TAG,e.defaultsByType[e.TYPE_CONDITION][e.PROPERTY_TARGET]=SPLODER.FlowNode.TAG_ANY,e.defaultsByType[e.TYPE_ACTION][e.PROPERTY_SUBTYPE]=SPLODER.FlowNode.ACTION_GOTO_STATE,e.defaultsByType[e.TYPE_ACTION][e.PROPERTY_TARGET_TYPE]=SPLODER.FlowNode.TARGET_TYPE_STATE,e.defaultsByType[e.TYPE_ACTION][e.PROPERTY_TARGET]=1,e.defaultsByType[e.TYPE_CONTEXT][e.PROPERTY_SUBTYPE]=SPLODER.FlowNode.CONTEXT_SUBJECT,e.defaultsByType[e.TYPE_CONTEXT][e.PROPERTY_TARGET_TYPE]=SPLODER.FlowNode.TARGET_TYPE_TAG,e.defaultsByType[e.TYPE_CONTEXT][e.PROPERTY_TARGET]=SPLODER.FlowNode.TAG_PLAYER,e.defaultsByType[e.TYPE_DELAY][e.PROPERTY_SUBTYPE]=SPLODER.FlowNode.DELAY_WAIT,e.defaultsByType[e.TYPE_DELAY][e.PROPERTY_TARGET_TYPE]=SPLODER.FlowNode.TARGET_TYPE_NUMBER,e.defaultsByType[e.TYPE_DELAY][e.PROPERTY_TARGET]=3,e.defaultsByType[e.TYPE_LOOP][e.PROPERTY_SUBTYPE]=SPLODER.FlowNode.LOOP_REPEAT,e.defaultsByType[e.TYPE_LOOP][e.PROPERTY_TARGET_TYPE]=SPLODER.FlowNode.TARGET_TYPE_NUMBER,e.defaultsByType[e.TYPE_LOOP][e.PROPERTY_TARGET]=0}(SPLODER.FlowNode),SPLODER.FlowStore=function(){SPLODER.Store.call(this);var e=this,t=0;Object.defineProperty(this,"flowId",{get:function(){return t},set:function(i){isNaN(i)||(t=i,e.selection=[],e.changed.dispatch(SPLODER.ACTION_CONTEXT_CHANGE))}}),this.ItemClass=SPLODER.FlowNode,this.getItemsUnderPoint=function(e,t,i,s,o,n){i=i||0,s=s||this.items;for(var a,r=s.length,h=o?[]:null;r--;)if(a=s[r],(void 0==n||a.type===n)&&a.flowId==this.flowId&&e>=a.x-i&&t>=a.y-i&&e<=a.x+a.width+i&&t<=a.y+a.height+i){if(!o)return a;h.push(a)}return h},this.onAction=function(e){if(e){var t,i,s,o,n,a,r,h,E,l,d,R,P,c=e[0];switch(c){case SPLODER.ACTION_DESELECT:this.selection.length&&(this.saveUndo(),this.selection=[],this.changed.dispatch(c));break;case SPLODER.ACTION_SELECT_POINT:i=e[1],s=e[2];var O=e[3],u=e[4],L=this.getItemUnderPoint(i,s,0,null,u);if(o=this.selection,L&&L.length>1)return this.saveUndo(),this.selection=L,void this.changed.dispatch(c,this.selection);if(r=L){var S=5;if(i-r.x>S&&s-r.y>S&&r.x+r.width-i>S&&r.y+r.height-s>S)return this.itemIsSelected(r)&&(this.saveUndo(),this.selection=[]),void this.changed.dispatch(SPLODER.ACTION_DESELECT)}O?r&&!this.itemIsSelected(r)?(this.saveUndo(),o.push(r),SPLODER.ShapeUtils.sortByAreaDesc(o)):r||o.length&&(this.saveUndo(),this.selection=[]):r&&!this.itemIsSelected(r)?(this.saveUndo(),this.selection=[r]):o.length&&(this.saveUndo(),this.selection=[]),this.changed.dispatch(c,this.selection);break;case SPLODER.ACTION_SELECT_ITEM:e[1]instanceof SPLODER.Item&&(this.selection=[this.getItemById(e[1].id)],this.changed.dispatch(c,this.selection));break;case SPLODER.ACTION_SELECT_WINDOW:r=e[1],this.selection=this.getItemsIntersectingRect(r.x,r.y,r.width,r.height),SPLODER.ShapeUtils.sortByAreaDesc(this.selection),this.changed.dispatch(c,this.selection);break;case SPLODER.ACTION_SELECT_ALL:this.saveUndo(),this.selection=this.items.concat(),SPLODER.ShapeUtils.sortByAreaDesc(this.selection),this.changed.dispatch(c,this.selection);break;case SPLODER.ACTION_SELECTION_START:this.saveUndo();break;case SPLODER.ACTION_SELECTION_MOVE:for(t=this.selection.length;t--;)this.selection[t].x+=e[1],this.selection[t].y+=e[2];this.updateBounds(),this.changed.dispatch(c,this.selection);break;case SPLODER.ACTION_SELECTION_DUPLICATE:for(this.saveUndo(),o=this.selection,this.selection=[],n=this.duplicatedItems=[],t=o.length;t--;)h=o[t],E=this.addItem(),E.unserialize(h.serialize(),!0),E.flowId=this.flowId,n.unshift(h),this.selection.unshift(E);SPLODER.FlowStore.remapNodeConnections(n,this.selection),this.updateBounds(),this.changed.dispatch(c,this.selection);break;case SPLODER.ACTION_SELECTION_RELEASE:if(o=this.selection.concat(),n=this.duplicatedItems,o.length&&n.length&&o[0].x==n[0].x&&o[0].y==n[0].y&&o[0].width==n[0].width&&o[0].height==n[0].height)return this.saveUndo(),this.deleteSelection(),this.duplicatedItems=[],void this.changed.dispatch(SPLODER.ACTION_SELECTION_DELETE,o);n.length&&this.changed.dispatch(c,o),this.duplicatedItems=[];break;case SPLODER.ACTION_SELECTION_DELETE:this.selection.length&&(o=this.selection.concat(),this.saveUndo(),this.deleteSelection(),this.changed.dispatch(c,o));break;case SPLODER.ACTION_CREATE:this.saveUndo(),l=e[1],d=e[2],R=e[3],P=e[4],i=e[5],s=e[6],E=this.addItem(l,i,s,e[7],e[8]),E.flowId=this.flowId;var T=SPLODER.FlowNode.subtypeTargetTypes[l][d];E.setAttrib(SPLODER.FlowNode.PROPERTY_SUBTYPE,d),E.setAttrib(SPLODER.FlowNode.PROPERTY_OPERATOR,R),E.setAttrib(SPLODER.FlowNode.PROPERTY_TARGET_TYPE,T),E.setAttrib(SPLODER.FlowNode.PROPERTY_TARGET,P),this.selection=[E],this.changed.dispatch(c,this.selection[0]);break;case SPLODER.ACTION_CHANGE:a=e[1];var D=e[2],m=e[3];for(-1==a?o=this.selection:(r=this.getItemById(a),o=[r]),t=0;t<o.length;t++){r=o[t];var d=r.getAttrib(SPLODER.FlowNode.PROPERTY_SUBTYPE),T=SPLODER.FlowNode.subtypeTargetTypes[r.type][d];switch(D){case SPLODER.FlowNode.PROPERTY_SUBTYPE:var p=SPLODER.FlowNode.subtypeStrings[r.type].length-1;SPLODER.incrementAttrib(r,D,m,1,p,0),d=r.getAttrib(SPLODER.FlowNode.PROPERTY_SUBTYPE),T=SPLODER.FlowNode.subtypeTargetTypes[r.type][d],isNaN(T)||r.setAttrib(SPLODER.FlowNode.PROPERTY_TARGET_TYPE,T);break;case SPLODER.FlowNode.PROPERTY_OPERATOR:r.type==SPLODER.FlowNode.TYPE_CONDITION&&SPLODER.incrementAttrib(r,D,m,0,4,0);break;case SPLODER.FlowNode.PROPERTY_TARGET_TYPE:SPLODER.incrementAttrib(r,D,m,0,3,0);break;case SPLODER.FlowNode.PROPERTY_TARGET:var f=0;T==SPLODER.FlowNode.TARGET_TYPE_TAG?f=-7:T==SPLODER.FlowNode.TARGET_TYPE_STATE&&(f=1),r.type==SPLODER.FlowNode.TYPE_ACTION&&T==SPLODER.FlowNode.TARGET_TYPE_NUMBER&&(f=-99),SPLODER.incrementAttrib(r,D,m,f,99,0)}}this.updateBounds(),this.changed.dispatch(c,o,D);break;case SPLODER.ACTION_CHANGE_COMPLETE:a=e[1],r=this.getItemById(a),this.changed.dispatch(c,r);break;case SPLODER.ACTION_CONNECT:var g=this.getItemById(e[1]),I=this.getItemById(e[2]);g&&I&&g.addChild(I.id,e[3]),this.changed.dispatch(c,g);break;case SPLODER.ACTION_DISCONNECT:r=this.getItemById(e[1]);var y=e[2];if(r)if(2==y)for(t=this.items.length;t--;)this.items[t].removeChild(r.id);else for(t=r.children.length;t--;)r.childrenTerminal[t]==y&&r.removeChild(r.children[t]);this.changed.dispatch(c,r)}}}},SPLODER.FlowStore.prototype=Object.create(SPLODER.Store.prototype),SPLODER.FlowStore.prototype.constructor=SPLODER.FlowStore,SPLODER.FlowStore.remapNodeConnections=function(e,t){if(t&&e)for(var i,s,o,n,a=e.length,r=function(e,t){for(var i=e.length;i--;)if(e[i]&&e[i].id==t)return i;return-1};a--;)if(e[a]&&t[a]&&(i=e[a],s=t[a],i&&s&&i.children.length))for(o=i.children.length;o--;)n=r(e,i.children[o]),-1!=n&&(console.log("remapping node child id",s.children[o],t[n].id),s.children[o]=t[n].id)},SPLODER.FlowStore.prototype.pasteSelectionFromClipboard=function(e){if(e&&e.data){var t,i=e.data.split("|"),s=[];for(t=0;t<i.length;t++)item=this.addItem(),item.unserialize(i[t]),s.push(item);var o=SPLODER.Store.prototype.pasteSelectionFromClipboard.apply(this,arguments);for(t=o.length;t--;)o[t].flowId=this.flowId,o[t].x+=1,o[t].y+=1;SPLODER.FlowStore.remapNodeConnections(s,o)}},SPLODER.TagModel=function(){this.id=null,this.changed=null,this.bookmarked=null;var e=[],t=this,i=7;this.init=function(){this.id=SPLODER.Store._nextId,SPLODER.Store._nextId++;for(var t=0-i;64>=t;t++)e[t+i]=[];return this.changed=new signals.Signal,this.bookmarked=new signals.Signal,this},this.initWithData=function(e){this.init(),s(e)},this.setTag=function(t,s,o){isNaN(t)||isNaN(s)||(o?-1==e[t+i].indexOf(s)&&(e[t+i].push(s),this.changed.dispatch(SPLODER.ACTION_CHANGE,t,s)):-1!=e[t+i].indexOf(s)&&(e[t+i].splice(e[t+i].indexOf(s),1),this.changed.dispatch(SPLODER.ACTION_CHANGE,t,s)))},this.getTags=function(t){return e.reduce(function(e,s,o){return-1!=s.indexOf(t)&&e.push(o-i),e},[])},this.hasTag=function(t,s){return!isNaN(t)&&!isNaN(s)&&-1!=e[t+i].indexOf(s)},this.registerWithDispatcher=function(e){e&&e.add(this.onAction,this)},this.saveUndo=function(){this.bookmarked.dispatch(this.id)},this.restoreUndo=function(e){s(e),this.changed.dispatch(SPLODER.ACTION_UNDO)},this.redo=function(e){s(e),this.changed.dispatch(SPLODER.ACTION_REDO)},this.serialize=function(){for(var t=[],s=0-i;64>=s;s++)t[s+i]=e[s+i].join(",");return t.join("|")};var s=function(s){for(var o=s.split("|"),n=0-i;64>=n;n++)e[n+i]=o[n+i]?SPLODER.parseFloatArray(o[n+i].split(",")):[];t.changed.dispatch(SPLODER.ACTION_CHANGE)};this.onAction=function(e){if(e){var t=e[0];switch(t){case SPLODER.ACTION_CHANGE:var i=e[1],s=e[2],o=e[3];this.setTag(s,i,o),this.saveUndo()}}}},SPLODER.Physics={},SPLODER.Physics.rayCast2d=function(e,t,i,s,o,n){for(var a,r,h,E=t.x/s,l=t.y/s,d=i.x/s,R=i.y/s,P=Math.min(E,d),c=Math.min(l,R),O=Math.abs(E-d),u=Math.abs(l-R),L=e.getItemsIntersectingRect(P,c,O,u),S=[],T=L.length,D=!1;T--;)if(a=L[T],(!o||a.type==o)&&(r=SPLODER.Geom.rectIntersectsLine(a,E,l,d,R)))for(var m=0;m<r.length;m++)h=r[m],S.push({rect:a,pt:h,dist:Math.floor(10*SPLODER.Geom.distanceBetween(E,l,h.x,h.y))/10,area:a.area()}),n&&a==n&&(D=!0);if(S.sort(function(e,t){return e.dist>t.dist?1:e.dist<t.dist?-1:e.area>t.area?-1:e.area<t.area?1:0}),n&&D)for(T=S.length;T--;)if(S[T].rect==n){S.splice(T+1,S.length-T);break}return S},SPLODER.Physics.rayCast3d=function(e,t,i,s,o,n){var a={x:t.x,y:t.z},r={x:i.x,y:i.z};s=s||32;for(var h,E,l,d,R,P=SPLODER.Physics.rayCast2d(e,a,r,s,o,n),c=new THREE.Vector3,O=SPLODER.Geom.distanceBetweenXZ(t,i),u=[],L=0;L<P.length;L++)h=P[L],c.copy(t),c.lerp(i,h.dist*s/O),l=c.y/(.5*s),E=h.rect,d=E.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),R=E.getAttrib(SPLODER.Item.PROPERTY_CEIL)?E.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH):128,(E.type==SPLODER.Item.TYPE_WALL&&(d>=l||l>=R)||E.type==SPLODER.Item.TYPE_LIQUID&&d>=l||E.type==SPLODER.Item.TYPE_PLATFORM&&l>d&&R>l)&&u.push(h);return u},SPLODER.Physics.rayCast3db=function(e,t,i,s){s=s||32;var o,n,a,r={x:t.x/s,y:t.z/s},h={x:i.x/s,y:i.z/s},E=SPLODER.Geom.gridPointsAlongLine(Math.floor(r.x),Math.floor(r.y),Math.floor(h.x),Math.floor(h.y)),l=e.getItemsIntersectingRect(Math.min(r.x,h.x),Math.min(r.y,h.y),Math.abs(h.x-r.x),Math.abs(h.y-r.y)),d=new THREE.Vector3,R=SPLODER.Geom.distanceBetweenXZ(t,i),P=[],c=.5,O=.5;r.x>h.x&&(c=-.5),r.y>h.y&&(O=-.5);for(var u=0;u<E.length;u+=2){o={x:E[u],y:E[u+1]},a=SPLODER.Geom.distanceBetween(r.x,r.y,o.x+.5,o.y+.5),d.copy(t),d.lerp(i,a*s/R),n=d.y/(.5*s);var L=SPLODER.Physics.checkHitAtGridPoint(o.x,o.y,n,l);L&&L.length&&P.push({rect:L[0],pt:o,dist:a,area:L[0].area(),offsetX:c,offsetY:O})}return P},SPLODER.Physics.checkHitAtGridPoint=function(e,t,i,s){var o,n,a,r,h,E=[];if(s){SPLODER.ShapeUtils.sortByAreaDesc(s);for(var l,d=s.length;d--;)if(l=s[d],!(l.x>e||l.x+l.width<=e||l.y>t||l.y+l.height<=t))switch(o=l.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),n=l.getAttrib(SPLODER.Item.PROPERTY_CEIL)?l.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH):128,l.type){case SPLODER.Item.TYPE_WALL:!a&&(o>=i||i>=n)&&E.push(l),a=!0;break;case SPLODER.Item.TYPE_PLATFORM:!r&&i>o&&n>i&&E.push(l),r=!0;break;case SPLODER.Item.TYPE_LIQUID:!h&&l.getAttrib(SPLODER.Item.PROPERTY_LIQUID_HASFLOOR)&&o>=i&&E.push(l),h=!0}}return E},SPLODER.Physics.pointInWallCheck=function(e,t){var i=t.y/16,s=e.getItemsUnderPoint(Math.floor(t.x/32)+.5,Math.floor(t.z/32)+.5,0,!1,!1,SPLODER.Item.TYPE_WALL);return s&&(s.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH)>i-1||s.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH)<i+1)},SPLODER.Physics.elevationCheck=function(e,t,i,s,o,n){var a,r,h,E,l,d,R=i.clone().divideScalar(32),P=16,c=e.getItemsIntersectingRect(R.x-s-1,R.z-s-1,2*s+2,2*s+2);SPLODER.ShapeUtils.sortByAreaDesc(c);var O=[e.getItemsUnderPoint(R.x,R.z,0,c,!1,SPLODER.Item.TYPE_PLATFORM)];s>0&&O.push(e.getItemsUnderPoint(R.x+s,R.z+s,0,c,!1,SPLODER.Item.TYPE_PLATFORM),e.getItemsUnderPoint(R.x+s,R.z-s,0,c,!1,SPLODER.Item.TYPE_PLATFORM),e.getItemsUnderPoint(R.x-s,R.z+s,0,c,!1,SPLODER.Item.TYPE_PLATFORM),e.getItemsUnderPoint(R.x-s,R.z-s,0,c,!1,SPLODER.Item.TYPE_PLATFORM));var u=[];if(O)for(d=O.length;d--;)h=O[d],h&&(E=h.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH)*P,l=h.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH)*P,t>=E-P?u.push({rect:h,f:E,c:128*P}):E-l-P>=t&&u.push({rect:h,f:0,c:l}));var L=[e.getItemsUnderPoint(R.x,R.z,0,c,!1,SPLODER.Item.TYPE_FILTER_WALL_LIQUID)];if(s>0&&L.push(e.getItemsUnderPoint(R.x+s,R.z+s,0,c,!1,SPLODER.Item.TYPE_FILTER_WALL_LIQUID),e.getItemsUnderPoint(R.x+s,R.z-s,0,c,!1,SPLODER.Item.TYPE_FILTER_WALL_LIQUID),e.getItemsUnderPoint(R.x-s,R.z+s,0,c,!1,SPLODER.Item.TYPE_FILTER_WALL_LIQUID),e.getItemsUnderPoint(R.x-s,R.z-s,0,c,!1,SPLODER.Item.TYPE_FILTER_WALL_LIQUID)),L)for(d=L.length;d--;)if(h=L[d]){if(E=h.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH)*P,l=h.getAttrib(SPLODER.Item.PROPERTY_CEIL)?h.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH)*P:1e4,h.type==SPLODER.Item.TYPE_LIQUID){if(!h.getAttrib(SPLODER.Item.PROPERTY_LIQUID_HASFLOOR))continue;l=1e4}u.push({rect:h,f:E,c:l})}if(!u.length)return-1;if(u.sort(function(e,t){return e.f>t.f?-1:e.f<t.f?1:0}),a=u[0].f,u.sort(function(e,t){return e.c>t.c?1:e.c<t.c?-1:0}),r=u[0].c,a>r)return-1;if(o)return t>=a+8*P&&r-4*P>t?t:Math.min(a+10*P,Math.max(r-3*P,a+.5*(r-a)));var S=Math.max(a,Math.min(a+10*P,r-3*P));return n&&(i.y=S),S},SPLODER.Physics._getCollisionRect=function(e,t,i,s){var o,n,a,r;return o=i,n=s,a=1,r=1,i<t.x?(o-=3,a+=3):i>t.x&&(a+=3),s<t.y?(n-=3,r+=3):s>t.y&&(r+=3),{type:e.type,id:e.id,x:o,y:n,width:a,height:r}},SPLODER.Physics.collisionCheck=function(e,t,i,s){SPLODER.Physics.elevationCheck(e,t.y,t,1,i,!0);var o,n,a=t,r=a.y/16,h={x:Math.floor(a.x/32),y:Math.floor(a.z/32)},E={x:a.x/32,y:a.z/32},l={x:a.x/32,y:a.z/32},d=e.getItemsIntersectingRect(h.x-2,h.y-2,4,4);SPLODER.ShapeUtils.sortByAreaDesc(d);var R,P,c,O,u,L,S,T=[];for(P=e.getItemsUnderPoint(h.x+.5,h.y+.5,0,d,!1,SPLODER.Item.TYPE_FILTER_WALL_LIQUID),P&&(o=P.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),n=P.type!=SPLODER.Item.TYPE_LIQUID?P.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH):1e3,(o>r-1||r+1>n)&&(S=P)),L=h.y-2;L<=h.y+2;L++)for(u=h.x-2;u<=h.x+2;u++)P=e.getItemsUnderPoint(u+.5,L+.5,0,d,!1,SPLODER.Item.TYPE_FILTER_WALL_LIQUID),o=0,n=256,P&&(o=P.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),n=P.type!=SPLODER.Item.TYPE_LIQUID&&P.getAttrib(SPLODER.Item.PROPERTY_CEIL)?P.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH):256),(u!=h.x||L!=h.y)&&(P&&(o>r-2||r+1>n)&&P!=S?T.push(SPLODER.Physics._getCollisionRect(P,h,u,L)):(P=e.getItemsUnderPoint(u+.5,L+.5,0,d,!1,SPLODER.Item.TYPE_PLATFORM),P&&(o=P.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),n=o-P.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH)),P&&o>r+2&&r+2>n?T.push(SPLODER.Physics._getCollisionRect(P,h,u,L)):(P=e.getItemsUnderPoint(u+.5,L+.5,0,d,!1,SPLODER.Item.TYPE_PANEL),P&&(o=P.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),n=P.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH),c=o,r+1>c&&c+Math.max(2*P.width,2*P.height)>r-6&&T.push(SPLODER.Physics._getCollisionRect(P,h,u,L))))));for(R=T.length;R--;)if(P=T[R],O=SPLODER.Geom.resolvePenetrationCircleRect(E,1.5,P,1),!s&&O)return!0;if(!s)return!1;var D={x:0/0,y:a.y,z:0/0};return E.x!=l.x&&(D.x=32*E.x),E.y!=l.y&&(D.z=32*E.y),D},SPLODER.Simple2dGL=function(){var e,t,i,s,o,n,a,r;this.init=function(){return t=document.createElement("canvas"),e=t.getContext("webgl"),e||(e=t.getContext("experimental-webgl")),this.resize(),h(),e.useProgram(r),l(),i=0,this},this.updateNumLights=function(e){i=e};var h=function(){o=document.getElementById("fragmentShader_shadows").innerHTML,n=e.createShader(e.VERTEX_SHADER),e.shaderSource(n,SPLODER.Simple2dGL.defaultVertexSrc.join("\n")),e.compileShader(n),a=e.createShader(e.FRAGMENT_SHADER),e.shaderSource(a,o),e.compileShader(a),r=e.createProgram(),e.attachShader(r,n),e.attachShader(r,a),e.linkProgram(r)};this.resize=function(i,s){t.width=i||128,t.height=s||128,e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight)};var E=function(e,t,i,s,o){var n=t,a=t+s,r=i,h=i+o;e.bufferData(e.ARRAY_BUFFER,new Float32Array([n,r,a,r,n,h,n,h,a,r,a,h]),e.STATIC_DRAW)},l=function(){var t=e.getAttribLocation(r,"aTextureCoord"),i=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(t),e.vertexAttribPointer(t,2,e.FLOAT,!1,0,0)};this.render=function(o){var n=e.getAttribLocation(r,"a_position"),a=e.createTexture();e.bindTexture(e.TEXTURE_2D,a),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,o);var h=e.getUniformLocation(r,"dimensions");e.uniform2f(h,t.width,t.height);var l=e.getUniformLocation(r,"numLights");e.uniform1f(l,i||0),s=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,s),e.enableVertexAttribArray(n),e.vertexAttribPointer(n,2,e.FLOAT,!1,0,0),E(e,0,0,o.width,o.height),e.drawArrays(e.TRIANGLES,0,6)},this.copyToDataTexture=function(i){var s=t.width,o=t.height,n=new Uint8Array(4*s*o),a=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,a),e.readPixels(0,0,s,o,e.RGBA,e.UNSIGNED_BYTE,n),e.bindRenderbuffer(e.RENDERBUFFER,null);var r=i.image;r&&(r.width=s,r.height=o,r.data=n)}},SPLODER.Simple2dGL.defaultVertexSrc=["attribute vec2 a_position;","attribute vec2 aTextureCoord;","uniform vec2 dimensions;","varying vec2 vTextureCoord;","void main() {","vec2 zeroToOne = a_position / dimensions;","vec2 zeroToTwo = zeroToOne * 2.0;","vec2 clipSpace = zeroToTwo - 1.0;","gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);","vTextureCoord = aTextureCoord;","}"],SPLODER.Simple2dGL.defaultFragmentSrc=["precision highp float;","uniform sampler2D uSampler;","uniform vec2 dimensions;","varying vec2 vTextureCoord;","uniform float numLights;","void main() {","gl_FragColor = texture2D(uSampler, vTextureCoord);","}"],SPLODER.LightMap=function(){var e,t,i,s;this.init=function(){return e=(new SPLODER.ImageMap).initWithDefaultValue(160),i=new THREE.Vector4(-16,-16,32,32),t=new THREE.DataTexture(null,32,32,THREE.RGBAFormat,THREE.UnsignedByteType),t.minFilter=t.magFilter=THREE.NearestFilter,this};var o=function(e,t,i){return Math.pow(Math.max(0,1-i/e),t+1)},n=function(e){var t,i,o,n,a=e.bounds.x-1,r=e.bounds.y-1,h=e.getItemsByType(SPLODER.Item.TYPE_LIGHT);for(s=[],t=0;t<h.length;t++){i=h[t],s[t]={x:i.x-a,y:i.y-r,color:new THREE.Color(SPLODER.ItemStore.LIGHT_COLOR_CHOICES[i.getAttrib(SPLODER.Item.PROPERTY_COLOR)]),power:i.getAttrib(SPLODER.Item.PROPERTY_POWER)/255,space:16};var E=e.getItemUnderPoint(i.x,i.y,0,SPLODER.Item.TYPE_WALL);E&&(o=E.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),n=E.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH),i.space=Math.max(0,n-o))}},a=function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},r=function(r){n(r);var E,l,d=r.bounds,R=a(d.width+2),P=a(d.height+2);i.x=d.x-1,i.y=d.y-1,i.z=R,i.w=P,t.image.width=R,t.image.height=P,t.image.data=l=new Uint8Array(R*P*4);var c=e.canvas,O=c.width,u=c.height;console.log(R,P);for(var L,S,T,D,m,p,f,g=new THREE.Color,I=new THREE.Color,y=new THREE.Color,_=new THREE.Color,w=0;u>w;w++)for(var v=0;O>v;v++){for(L=4*(w*O+v),S=4*(w*R+v),g.setHex(0),E=0;E<s.length;E++)if(T=s[E],D=T.color,m=SPLODER.Geom.distanceBetween(T.x,T.y,v,w),64>m){y.setRGB(1,1,1);var A=100/(T.power*T.power*1e3);f=o(80,A,m)*(1+5*T.power),y.multiplyScalar(f),p=Math.max(0,Math.min(1,h(T.x,T.y,v,w)/Math.max(16*T.space,1))),_.copy(y),_.multiplyScalar(p),D.r>D.b?I.setRGB(1,.7,.5):D.r<D.b?I.setRGB(.5,.7,1):I.setRGB(1,1,1),_.multiply(D),_.multiply(I),g.add(_),g.r=Math.max(0,Math.min(1,g.r)),g.g=Math.max(0,Math.min(1,g.g)),g.b=Math.max(0,Math.min(1,g.b))}l[S]=Math.floor(255*g.r),l[S+1]=Math.floor(255*g.g),l[S+2]=Math.floor(255*g.b),l[S+3]=e.getData(v,w,1,1)}t.needsUpdate=!0},h=function(t,i,s,o){for(var n,a=SPLODER.Geom.gridPointsAlongLine(t,i,s,o),r=128,h=0;h<a.length;h+=2)if(n=e.getData(a[h],a[h+1],1,0),n>=0&&(r=Math.min(r,n)),0==r)return 0;return r};this.update=function(t,i){t&&i&&(e.updateBounds(t,1),n(t),e.update(t,null,1),r(t))},Object.defineProperty(this,"texture",{get:function(){return t}}),Object.defineProperty(this,"size",{get:function(){return i}})},SPLODER.ShaderLightMap=function(){var e,t,i,s,o,n,a;this.init=function(){return e=(new SPLODER.ImageMap).initWithDefaultValue(160),i=new THREE.Vector4(-16,-16,32,32),t=new THREE.DataTexture(null,32,32),t.minFilter=t.magFilter=THREE.NearestFilter,a=(new SPLODER.Simple2dGL).init(),o=[0,0,new THREE.Color(0),100,0,12,new THREE.Color(16711680),70,12,0,new THREE.Color(65280),70],this};var r=function(e){var t,i,s,r,h,E,l,d,R,P,c,O,u=e.bounds.x-1,L=e.bounds.y-1,S=e.getItemsByType(SPLODER.Item.TYPE_LIGHT);if(S)for(O=[],t=S.length;t--;)s=S[t],r=SPLODER.ItemStore.LIGHT_COLOR_CHOICES[s.getAttrib(SPLODER.Item.PROPERTY_COLOR)],O.unshift(s.x,s.y,new THREE.Color(r),s.getAttrib(SPLODER.Item.PROPERTY_POWER));else O=o;for(a.updateNumLights(O.length/4),n=[],t=0;t<O.length;t+=4){h=O[t]-u+1024,E=O[t+1]-L+1024,l=O[t+2],d=O[t+3],R=16;var T=e.getItemUnderPoint(O[t],O[t+1],0,SPLODER.Item.TYPE_WALL);T&&(P=T.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),c=T.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH),R=Math.max(0,c-P)),i=3*t,n[i]=h>>8&255,n[i+1]=255&h,n[i+2]=R,n[i+3]=255,n[i+4]=E>>8&255,n[i+5]=255&E,n[i+6]=d,n[i+7]=255,n[i+8]=Math.floor(255*l.r),n[i+9]=Math.floor(255*l.g),n[i+10]=Math.floor(255*l.b),n[i+11]=255}},h=function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},E=function(o){s||r(o);var n=o.bounds,E=h(n.width+2),l=h(n.height+2);i.x=n.x-1,i.y=n.y-1,i.z=E,i.w=l,a.resize(e.canvas.width,e.canvas.height),a.render(e.canvas),a.copyToDataTexture(t),t.needsUpdate=!0};this.update=function(t){t&&(r(t),e.update(t,n,1),E(t))},Object.defineProperty(this,"texture",{get:function(){return t}}),Object.defineProperty(this,"size",{get:function(){return i}})},SPLODER.SceneModel=function(){this.model=null,this.shapes=null,this.shapesById=null,this.ceilingShapes=null,this.tilesize=32,this.tilesizeHalf=16,this.scene=null,this.renderer=null,this.sceneMeshes=null,this.sceneMeshesById=null,this.sceneUniforms=null,this.sceneUniformsById=null,this.sceneMeshesCameraAligned=null,this.light=null,this.camera=null,this.cameraDummy=null,this.cameraAngle=null,this.isDirty=!0,this.assets=null,this.lightMap=null,this.emptyArray=[]},SPLODER.SceneModel.prototype.initWithModelsAndSize=function(e,t,i,s){return this.model=e,this.envModel=t,this.assets=i,this.tilesize=s||32,this.tilesizeHalf=.5*this.tilesize,this.shapesById=[],this.sceneMeshes=[],this.sceneMeshesById=[],this.sceneUniforms=[],this.sceneUniformsById=[],SPLODER.ShapeUtils.errorOccured.add(this.onError),this},SPLODER.SceneModel.prototype.build=function(e){var t;this.renderer=e,this.scene=new THREE.Scene,t=new THREE.PointLight(16777215,1,2560),t.position.y=1152,this.scene.add(t);var i=this.envModel.getEnvs();i?this.setSkyColor(null,i[SPLODER.EnvModel.PROPERTY_SKY_COLOR]):console.log("ENVIRONMENT UNDEFINED")},SPLODER.SceneModel.prototype.watchModel=function(){this.model.changed.add(this.onModelChanged,this),this.envModel.changed.add(this.onEnvModelChanged,this),this.updateModel()},SPLODER.SceneModel.prototype.setAllUniforms=function(e,t){for(var i=this.sceneUniforms,s=i.length;s--;)u=i[s],u&&u.hasOwnProperty(e)&&(u[e].value=t)},SPLODER.SceneModel.prototype.onModelChanged=function(e,t,i){var s,o,n,a,r,h,E=this.sceneUniformsById,l=this.model.selection;if(e==SPLODER.ACTION_DESELECT)return void this.setAllUniforms("selected",0);if(e==SPLODER.ACTION_CONTEXT_CHANGE&&(this.setDirty(),this.assets.setLightMapDirty()),t instanceof Array)switch(e){case SPLODER.ACTION_SET_CURRENTSTATE:if(o=t.length)for(;o--;)n=t[o],this.updateMeshPositionById(n.id),this.updateMeshTexturesById(n.id);else this.setDirty();console.log("state changed!");break;case SPLODER.ACTION_SELECT_ALL:case SPLODER.ACTION_SELECT_ITEM:case SPLODER.ACTION_SELECT_POINT:case SPLODER.ACTION_SELECT_WINDOW:for(this.setAllUniforms("selected",0),o=t.length;o--;)if(n=t[o],r=E[n.id])for(s=r.length;s--;)a=r[s],a&&a.selected&&(a.selected.value=1);break;case SPLODER.ACTION_TWEAK:if(i<SPLODER.Item.PROPERTY_HEALTH)for(o=t.length,this.removeMeshesById(t);o--;)n=t[o],this.buildMesh(n);else i==SPLODER.Item.PROPERTY_GRAVITY&&this.updateMeshPositionById(t[0].id);break;case SPLODER.ACTION_CHANGE:for(o=t.length;o--;)switch(n=t[o],r=E[n.id],i){case SPLODER.Item.PROPERTY_FLOORDEPTH:case SPLODER.Item.PROPERTY_CEILDEPTH:n.type==SPLODER.Item.TYPE_WALL||n.type==SPLODER.Item.TYPE_PANEL||n.type==SPLODER.Item.TYPE_ITEM?this.updateMeshPositionById(n.id):n.type==SPLODER.Item.TYPE_PLATFORM?this.updateRectMeshes(n,!0):n.type==SPLODER.Item.TYPE_LIQUID&&(this.updateMeshPositionById(n.id),this.updateVertexColorsIntersecting(n));case SPLODER.Item.PROPERTY_LIGHTLEVEL:case SPLODER.Item.PROPERTY_LIGHTEFFECT:case SPLODER.Item.PROPERTY_COLOR:case SPLODER.Item.PROPERTY_POWER:this.assets.setLightMapDirty();break;case SPLODER.Item.PROPERTY_TOPLEFT:case SPLODER.Item.PROPERTY_TOPRIGHT:case SPLODER.Item.PROPERTY_BOTTOMRIGHT:case SPLODER.Item.PROPERTY_BOTTOMLEFT:if(n.type==SPLODER.Item.TYPE_LIQUID&&this.updateVertexColorsIntersecting(n),1==t.length&&n.type>SPLODER.Item.TYPE_LIQUID)return this.removeMeshesById(t),void this.buildMesh(n);this.updateMeshesNear(l,!0);break;case SPLODER.Item.PROPERTY_FLOORTEXTURE:case SPLODER.Item.PROPERTY_CEILTEXTURE:case SPLODER.Item.PROPERTY_BOTTOMWALLTEXTURE:case SPLODER.Item.PROPERTY_BOTTOMWALLCORNICETEXTURE:case SPLODER.Item.PROPERTY_TOPWALLTEXTURE:case SPLODER.Item.PROPERTY_TOPWALLCORNICETEXTURE:if(!(n.type<=SPLODER.Item.TYPE_ITEM))return this.removeMeshesById(t),void this.buildMesh(n);this.updateMeshTexturesById(n.id),n.type==SPLODER.Item.TYPE_LIQUID&&this.updateVertexColorsIntersecting(n);break;default:this.setDirty()}break;case SPLODER.ACTION_SELECTION_MOVE:if(1==l.length){if(h=l[0],h.type==SPLODER.Item.TYPE_LIGHT)return void this.assets.setLightMapDirty();if(h.type>SPLODER.Item.TYPE_LIQUID)return this.removeMeshesById(h),void this.buildMesh(h)}for(this.updateMeshesNear(l,!0),s=l.length;s--;)h=l[s],h&&h.type==SPLODER.Item.TYPE_LIQUID&&this.updateVertexColorsIntersecting(h);break;case SPLODER.ACTION_SELECTION_DELETE:this.removeShapes(t),this.removeMeshesById(t),this.updateMeshesNear(t);break;default:this.setDirty()}else switch(e){case SPLODER.ACTION_CREATE:this.buildMesh(t),this.assets.setLightMapDirty();break;case SPLODER.ACTION_CHANGE_COMPLETE:t.type>SPLODER.Item.TYPE_LIQUID?(this.removeMeshesById(t),this.buildMesh(t)):this.updateMeshesNear([t]);break;default:this.setDirty()}},SPLODER.SceneModel.prototype.onEnvModelChanged=function(){console.log("ENV MODEL CHANGED",arguments);var e=this.envModel.getEnvs(),t=new THREE.Color;t.setHex(e[SPLODER.EnvModel.PROPERTY_SKY_COLOR]),this.setSkyColor(t)},SPLODER.SceneModel.prototype.setDirty=function(){this.isDirty=!0},SPLODER.SceneModel.prototype.hasObjectWithId=function(e){return null!=this.sceneMeshesById[e]},SPLODER.SceneModel.prototype.getFloorLevel=function(e,t){var i=this.tilesizeHalf,s=0,o=this.model.getItemsUnderPoint(e,t,0,null,!1,SPLODER.Item.TYPE_PLATFORM);o&&(s=Math.max(s,o.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH)*i));var n=this.model.getItemsUnderPoint(e,t,0,null,!1,SPLODER.Item.TYPE_WALL);n&&(s=Math.max(s,n.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH)*i));var a=this.model.getItemsUnderPoint(e,t,0,null,!1,SPLODER.Item.TYPE_LIQUID);return a&&(s=Math.max(s,a.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH)*i-a.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH)*i)),o||n||!this.camera||(s=Math.floor(this.camera.position.y/i)),s},SPLODER.SceneModel.prototype.removeMeshesById=function(e,t){e instanceof Array||(e=[e]);var i,s=e.length,o=null;for(t&&(o=[]);s--;){i=e[s].id;var n=this.sceneMeshesById[i];if(n){for(var a,r,h=n.length;h--;)a=n[h],(a instanceof THREE.Group||a instanceof THREE.Mesh)&&(r=this.sceneMeshes.indexOf(a),-1!=r&&this.sceneMeshes.splice(r,1),t&&(a instanceof THREE.Mesh?o.push(a.material):a.userData.biped&&(o=a.userData.biped.materials)),this.scene.remove(a),SPLODER.MeshUtils.destroyMesh(a,t));this.sceneMeshesById[i]=null,this.sceneUniformsById[i]=null}}return o},SPLODER.SceneModel.prototype.updateMeshPositionById=function(e,t){var i,s,o,n=this.sceneMeshesById[e];if(t=t||0,n)for(i=0;2>i;i++)if(s=i,n[i]){if(o=n[i].userData.rect,!t&&o.type==SPLODER.Item.TYPE_PLATFORM&&o.root!=o)return void this.updateMeshPositionById(o.root.id);this.updateMeshPosition(n[i],o,s)}if(o&&o.type<=SPLODER.Item.TYPE_PLATFORM&&(i=o.numChildren))for(var a=o.children;i--;)this.updateMeshPositionById(a[i].id,t+1)},SPLODER.SceneModel.prototype.updateMeshPosition=function(e,t,i){if(e&&t){var s,o,n=this.tilesize,a=this.tilesizeHalf,r=t.x,h=t.y,E=t.width,l=t.height,d=0,R=t.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),P=t.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH);switch(t.type){case SPLODER.Item.TYPE_WALL:i?this.placeMesh(e,t,r*n,Math.max(P,R)*a,h*n,90*Math.PI/180,-1):this.placeMesh(e,t,r*n,R*a,h*n,90*Math.PI/180);break;case SPLODER.Item.TYPE_PLATFORM:this.placeMesh(e,t,r*n,R*a,h*n,90*Math.PI/180);break;case SPLODER.Item.TYPE_LIQUID:i?this.placeMesh(e,t,r*n+.5*E*n,t.getAttrib(SPLODER.Item.PROPERTY_LIQUIDLEVEL)*a+.01,h*n+.5*l*n,-90*Math.PI/180):this.placeMesh(e,t,r*n,R*a,h*n,90*Math.PI/180);break;case SPLODER.Item.TYPE_PANEL:s=e.geometry.parameters.width,o=e.geometry.parameters.height,d=0,l>E&&(d=.5*Math.PI),this.placeMesh(e,t,r*n+.5*E*n,R*a+.5*o,h*n+.5*l*n),e.rotation.y=d;break;case SPLODER.Item.TYPE_ITEM:o=e.geometry.parameters.height;var c=t.getAttrib(SPLODER.Item.PROPERTY_GRAVITY);c?this.placeMesh(e,t,r*n,this.getFloorLevel(r,h)+.5*o,h*n):this.placeMesh(e,t,r*n,R*a+.5*o,h*n);break;case SPLODER.Item.TYPE_BIPED:this.placeMesh(e,t,r*n,this.getFloorLevel(r,h),h*n,0,1,t.getAttrib(SPLODER.Item.PROPERTY_ROTATION)*Math.PI/180)}}},SPLODER.SceneModel.prototype.updateMeshTexturesById=function(e){var t=this.sceneMeshesById[e];if(t){var i=this.model.getItemById(e);if(t[0]&&this.setTextures(i,t[0].material),t[1]&&this.setTextures(i,t[1].material),i&&i.type<=SPLODER.Item.TYPE_LIQUID){var s=i.numChildren;if(s)for(var o=i.children;s--;)this.updateMeshTexturesById(o[s].id)}}},SPLODER.SceneModel.prototype.setVertexColors=function(e,t){if(e&&t&&t.faces){for(var i,s,o,n,a,r=t.faces.length,h=t.vertices,E=!1;r--;)i=t.faces[r],s=i.normal,i.color.setRGB(0,0,0),o=(h[i.a].x+h[i.b].x+h[i.c].x)/3/32,n=(h[i.a].y+h[i.b].y+h[i.c].y)/3/32,o+=e.x,n+=e.y,a=this.model.getItemUnderPoint(o,n,0,SPLODER.Item.TYPE_LIQUID),a&&(i.color.setRGB(a.getAttrib(SPLODER.Item.PROPERTY_LIQUIDLEVEL),a.getAttrib(SPLODER.Item.PROPERTY_LIQUIDTYPE),0),E=!0);
E&&(t.colorsNeedUpdate=!0)}},SPLODER.SceneModel.prototype.setTextures=function(e,t){if(e&&t){var i,s=t.uniforms,o=s.ceiling?s.ceiling.value:0;e.type!=SPLODER.Item.TYPE_LIQUID||o||(i=SPLODER.SceneAssets.TYPE_WALLS);var n,a,r,h=this.assets.getTextureSet(e,i),E=[];switch(e.type){case SPLODER.Item.TYPE_LIQUID:if(o){s.textureSet.value=[e.getAttrib(SPLODER.Item.PROPERTY_LIQUIDTYPE),0,0];break}case SPLODER.Item.TYPE_WALL:if(o&&e.getAttrib(SPLODER.Item.PROPERTY_CEIL_SKY))return;case SPLODER.Item.TYPE_PLATFORM:if(s.textureSet){for(s.textureSet.value=n=o?h[1]:h[0],r=0;3>r;r++)a=n[r],E=E.concat(this.assets.getTextureFrames(SPLODER.SceneAssets.TYPE_WALLS,a));s.frames.value=E}break;case SPLODER.Item.TYPE_PANEL:case SPLODER.Item.TYPE_ITEM:for(n=h,s.textureSet.value=n,r=0;3>r;r++)a=n[r],E=E.concat(this.assets.getTextureFrames(SPLODER.SceneAssets.TYPE_ITEMS,a));s.frames.value=E}s.hasOwnProperty("selected")&&(s.selected.value=this.model.itemWithIdIsSelected(e.id)?1:0)}},SPLODER.SceneModel.prototype.buildMesh=function(e,t,i,s){if(e){if(e instanceof Array)return void console.log("RECT IS ARRAY",e);if(s=s||this.emptyArray,null==t&&(e.type<SPLODER.Item.TYPE_LIQUID||e.type==SPLODER.Item.TYPE_LIQUID&&!i)){var o=i?this.ceilingShapes:this.shapes;if(o)for(var n=o.length;n--;)try{if(o[n].userData.parentNode.id==e.id){t=o[n];break}}catch(a){console.log("error checking rectShape")}if(null==t)return console.log("Error! Item shape not found for rect",e.id,i,this.shapes.length,this.ceilingShapes.length),void this.setDirty()}var r,h,E,l,d,R,P,c,O,u,L,S,T,D,m,p,f=this.tilesize,g=this.tilesizeHalf;L=e.x,S=e.y,T=e.width,D=e.height;var I={bevelEnabled:!1};switch(E=e.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH),d=e.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH),l=e.getAttrib(SPLODER.Item.PROPERTY_CEIL_SKY),R=this.assets.getTextureSet(e),h=null,c=null,e.type){case SPLODER.Item.TYPE_WALL:I.amount=128*g;try{r=new THREE.ExtrudeGeometry(t,I)}catch(a){return void console.log(a.stack)}if(i&&l)P=this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_SKIES),c=P.uniforms;else{var y=i?1:0;P=s[y]instanceof THREE.ShaderMaterial?s[y]:this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_WALLS),c=P.uniforms,c&&c.ceiling&&(c.ceiling.value=i?1:0),this.setTextures(e,P),this.setVertexColors(e,r)}h=new THREE.Mesh(r,P),this.updateMeshPosition(h,e,i);break;case SPLODER.Item.TYPE_PLATFORM:I.amount=Math.max(1,d)*g;try{r=new THREE.ExtrudeGeometry(t,I)}catch(a){return void console.log(a.stack)}P=s[0]||this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_WALLS),c=P.uniforms,c.ceiling.value=0,this.setTextures(e,P),this.setVertexColors(e,r),h=new THREE.Mesh(r,P),this.updateMeshPosition(h,e);break;case SPLODER.Item.TYPE_LIQUID:if(i)r=new THREE.PlaneBufferGeometry(e.width*f,e.height*f,1),P=s[0]||this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_LIQUIDS),c=P.uniforms,c.ceiling.value=1,this.setTextures(e,P);else{I.amount=128*g;try{r=new THREE.ExtrudeGeometry(t,I)}catch(a){return void console.log(a.stack)}P=this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_WALLS),c=P.uniforms,c.ceiling.value=0,this.setTextures(e,P),this.setVertexColors(e,r)}h=new THREE.Mesh(r,P),this.updateMeshPosition(h,e,i);break;case SPLODER.Item.TYPE_PANEL:case SPLODER.Item.TYPE_ITEM:if(P=s[0]||this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_ITEMS),c=P.uniforms,O=this.assets.getTextureFrames(SPLODER.SceneAssets.TYPE_ITEMS,R[0]),m=3*O[2]||16,p=3*O[3]||16,e.type==SPLODER.Item.TYPE_PANEL){var _=m/p;m=T>=D?T:D,p=m/_,m*=f,p*=f}r=new THREE.PlaneGeometry(m,p,1),c.nofollow.value=e.type==SPLODER.Item.TYPE_PANEL&&T!=D?1:0,this.setTextures(e,P),this.setVertexColors(e,r),h=new THREE.Mesh(r,P),this.updateMeshPosition(h,e);break;case SPLODER.Item.TYPE_BIPED:P=s[0]||this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_BIPEDS),c=P.uniforms,c.selected.value=this.model.itemWithIdIsSelected(e.id)?1:0;var w=e.getAttrib(SPLODER.Biped.PROPERTY_ITEMFRAME_RIGHT),v=e.getAttrib(SPLODER.Biped.PROPERTY_ITEMFRAME_LEFT);if(w>=0){var A=s[1]||this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_BIPEDS);this.assets.setAltTexture(A,SPLODER.SceneAssets.TYPE_ITEMS);var M=this.assets.getTextureFrames(SPLODER.SceneAssets.TYPE_ITEMS,w);A.uniforms.frames.value=M.concat(M,M)}if(v>=0){var N=s[2]||this.assets.getNewMaterial(SPLODER.SceneAssets.TYPE_BIPEDS);this.assets.setAltTexture(N,SPLODER.SceneAssets.TYPE_ITEMS);var x=this.assets.getTextureFrames(SPLODER.SceneAssets.TYPE_ITEMS,v);N.uniforms.frames.value=x.concat(x,x)}u=R[0],O=this.assets.getTextureFrames(SPLODER.SceneAssets.TYPE_BIPEDS,u);var Y=(new SPLODER.Biped).initWithRectAndMaterial(e,P,O[0]||0,O[1]||0);Y.setItemMaterials(A,M,N,x),Y.build(),h=Y.mesh;var C=this;Y.geometries.forEach(function(t){C.setVertexColors(e,t)}),this.updateMeshPosition(h,e)}h&&c&&(this.scene.add(h),this.sceneMeshes.push(h),this.sceneMeshesById[e.id]?this.sceneMeshesById[e.id].push(h):this.sceneMeshesById[e.id]=[h],this.sceneUniforms.push(c),this.sceneUniformsById[e.id]?this.sceneUniformsById[e.id].push(c):this.sceneUniformsById[e.id]=[c])}},SPLODER.SceneModel.prototype.placeMesh=function(e,t,i,s,o,n,a,r){e.userData.rect=t,e.position.set(i,s,o),isNaN(n)||(e.rotation.x=n),isNaN(r)||(e.rotation.y=r),isNaN(a)||(e.scale.z=a)},SPLODER.SceneModel.prototype.updateRectMeshes=function(e,t,i){if(e instanceof SPLODER.Item){var s=this.removeMeshesById([e],i);if(this.buildMesh(e,null,!1,s),(e.type==SPLODER.Item.TYPE_LIQUID||e.type==SPLODER.Item.TYPE_WALL&&e.getAttrib(SPLODER.Item.PROPERTY_CEIL))&&this.buildMesh(e,null,!0,s),t&&e.numChildren)for(var o=e.numChildren;o--;)this.updateRectMeshes(e.children[o],!0,i)}},SPLODER.SceneModel.prototype.removeShapes=function(e){for(var t,i,s,o,n,a=[this.shapes,this.ceilingShapes],r=2;r--;)if(t=a[r],t instanceof Array)for(s=e.length;s--;)for(o=e[s],i=t.length;i--;){n=t[i];try{if(n.userData.parentNode.id==o.id){t.splice(i,1);break}}catch(h){console.log("Error! Shape does not contain reference to rect.")}}},SPLODER.SceneModel.prototype.updateShapes=function(e){var t;e?(this.removeShapes(e),t=SPLODER.ShapeUtils.getShapes(e,!1,this.tilesize,this.model.items),this.shapes=this.shapes.concat(t),this.ceilingShapes=this.ceilingShapes.concat(SPLODER.ShapeUtils.getShapes(e,!0,this.tilesize,this.model.items))):(console.log("UPDATING SHAPES"),t=this.shapes=SPLODER.ShapeUtils.getShapes(this.model.items,!1,this.tilesize),this.ceilingShapes=SPLODER.ShapeUtils.getShapes(this.model.items,!0,this.tilesize));var i=this.shapes.length;for(this.shapesById=[];i--;){var s=this.shapes[i];s&&s.userData&&s.userData.parentNode&&(this.shapesById[s.userData.parentNode.id]=s[0])}return t},SPLODER.SceneModel.prototype.updateVertexColorsIntersecting=function(e){if(e instanceof SPLODER.Item){var t=this.model.getItemsIntersectingRect(e.x-1,e.y-1,e.width+2,e.height+2);if(t instanceof Array){var i,s=this;t.forEach(function(e){var t=s.sceneMeshesById[e.id];t instanceof Array&&t.length&&(e.type==SPLODER.Item.TYPE_BIPED?(i=t[0].userData.biped,i.geometries.forEach(function(t){s.setVertexColors(e,t)})):s.setVertexColors(e,t[0].geometry))})}}},SPLODER.SceneModel.prototype.updateMeshesNear=function(e,t){if(e instanceof Array){if(e.length>16||e.length>.5*this.model.items.length)return void this.setDirty();var i=SPLODER.ShapeUtils.getBounds(e);if(i){var s=this.model.getItemsIntersectingRect(i.x-8,i.y-8,i.width+16,i.height+16);if(s&&s.length){SPLODER.ShapeUtils.sortByAreaDesc(s),this.updateShapes(s),this.assets.setLightMapDirty();for(var o=s.length;o--;)this.updateRectMeshes(s[o],!1,t)}}}},SPLODER.SceneModel.prototype.updateLightMap=function(e){this.assets.updateLightMap(this.model,this.shapes,e)},SPLODER.SceneModel.prototype.setSkyColor=function(e,t){e&&!t&&(t=e.getHex()),this.scene.fog=new THREE.Fog(t,1200,2400),this.renderer.setClearColor(t)},SPLODER.SceneModel.prototype.updateModel=function(){if(this.isDirty){this.updateShapes();for(var e,t,i=this.scene.children.length;i--;)t=this.scene.children[i],t.hasOwnProperty("children")&&t.children.length>0?this.scene.remove(t):t instanceof THREE.Mesh&&(this.scene.remove(t),t.geometry.dispose());this.sceneMeshes=[],this.sceneMeshesById=[],this.sceneUniforms=[],this.sceneUniformsById=[];var s,o,n=this.shapes,a=this.ceilingShapes;for(e=n.length;e--;)s=n[e],o=s.userData.parentNode,!o||o.width<=0||o.height<=0||this.buildMesh(o,s);for(e=a.length;e--;)s=a[e],o=s.userData.parentNode,o.width<=0||o.height<=0||this.buildMesh(o,s,!0);for(e=n.length;e--;)s=n[e],o=s.userData.parentNode,o&&o.type==SPLODER.Item.TYPE_LIQUID&&this.buildMesh(o,s,!0);var r=this.model.items;for(e=r.length;e--;)o=r[e],(o.type==SPLODER.Item.TYPE_ITEM||o.type==SPLODER.Item.TYPE_BIPED||o.type==SPLODER.Item.TYPE_PANEL)&&this.buildMesh(o);this.isDirty=!1,this.assets.forcedUpdateOnly||this.assets.setLightMapDirty()}},SPLODER.SceneModel.prototype.update=function(){this.isDirty&&this.updateModel(),this.updateLightMap()},SPLODER.SceneModel.prototype.onError=function(e){console.log("Triangulation error in rect",e.id)};var Stats=function(){var e=Date.now(),t=e,i=0,s=1/0,o=0,n=0,a=1/0,r=0,h=0,E=0,l=document.createElement("div");l.id="stats",l.addEventListener("mousedown",function(e){e.preventDefault(),S(++E%2)},!1),l.style.cssText="width:80px;opacity:0.9;cursor:pointer";var d=document.createElement("div");d.id="fps",d.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",l.appendChild(d);var R=document.createElement("div");R.id="fpsText",R.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",R.innerHTML="FPS",d.appendChild(R);var P=document.createElement("div");for(P.id="fpsGraph",P.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",d.appendChild(P);74>P.children.length;){var c=document.createElement("span");c.style.cssText="width:1px;height:30px;float:left;background-color:#113",P.appendChild(c)}var O=document.createElement("div");O.id="ms",O.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",l.appendChild(O);var u=document.createElement("div");u.id="msText",u.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",u.innerHTML="MS",O.appendChild(u);var L=document.createElement("div");for(L.id="msGraph",L.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0",O.appendChild(L);74>L.children.length;)c=document.createElement("span"),c.style.cssText="width:1px;height:30px;float:left;background-color:#131",L.appendChild(c);var S=function(e){switch(E=e){case 0:d.style.display="block",O.style.display="none";break;case 1:d.style.display="none",O.style.display="block"}};return{REVISION:12,domElement:l,setMode:S,begin:function(){e=Date.now()},end:function(){var E=Date.now();i=E-e,s=Math.min(s,i),o=Math.max(o,i),u.textContent=i+" MS ("+s+"-"+o+")";var l=Math.min(30,30-30*(i/200));return L.appendChild(L.firstChild).style.height=l+"px",h++,E>t+1e3&&(n=Math.round(1e3*h/(E-t)),a=Math.min(a,n),r=Math.max(r,n),R.textContent=n+" FPS ("+a+"-"+r+")",l=Math.min(30,30-30*(n/100)),P.appendChild(P.firstChild).style.height=l+"px",t=E,h=0),E},update:function(){e=this.end()}}};"object"==typeof module&&(module.exports=Stats),SPLODER.PreviewControlsFirstPerson=function(e,t,i,s,o){this.camera=e,this.model=t,this.sceneModel=i,this.tilesize=s||0,this.tilesizeHalf=.5*this.tilesize;var n=this.camera.position;this.target=new THREE.Object3D,this.target.position.x=n.x,this.target.position.y=n.y,this.target.position.z=n.z-2e3,this.quat=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),this.domElement=void 0!==o?o:document,this.enabled=!0,this.movementSpeed=1,this.lookSpeed=.005,this.shiftKey=!1,this.lookVertical=!0,this.autoForward=!1,this.activeLook=!1,this.heightSpeed=!1,this.heightCoef=0,this.heightMin=0,this.heightMax=1,this.constrainVertical=!1,this.verticalMin=0,this.verticalMax=Math.PI,this.autoSpeedFactor=0,this.autoTracking=!0,this.startMouseX=0,this.startMouseY=0,this.mouseX=0,this.mouseY=0,this.touchX=0,this.touchY=0,this.numTouches=0,this.startLat=0,this.startLon=0,this.lat=0,this.lon=0,this.phi=1.82,this.theta=-1.57,this.moveForward=!1,this.moveBackward=!1,this.moveLeft=!1,this.moveRight=!1,this.viewHalfX=0,this.viewHalfY=0,this.domElement!==document&&this.domElement.setAttribute("tabindex","-1");var a,r=this;this.handleResize=function(){this.domElement===document?(this.viewHalfX=window.innerWidth/2,this.viewHalfY=window.innerHeight/2):(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2)},this.onMouseDown=function(e){this.enabled!==!1&&(this.domElement!==document&&this.domElement.focus(),this.startMouseX=e.clientX,this.startMouseY=e.clientY,this.startLon=this.lon,this.startLat=this.lat,this.activeLook=!0,a=!1)},this.onMouseUp=function(e){this.enabled!==!1&&(e&&(e.preventDefault(),e.stopPropagation()),this.activeLook=!1)},this.onMouseMove=function(e){this.enabled!==!1&&(this.domElement===document?(this.mouseX=e.pageX,this.mouseY=e.pageY):(this.mouseX=e.clientX,this.mouseY=e.clientY))},this.onTouchStart=function(e){this.numTouches=e.touches.length,this.touchX=e.clientX=e.touches[0].clientX,this.touchY=e.clientY=e.touches[0].clientY,this.startMouseX=e.clientX,this.startMouseY=e.clientY,this.startLon=this.lon,this.startLat=this.lat,this.activeLook=!1},this.onTouchMove=function(e){e.touches.length<this.numTouches||(this.scroll(3*(this.touchX-e.touches[0].clientX),2*(this.touchY-e.touches[0].clientY)),this.touchX=e.touches[0].clientX,this.touchY=e.touches[0].clientY,e.preventDefault())},this.onTouchEnd=function(){this.activeLook=!1},this.scroll=function(e,t){if(this.enabled!==!1){e=Math.max(-8,Math.min(8,e)),t=Math.max(-8,Math.min(8,t)),this.checkOrbit();var i=this.camera.position.y;this.shiftKey||this.numTouches>1||a?(this.camera.translateX(0-e),this.shiftKey||this.numTouches>1?this.camera.translateY(t):this.camera.translateZ(0-t)):(this.target.lookAt(this.camera.position),this.target.translateX(0-30*e),this.camera.translateZ(0-t),this.updateRotations(),this.updateTarget()),this.shiftKey||this.numTouches>1||(this.camera.orbitMode?this.camera.gotoPosition(0/0,i,0/0):this.camera.position.y=i),this.collisionCheck()}},this.collisionCheck=function(){var e=this.camera.orbitMode||this.camera.flyMode;if(e){var t=SPLODER.Physics.elevationCheck(this.model,this.camera.position.y,this.camera.position,1,!0,!1);t!=this.camera.position.y&&-1!=t&&(this.setOrbitMode(!1),this.camera.flyMode=!1,e=!1)}var i=SPLODER.Physics.collisionCheck(this.model,this.camera.destination,e,!0);this.camera["goto"](i)},Mousetrap.bind(["w","a","s","d","up","down","left","right","shift+w","shift+a","shift+s","shift+d","shift+up","shift+down","shift+left","shift+right"],function(e){if(r.enabled!==!1)switch(e.preventDefault(),e.keyCode){case 38:case 87:e.shiftKey?r.moveUp=!0:r.moveForward=!0;break;case 37:case 65:r.moveLeft=!0;break;case 40:case 83:e.shiftKey?r.moveDown=!0:r.moveBackward=!0;break;case 39:case 68:r.moveRight=!0;break;case 82:r.moveUp=!0;break;case 70:r.moveDown=!0}},"keydown"),Mousetrap.bind(["w","a","s","d","up","down","left","right","shift+w","shift+a","shift+s","shift+d","shift+up","shift+down","shift+left","shift+right"],function(e){if(r.enabled!==!1)switch(e.keyCode){case 38:case 87:r.moveForward=r.moveUp=!1;break;case 37:case 65:r.moveLeft=!1;break;case 40:case 83:r.moveBackward=r.moveDown=!1;break;case 39:case 68:r.moveRight=!1;break;case 82:r.moveUp=!1;break;case 70:r.moveDown=!1}},"keyup"),this.update=function(e,t){if(this.enabled!==!1){if(this.heightSpeed){var i=THREE.Math.clamp(this.camera.position.y,this.heightMin,this.heightMax),s=i-this.heightMin;this.autoSpeedFactor=e*s*this.heightCoef}else this.autoSpeedFactor=0;var o=e*this.movementSpeed,n=this.camera.position.y;if((this.moveForward||this.autoForward&&!this.moveBackward)&&this.camera.translateZ(-(o+this.autoSpeedFactor)),this.moveBackward&&this.camera.translateZ(o),this.shiftKey||this.numTouches>1||a)this.moveLeft&&this.camera.translateX(-o),this.moveRight&&this.camera.translateX(o);else if(this.moveLeft||this.moveRight){this.updateTarget(),this.target.lookAt(this.camera.position);var r=36*o*(1-this.camera.easeFactor);this.target.translateX(this.moveLeft?0-r:r),this.updateRotations(),this.updateTarget()}this.moveUp&&this.camera.translateY(o),this.moveDown&&this.camera.translateY(-o),this.activeLook&&(this.lon=(this.mouseX-this.startMouseX)/this.viewHalfX*180,this.lon+=this.startLon,this.lookVertical&&(this.lat=85*(0-(this.mouseY-this.startMouseY)/this.viewHalfY),this.lat+=this.startLat),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=THREE.Math.degToRad(90-this.lat),this.theta=THREE.Math.degToRad(this.lon),this.phi=THREE.Math.mapLinear(this.phi,0,Math.PI,this.verticalMin,this.verticalMax)),(this.moveUp||this.moveDown||this.moveLeft||this.moveRight||this.moveForward||this.moveBackward||this.activeLook)&&(this.checkOrbit(),this.shiftKey||this.moveUp||this.moveDown||this.numTouches>1||(this.camera.orbitMode?this.camera.gotoPosition(0/0,n,0/0):this.camera.position.y=n),a||this.updateTarget(),t=!0),t&&this.collisionCheck()}},this.checkOrbit=function(){this.phi<.4||this.phi>2.8},this.setOrbitMode=function(e){a=this.camera.orbitMode=e,a||(this.camera.level(),this.updateTarget())},this.reset=function(){this.camera.level()},this.onCameraChanged=function(e,t){this.target.position.copy(t),this.updateRotations()},this.updateRotations=function(){var e=this.camera.position,t=new THREE.Vector3;t.copy(e).sub(this.target.position),t.applyQuaternion(this.quat),this.theta=Math.atan2(0-t.z,0-t.x),this.lon=THREE.Math.radToDeg(this.theta),this.phi=Math.atan2(Math.sqrt(t.x*t.x+t.z*t.z),0-t.y),this.lat=0-(THREE.Math.radToDeg(this.phi)-90)},this.updateTarget=function(){if(!this.camera.orbitMode){var e=this.target.position,t=this.camera.position;this.autoTracking&&(this.phi-=.5*Math.PI,this.phi*=.9,this.phi+=.5*Math.PI),e.x=t.x+2e3*Math.sin(this.phi)*Math.cos(this.theta),e.y=t.y+2e3*Math.cos(this.phi),e.z=t.z+2e3*Math.sin(this.phi)*Math.sin(this.theta),this.camera.lastTargetRectId="",this.camera.lookAt(e)}},this.focusOn=function(e){if(e&&e.userData.rect){var i=e.userData.rect,s=e.position.clone(),o=i.getAttrib(SPLODER.Item.PROPERTY_CEIL),n=i.getAttrib(SPLODER.Item.PROPERTY_CEILDEPTH),a=Math.min(n,i.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH));(i.type==SPLODER.Item.TYPE_WALL||i.type==SPLODER.Item.TYPE_PLATFORM)&&(s.x+=i.width*this.tilesize*.5,s.z+=i.height*this.tilesize*.5),i.type==SPLODER.Item.TYPE_WALL&&o&&n==a&&(s.y=Math.min(n*this.tilesizeHalf,this.camera.position.y)),i.type==SPLODER.Item.TYPE_PLATFORM&&(s.y=i.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH)*this.tilesizeHalf),i.type==SPLODER.Item.TYPE_BIPED&&(s.y+=8*this.tilesizeHalf),this.camera.lookAt(s),this.setOrbitMode(!0);var r=SPLODER.Geom.distanceBetweenXZ(this.camera.position,s);if(r>1024)return void this.visit(i,s,r);var h=SPLODER.Physics.rayCast3db(t,this.camera.position,s);if(h&&h.length>0&&h[0].rect!=i){var E=this.visit(i,s,r);console.log("CAMERA SOLUTION",E)}}},this.blur=function(){this.setOrbitMode(!1),this.updateTarget()},this.getSourceRing=function(e,t,i,s,o){s=s||10,o=o||0;var n,a,r,h=Math.max(4*this.tilesize,Math.min(i,Math.max(e.height,e.width)*this.tilesize*.5)),E=[],l=e.height+e.width>0?Math.max(.25,Math.min(4,e.height/e.width)):1,d=h+s*this.tilesize,R=h*l+s*this.tilesize;for(n=0;12>n;n++)a=30*n*Math.PI/180,r=new THREE.Vector3(Math.sin(a)*d,t.y+6*this.tilesizeHalf,Math.cos(a)*R),r.x+=t.x,r.y+=o,r.z+=t.z,E.push(r);for(E.sort(function(e,t){return e.z<t.z?1:e.z>t.z?-1:0}),n=0;4>n;n++)a=(180+90*n)*Math.PI/180,r=new THREE.Vector3(Math.sin(a)*d,t.y+6*this.tilesizeHalf,Math.cos(a)*R),r.x+=t.x,r.y+=o,r.z+=t.z,E.unshift(r);for(n=0;n<E.length;n++){r=E[n];var P=this.camera.getEyeLevel(r);r.y=-1!=P?P:(e.getAttrib(SPLODER.Item.PROPERTY_FLOORDEPTH)+8)*this.tilesizeHalf}for(n=E.length;n--;){r=E[n];var c=SPLODER.Physics.rayCast3db(this.model,r,t,this.tilesize,SPLODER.Item.TYPE_WALL,e);c&&c.length>0&&c[0].rect!=e?E.splice(n,1):(c=SPLODER.Physics.pointInWallCheck(this.model,r),c&&E.splice(n,1))}return E.length?E:!1},this.visit=function(e,t,i){var s=this.getSourceRing(e,t,i,12)||this.getSourceRing(e,t,i,8)||this.getSourceRing(e,t,i,4,2);return s.length?(this.camera["goto"](s[0]),!0):!1},this.domElement.addEventListener("mousedown",SPLODER.bind(this,this.onMouseDown),!1),this.domElement.addEventListener("mousemove",SPLODER.bind(this,this.onMouseMove),!1),this.domElement.addEventListener("mouseup",SPLODER.bind(this,this.onMouseUp),!1),this.domElement.addEventListener("mouseout",SPLODER.bind(this,this.onMouseUp),!1),this.domElement.addEventListener("touchstart",SPLODER.bind(this,this.onTouchStart),!1),this.domElement.addEventListener("touchmove",SPLODER.bind(this,this.onTouchMove),!1),this.domElement.addEventListener("touchend",SPLODER.bind(this,this.onTouchEnd),!1),this.handleResize(),this.startLon=this.lon=270},SPLODER.PreviewCamera=function(e,t,i,s){THREE.PerspectiveCamera.call(this,e,t,i,s),this.easeFactor=.1;var o=1;this.model=null,this.tilesize=null,this.tilesizeHalf=null,this.changed=new signals.Signal,this.completed=new signals.Signal,this.idle=!0,this.orbitMode=!1,this.flyMode=!1;var n=new THREE.Camera;n.position.copy(this.position);var a=new THREE.Vector3,r=this.position.clone().setZ(this.position.z-2e3);a.copy(r);var h=new THREE.Vector3,E=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,R=this,P=THREE.PerspectiveCamera.prototype;this.setModel=function(e,t){this.model=e,this.tilesize=t||32,this.tilesizeHalf=.5*this.tilesize},this.setPosition=function(e,t,i){isNaN(e)||(this.position.setX(e),n.position.setX(e)),isNaN(t)||(this.position.setY(t),n.position.setY(t)),isNaN(i)||(this.position.setZ(i),n.position.setZ(i))},this.gotoPosition=function(e,t,i){isNaN(e)||n.position.setX(e),isNaN(t)||n.position.setY(t),isNaN(i)||n.position.setZ(i),n.lookAt(r)},this["goto"]=function(e,t){e&&(this.gotoPosition(e.x,e.y,e.z),n.lookAt(r),isNaN(t)||n.translateZ(t))},this.translateTo=function(e,t,i){var s=new THREE.Vector3(e-n.position.x,t-n.position.y,i-n.position.z);isNaN(s.x)&&(s.x=0),isNaN(s.y)&&(s.y=0),isNaN(s.y)&&(s.z=0),n.position.add(s),r.add(s),n.lookAt(r)},this.setTarget=function(e,t,i){isNaN(e)||r.setX(e),isNaN(t)||r.setY(t),isNaN(i)||r.setZ(i),n.lookAt(r)},this.lookAt=function(e){r=e.clone(),n.lookAt(r)},this.level=function(){r.y=n.position.y,n.lookAt(r)},this.setZoom=function(e){n.zoom=e},this.translateX=function(e){n.translateX(e)},this.translateY=function(e){n.translateY(e)},this.translateZ=function(e){n.translateZ(e)},this.getRectsAtLocation=function(e,t){var i=e.clone().divideScalar(this.tilesize);return this.model.getItemsUnderPoint(i.x,i.z,0,null,!1,t)},this.getEyeLevel=function(e){var t=this.orbitMode||this.flyMode,i=n.position.y;return SPLODER.Physics.elevationCheck(this.model,i,e,0,t,!1)},this.update=function(){l.copy(this.position).sub(n.position),d.copy(r).sub(a);var e=l.lengthSq(),t=d.lengthSq();if(e>o||t>o){this.idle=!1;var i=this.easeFactor,s=this.easeFactor;this.position.lerp(n.position,i),a.lerp(r,s),P.lookAt.call(this,a),this.position.y=Math.max(0,Math.min(2048,this.position.y)),h.copy(this.position),E.copy(a),this.changed.dispatch(h,E)}else this.idle||(h.copy(this.position),E.copy(a),this.idle=!0,this.completed.dispatch(h,E))},Object.defineProperty(this,"destination",{get:function(){return n.position.clone()}}),Object.defineProperty(this,"targetDestination",{get:function(){return r.clone()}}),Object.defineProperty(this,"source",{get:function(){return R.position.clone()}}),Object.defineProperty(this,"target",{get:function(){return r.clone()}}),this.alignMaskObject=function(e,t){t=t||-32,e.position.copy(a),e.position.y=this.position.y,e.lookAt(this.position),e.position.copy(this.position),e.translateZ(t)}},SPLODER.PreviewCamera.prototype=Object.create(THREE.PerspectiveCamera.prototype),SPLODER.PreviewCamera.prototype.constructor=SPLODER.PreviewCamera,SPLODER.Broadcaster=function(){this.hasOwnProperty("_listeners")||(this._listeners=[]),this.hasOwnProperty("_callbacks")||(this._callbacks=[]),this.addListener=function(e,t,i){this._listeners.push(e),this._callbacks.push(i&&t?this.bind(i,t):t?t:null)},this.bind=function(e,t){return function(){t.apply(e,arguments)}},this.removeListener=function(e){for(var t=this._listeners.length;t--;)this._listeners[t]===e&&(this._listeners.splice(t,1),this._callbacks.splice(t,1))},this.broadcast=function(e,t){if(0!==this._listeners.length)for(var i,s=0;s<this._listeners.length;s++)i=this._listeners[s],"string"==typeof i?i!==e&&"all"!==i||null===this._callbacks[s]||(t&&(t.type=e),this._callbacks[s](t)):i[e]&&i[e](t)},this.mousedown||(this.mousedown=function(e){this.broadcast("mousedown",e)}),this.mousemove||(this.mousemove=function(e){this.broadcast("mousemove",e)}),this.mouseover||(this.mouseover=function(e){this.broadcast("mouseover",e)}),this.mouseup||(this.mouseup=function(e){this.broadcast("mouseup",e)}),this.mouseupoutside||(this.mouseupoutside=function(e){this.broadcast("mouseupoutside",e)}),this.mouseout||(this.mouseout=function(e){this.broadcast("mouseout",e)}),this.touchstart||(this.touchstart=function(e){this.broadcast("touchstart",e)}),this.touchmove||(this.touchmove=function(e){this.broadcast("touchmove",e)}),this.touchend||(this.touchend=function(e){this.broadcast("touchend",e)}),this.touchendoutside||(this.touchendoutside=function(e){this.broadcast("touchendoutside",e)})},SPLODER.GameView=function(){this.domElement=null,this.renderer=null,this.model=null,this.envModel=null,this.sceneAssets=null,this.loadComplete=null,this.selected=null,this.selectedMeshId=null,this.shiftKey=!1,this.width=0,this.height=0,this.tilesize=32,this.tilesizeHalf=16,this.sceneModel=null,this.pixelRatio=null,this.sceneMeshesCameraAligned=null,this.camera=null,this.cameraDummy=null,this.cameraAngle=null,this.camControls=null,this.raycaster=null,this.mouse=null,this.isDirty=!0,this.ready=!1;var e=!0,t=this;Object.defineProperty(this,"autoCamera",{get:function(){return e},set:function(i){this.selected.dispatch([SPLODER.ACTION_DESELECT]),e=i?!0:!1,t.camControls.autoTracking=e}})},SPLODER.GameView.prototype.initWithModelsAndSize=function(e,t,i,s,o,n){return this.model=e,this.envModel=t,this.width=i,this.height=s,this.tilesize=o||32,this.tilesizeHalf=.5*this.tilesize,this.pixelRatio=n||1,this.selected=new signals.Signal,this.raycaster=new THREE.Raycaster,this.mouse=new THREE.Vector2,this.sceneAssets=(new SPLODER.SceneAssets).init(this.tilesize,this.pixelRatio),this.loadComplete=new signals.Signal,this},SPLODER.GameView.prototype.setSize=function(e,t){this.width=e,this.height=t,this.camera.aspect=e/t,this.camera.updateProjectionMatrix()},SPLODER.GameView.prototype.build=function(e,t){this.domElement=e,this.renderer=t,this.camera=new SPLODER.PreviewCamera(90,this.width/this.height,10,2400),this.cameraAngle=new THREE.Vector3,this.sceneMeshesCameraAligned=[],this.sceneAssets.prepared.addOnce(this.onAssetsPrepared,this),this.sceneAssets.load()},SPLODER.GameView.prototype.onAssetsPrepared=function(){this.sceneAssets.assignUniformValue("cameraAngle",this.cameraAngle),this.buildScene(),this.loadComplete.dispatch(!0),this.sceneAssets.forcedUpdateOnly=!1,this.sceneModel.updateLightMap(!0)},SPLODER.GameView.prototype.buildScene=function(){this.sceneModel=(new SPLODER.SceneModel).initWithModelsAndSize(this.model,this.envModel,this.sceneAssets,this.tilesize),this.sceneModel.build(this.renderer),this.sceneModel.watchModel(),this.camera.setModel(this.model,this.tilesize),this.camera.setPosition(0,72*this.tilesizeHalf,10*this.tilesize),this.camera.setTarget(0,76*this.tilesizeHalf,10*this.tilesize-2e3),this.camera.easeFactor=.15;var e=this.sceneModel.scene;e.add(this.camera),this.cameraDummy=new THREE.Camera,e.add(this.cameraDummy);var t=this.camControls=new SPLODER.PreviewControlsFirstPerson(this.camera,this.model,this.sceneModel,this.tilesize,this.domElement);t.lookSpeed=.1,t.movementSpeed=800,t.noFly=!0,t.lookVertical=!0,t.constrainVertical=!0,t.verticalMin=.7,t.verticalMax=2.2,this.camera.changed.add(t.onCameraChanged,t),this.ready=!0,t.collisionCheck(),this.updatePreview(),this.model.changed.add(this.onModelChanged,this)},SPLODER.GameView.prototype.onMouseDown=function(e){this.mouse.x=e.offsetX,this.mouse.y=e.offsetY},SPLODER.GameView.prototype.onMouseUp=function(e){if(Math.abs(this.mouse.x-e.offsetX)+Math.abs(this.mouse.y-e.offsetY)<10){var t=new THREE.Vector2;t.x=this.mouse.x/this.width*2-1,t.y=-(this.mouse.y/this.height*2)+1,this.raycaster.setFromCamera(t,this.camera);for(var i=this.raycaster.intersectObjects(this.sceneModel.scene.children,!0),s=0;s<i.length;s++)if(i[s].hasOwnProperty("object")&&i[s].object instanceof THREE.Mesh){var o,n=i[s].object;if(n.userData.hasOwnProperty("rect")){if(o=n.userData.rect,!this.model.itemWithIdIsSelected(o.id,!0))return this.selectedMeshId=n.uuid,void this.selected.dispatch([SPLODER.ACTION_SELECT_ITEM,o]);break}}this.selected.dispatch([SPLODER.ACTION_DESELECT])}},SPLODER.GameView.prototype.scroll=function(e,t){this.camControls.scroll(e,t)},SPLODER.GameView.prototype.setDirty=function(){this.isDirty=!0},SPLODER.GameView.prototype.onModelChanged=function(e,t,i){if(this.sceneModel){this.isDirty=!0;var s=this.model.selection.length,o=this.tilesize,n=this.tilesizeHalf;if(this.autoCamera&&((0==s||e==SPLODER.ACTION_SELECTION_DELETE)&&this.camControls.blur(),!(e>=SPLODER.ACTION_SELECTION_DUPLICATE&&e<=SPLODER.ACTION_CLIPBOARD_PASTE))){if(t instanceof Array)if(1==t.length)t=t[0];else if(t.length){var a=SPLODER.ShapeUtils.getBounds(this.model.selection);a&&this.camera.setTarget((a.x+.5*a.width)*o,a.depth*n+2*o,(a.y+.5*a.height)*o)}if(e==SPLODER.ACTION_CREATE&&t instanceof SPLODER.Item&&t.type==SPLODER.Item.TYPE_ITEM&&!this.sceneModel.hasObjectWithId(t.id)){var r=this,h=arguments;setTimeout(function(){r.onModelChanged.apply(r,h)},100)}var E=this.sceneModel.sceneMeshesById;if(t instanceof SPLODER.Item&&E[t.id])if(SPLODER.Geom.pointWithinRect(this.camera.position.x,this.camera.position.z,t,this.tilesize));else{var l=E[t.id];if(!l)return;var d;if(this.selectedMeshId&&(l[1]&&l[1].uuid==this.selectedMeshId?d=l[1]:l[0]&&l[0].uuid==this.selectedMeshId&&(d=l[0])),!d){var R=0;(i==SPLODER.Item.PROPERTY_CEILDEPTH||i==SPLODER.Item.PROPERTY_CEILTEXTURE||i==SPLODER.Item.PROPERTY_CEIL_SKY||i==SPLODER.Item.PROPERTY_TOPWALLTEXTURE||i==SPLODER.Item.PROPERTY_TOPWALLCORNICETEXTURE)&&(R=1),t.type==SPLODER.Item.TYPE_LIQUID&&i!=SPLODER.Item.PROPERTY_CEILTEXTURE&&i!=SPLODER.Item.PROPERTY_FLOORTEXTURE&&(R=R?0:1),d=E[t.id][R]}d&&this.camControls.focusOn(d)}this.selectedMeshId=null,this.setDirty()}}},SPLODER.GameView.prototype.updatePreview=function(){this.ready&&(this.isDirty=!1)},SPLODER.GameView.prototype.update=function(e){if(this.ready){var t=this.sceneModel.isDirty;this.sceneModel.update(),(this.isDirty||t)&&this.updatePreview();var s=this.cameraAngle;s.x=0,s.y=0,s.z=1,s.x=1,s.y=0,s.z=.1,s.normalize(),s.applyQuaternion(this.camera.quaternion),s.z<-1&&(s.z+=2),s.x=Math.atan(s.x)/Math.PI,s.y=Math.acos(s.y)/Math.PI,s.z=Math.asin(s.z)/Math.PI,this.camControls.update(e,t),this.sceneAssets.setTime(Date.now()/1e3%8),this.camera.update();var o,n=this.sceneMeshesCameraAligned;for(i=0;i<n.length;i++)o=n[i],this.cameraDummy.position.copy(this.camera.position),this.cameraDummy.position.y=o.position.y;this.testLiquidMask&&(this.camera.alignMaskObject(this.testLiquidMask,-24),this.testLiquidMask.position.y=Math.min(960,this.camera.position.y),this.testLiquidMask.visible=this.camera.position.y<=1088)}},SPLODER.GameView.prototype.render=function(e){e.render(this.sceneModel.scene,this.camera),this.isDirty=!1},SPLODER.Game=function(){SPLODER.Broadcaster.call(this),this.model=null,this.dispatcher=null,this.levels=null,this.levelsDispatcher=null,this.envModel=null,this.envDispatcher=null,this.tagModel=null,this.tagDispatcher=null,this.flowModel=null,this.flowDispatcher=null,this.width=0,this.height=0,this.container=null,this.stage3d=null,this.renderer3d=null,this.pixelRatio=null,this.stats=null,this.clock=null,this.gameView=null,this.history=null,this.destroyed=!1
},SPLODER.Game.prototype.initWithSize=function(e,t){this.model=(new SPLODER.ItemStore).init(),this.envModel=(new SPLODER.EnvModel).init(),this.levels=(new SPLODER.Levels).initWithModels(this.model,this.envModel);var i=this.width=Math.min(800,window.innerWidth),s=this.height=Math.min(600,window.innerHeight);s>=768&&this.bottomPanelTab&&(panelHeight-=270),this.tilesize=e,this.pixelRatio=t||1,this.dispatcher=new signals.Signal,this.model.registerWithDispatcher(this.dispatcher),this.dispatcher.add(this.onModelChanged,this),this.model.changed.add(this.onModelChanged,this),this.levelsDispatcher=new signals.Signal,this.levels.registerWithDispatcher(this.levelsDispatcher),this.levels.changed.add(this.onLevelsChanged,this),this.envDispatcher=new signals.Signal,this.envModel.registerWithDispatcher(this.envDispatcher),this.envModel.changed.add(this.onEnvModelChanged,this),this.gameView=(new SPLODER.GameView).initWithModelsAndSize(this.model,this.envModel,i,s,32,this.pixelRatio),this.gameView.selected.add(this.onPreviewSelect,this),this.tagModel=(new SPLODER.TagModel).init(),this.tagDispatcher=new signals.Signal,this.tagModel.registerWithDispatcher(this.tagDispatcher),this.flowModel=(new SPLODER.FlowStore).init(),this.flowDispatcher=new signals.Signal,this.flowModel.registerWithDispatcher(this.flowDispatcher),this.history=(new SPLODER.ModelHistory).init(),this.history.registerModel(this.model),this.history.registerModel(this.levels),this.history.registerModel(this.flowModel),this.history.registerModel(this.tagModel),this.history.registerModel(this.envModel),window.addEventListener("mouseup",SPLODER.bind(this,this.onMouseUp),!1),window.addEventListener("keyup",SPLODER.bind(this,this.onMouseUp),!1),window.addEventListener("touchend",SPLODER.bind(this,this.onMouseUp),!1)},SPLODER.Game.prototype.build=function(e){this.container=document.getElementById(e);var t=this.width=Math.min(800,window.innerWidth),i=this.height=Math.min(600,window.innerHeight),s=Math.floor(.5*t),o=Math.floor(i)-96;if(i>=768&&this.bottomPanelTab&&(o-=270),this.container){var n=document.getElementById("drawingarea"),a=this,r=function(e){e=window.event||e;var t=null,i=null;"wheelDeltaX"in e?(t=.25*e.wheelDeltaX,i=.25*e.wheelDeltaY):"deltaX"in e&&(t=0-.25*e.deltaX,i=0-.25*e.deltaY),a.scroll(t,i,e)},h=this.container;"addEventListener"in h?(h.addEventListener("mousewheel",r,!1),h.addEventListener("wheel",r,!1)):h.attachEvent("onmousewheel",r),n=document.getElementById("gameview"),this.clock=new THREE.Clock;var E=this.renderer3d=new THREE.WebGLRenderer({precision:"highp",premultipliedAlpha:!1,antialias:!1,alpha:!1,overdraw:1});n.style.cursor="cell",E.premultipliedAlpha=!0,E.sortObjects=!1,E.setPixelRatio(this.pixelRatio),E.setSize(s,o),E.setClearColor(0,1),this.stage3d=E.domElement,n.appendChild(this.stage3d),this.gameView.loadComplete.addOnce(this.onLoadComplete,this),this.gameView.build(this.stage3d,E),"addEventListener"in h?(n.addEventListener("mousewheel",r,!1),n.addEventListener("wheel",r,!1)):n.attachEvent("onmousewheel",r),E.domElement.addEventListener("mouseup",SPLODER.bind(this.gameView,this.gameView.onMouseUp),!1),E.domElement.addEventListener("mousedown",SPLODER.bind(this.gameView,this.gameView.onMouseDown),!1);var l=function(e){a.drawingArea.shiftKey=a.gameView.shiftKey=a.gameView.camControls.shiftKey=a.flowArea.shiftKey=e.shiftKey,e.shiftKey&&(a.gameView.camera.flyMode=!0)},d=function(){a.gameView.shiftKey=a.gameView.camControls.shiftKey=a.gameView.camera.flyMode=!1};Mousetrap.bind("shift",l,"keydown"),Mousetrap.bind("shift",l,"keyup"),window.addEventListener("blur",d);var R=this.stats=new Stats;R.setMode(0),R.domElement.style.position="absolute",R.domElement.style.left="0",R.domElement.style.top="0",document.body.appendChild(R.domElement),this.onResize(!0)}},SPLODER.Game.prototype.onResize=function(e){console.log("RESIZE CALLED",window.orientation,e);var t=this.width=Math.min(800,window.innerWidth),i=this.height=Math.min(600,window.innerHeight);this.renderer3d.setPixelRatio(this.pixelRatio),this.renderer3d.setSize(t,i);var s=this;e&&setTimeout(function(){s.onResize()},1e3)},SPLODER.Game.prototype.start=function(){if(!this.started){this.gameView.sceneAssets.forcedUpdateOnly=!1;var e=this,t=function(){if(!e.destroyed){requestAnimationFrame(t),e.stats&&e.stats.begin();var i=e.gameView;i&&i.ready&&(i.update(e.clock.getDelta()),i.render(e.renderer3d),e.stats&&e.stats.end())}};this.updateButtonStates(),window.addEventListener("resize",SPLODER.bind(this,this.onResize),!1),window.addEventListener("orientationchange",SPLODER.bind(this,this.onResize),!1),window.scrollTo(0,1),this.started=!0,requestAnimationFrame(t)}},SPLODER.Game.prototype.scroll=function(e,t,i){if(i&&i.target&&i.target.parentNode){var s=i.target.parentNode.id;switch(s){case"gameview":this.gameView.scroll(e,t),i.preventDefault()}}},SPLODER.Game.prototype.onLoadComplete=function(){console.log("ASSETS LOAD COMPLETE"),this.dispatcher.dispatch("loadComplete")},SPLODER.Game.prototype.onModelChanged=function(){},SPLODER.Game.prototype.onLevelsChanged=function(e){(e==SPLODER.ACTION_CONTEXT_CHANGE||e==SPLODER.ACTION_CHANGE)&&(this.gameView.setDirty(),this.gameView.sceneModel&&this.gameView.sceneModel.setDirty())},SPLODER.Game.prototype.onEnvModelChanged=function(e){e&&this.envDispatcher.dispatch(e)},SPLODER.Game.prototype.onPreviewSelect=function(e){this.dispatcher.dispatch(e)},SPLODER.Game.prototype.onMouseUp=function(){},SPLODER.Game.prototype.updateButtonStates=function(e){var t;e instanceof Array&&(t=e[0])},SPLODER.Game.prototype.onButtonPress=function(e,t){if(!(void 0==e||t&&t.classList.contains("disabled"))){var i=e.split("-")[0],s=e.split("-")[1];switch(void 0==s&&(s=i,i=""),console.log(i,s),i){default:switch(s){case"fullscreen":var o=document.body;o.requestFullscreen?o.requestFullscreen():o.msRequestFullscreen?o.msRequestFullscreen():o.mozRequestFullScreen?o.mozRequestFullScreen():o.webkitRequestFullscreen&&o.webkitRequestFullscreen(),document.body.classList.add("fullscreen");break;case"exitfullscreen":document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),document.body.classList.remove("fullscreen")}}}};var perimSegments,holeSegments,game=new SPLODER.Game,viewport=document.querySelector("meta[name=viewport]"),vpWidth="device-width";window.innerWidth>1024&&(vpWidth=window.innerWidth<window.innerHeight?768:1024),viewport.setAttribute("content","width="+vpWidth+", user-scalable=no"),document.body.onload=function(){console.log("DOCUMENT LOADED");var e=window.screen.width>=1280?1:.5;game.initWithSize(16,e),game.build("game_container"),game.start(),game.dispatcher.addOnce(function(e){"loadComplete"==e&&(console.log("GAMEMAIN: ASSETS LOAD COMPLETED!"),game.model.unserialize("118,0,-51,9,28,25,[[@,75,73,@,@,@,@,@,@,@,@,20]]|216,0,21,9,28,25,[[@,75,73,@,@,46,9,@,@,@,@,20]]|32,0,-51,-24,27,25,[[@,75,73,@,@,@,@,@,@,@,@,20]]|215,0,21,-24,27,25,[[@,75,73,@,@,75,72,@,@,@,@,20]]|117,0,-49,12,25,21,[[@,68,87]]|214,0,23,12,25,21,[[@,68,87]]|213,0,22,-21,25,21,[[@,68,87]]|33,0,-50,-21,25,21,[[@,68,87]]|212,0,68,-14,9,44,[[@,83,83,@,@,10,@,@,10,10,@,@,@,@,@,1]]|61,0,-4,-14,9,44,[[@,83,83,@,@,79,70,@,@,@,@,@,@,@,@,1]]|140,0,-4,-13,8,42,[[@,64,85,@,@,78,@,@,@,@,@,10,3]]|52,0,-24,-14,20,11,[[@,80,80,@,@,78,70,@,@,@,@,240,1]]|211,0,48,-14,20,11,[[@,80,80,@,@,17,44,@,@,@,@,240,1]]|116,0,-23,19,19,11,[[@,80,80,@,@,78,71,@,@,@,@,240,1]]|210,0,49,19,19,11,[[@,80,80,@,@,17,44,@,@,@,@,240,1]]|209,0,48,-13,20,9,[[@,64,85,@,@,@,@,@,@,@,@,150,1]]|51,0,-24,-13,20,9,[[@,64,85,@,@,@,@,@,@,@,@,80,3]]|208,0,49,20,19,9,[[@,64,85,@,@,@,@,@,@,@,@,150,1]]|115,0,-23,20,19,9,[[@,64,85,@,@,@,@,@,@,@,@,90,3]]|206,2,30,17,12,12,[[@,60,@,@,@,@,@,@,@,@,@,@,@,66,1,@,@,1],@,[@,@,@,@,@,@,@,@,@,@,@,@,@,60]]|114,2,-42,17,12,12,[[@,60,@,@,@,@,@,@,@,@,@,@,@,66,0,@,@,1],@,[@,@,@,@,@,@,@,@,@,@,@,@,@,60]]|207,2,22,-20,12,12,[[@,55,@,@,@,@,@,@,@,@,@,@,@,66,0,@,@,1],@,[@,@,@,@,@,@,@,@,@,@,@,@,@,60]]|48,2,-50,-20,12,12,[[@,55,@,@,@,@,@,@,@,@,@,@,@,66,2,@,@,1],@,[@,@,@,@,@,@,@,@,@,@,@,@,@,60]]|205,0,29,1,14,8,[[@,79,79,@,@,@,@,@,@,@,@,10]]|204,0,68,15,8,14,[[@,64,85,@,@,@,@,@,@,@,@,150,4]]|121,0,-43,1,14,8,[[@,79,79,@,@,@,@,@,@,@,@,10]]|203,0,30,1,12,8,[[@,68,83]]|120,0,-42,1,12,8,[[@,68,83]]|202,0,68,-13,8,10,[[@,64,85,@,@,@,@,@,@,@,@,150,6]]|201,0,5,3,16,4,[[@,60,79,@,@,@,@,@,@,@,@,10]]|131,0,-67,3,16,4,[[@,60,79,@,@,@,@,@,@,@,@,10]]|231,0,15,14,6,9,[[@,83,83,@,@,18,18,@,@,@,@,10,3]]|110,0,-40,19,7,7,[[@,57,90,@,@,@,@,@,@,@,@,150,@,@,@,@,1]]|107,1,-49,26,7,7,[[@,75],@,[@,@,@,77,-24]]|196,0,68,-3,8,6,[[@,64,85,@,@,@,@,@,@,@,@,150,4]]|198,0,68,3,8,6,[[@,64,85,@,@,@,@,@,@,@,@,150,5]]|197,0,68,9,8,6,[[@,64,85,@,@,@,@,@,@,@,@,150,6]]|187,1,24,-7,7,6,[[@,73,1,@,@,87,87],@,[@,78]]|45,0,-43,-24,13,3,[[@,68,83]]|217,3,-43,-24,13,3,[[@,68,@,@,@,71]]|112,0,-42,9,12,3,[[@,68,83]]|200,0,33,20,6,6,[[@,57,101,@,@,53,@,@,@,@,@,50,8,@,@,@,0]]|195,0,30,9,12,3,[[@,68,83]]|65,1,-46,-17,6,6,[[@,75],@,[@,@,@,73,16]]|230,0,16,15,5,7,[[@,71,83]]|132,0,-67,7,16,2,[[@,75,75,@,@,@,@,@,@,@,@,10]]|193,0,5,7,16,2,[[@,75,75,@,@,@,@,@,@,@,@,10]]|192,0,5,1,16,2,[[@,75,75,@,@,@,@,@,@,@,@,10]]|134,0,-67,1,16,2,[[@,75,75,@,@,@,@,@,@,@,@,10]]|191,0,29,-24,13,2,[[@,68]]|9,0,-32,-18,5,5,[[@,83,83,@,@,10,@,@,10,10,@,@,@,@,@,1]]|12,0,-46,-7,5,5,[[@,65,81]]|188,0,67,-3,1,22,[[@,80,80,@,@,17,44,@,@,@,@,240,1]]|123,0,-5,-3,1,22,[[@,80,80,@,@,17,44,@,@,@,@,240,1]]|68,1,-50,-11,2,11,[[@,76,4],@,[@,78]]|234,3,18,13,2,11,[[@,60,@,@,@,5,6,7]]|105,1,-49,12,7,3,[[@,76,4],@,[@,78]]|181,0,25,1,2,8,[[@,66,83,@,@,@,@,@,@,@,@,10]]|125,0,-45,1,2,8,[[@,68,83,@,@,@,@,@,@,@,@,10]]|129,0,-49,1,2,8,[[@,64,83,@,@,@,@,@,@,@,@,10]]|182,0,27,1,2,8,[[@,68,83,@,@,@,@,@,@,@,@,10]]|130,0,-51,1,2,8,[[@,62,79,@,@,@,@,@,@,@,@,10]]|135,0,-69,1,2,8,[[@,75,75,@,@,@,@,@,@,@,@,10]]|183,0,21,1,2,8,[[@,62,79,@,@,@,@,@,@,@,@,10]]|127,0,-47,1,2,8,[[@,66,83,@,@,@,@,@,@,@,@,10]]|184,0,23,1,2,8,[[@,64,83,@,@,@,@,@,@,@,@,10]]|220,3,1,18,4,4,[[@,75,@,@,@,4,5,6]]|219,3,-5,3,4,4,[[@,75,@,@,@,4,5,6]]|218,3,1,-11,4,4,[[@,75,@,@,@,4,5,6]]|103,0,-51,15,2,7,[[@,71,83]]|180,0,21,15,2,7,[[@,71,83,@,@,@,@,@,@,@,@,@,3]]|47,0,-42,0,12,1,[[@,68,83]]|171,0,21,-20,1,12,[[@,71,83]]|179,0,30,0,12,1,[[@,68,83]]|111,0,-30,22,2,5,[[@,66,100,@,@,@,@,@,@,@,@,@,@,@,@,0]]|178,0,42,22,2,5,[[@,66,100,@,@,@,@,@,@,@,@,@,@,@,@,0]]|240,3,-5,-3,2,5,[[@,69,@,@,@,48]]|243,3,3,-3,2,5,[[@,69,@,@,@,49]]|242,3,3,8,2,5,[[@,69,@,@,@,49]]|241,3,-5,8,2,5,[[@,69,@,@,@,48]]|176,1,70,-1,4,2,[[@,86,2,@,@,59,53],@,[@,78]]|173,1,70,-10,4,2,[[@,86,2,@,@,59,53],@,[@,78]]|177,1,70,11,4,2,[[@,86,2,@,@,59,53],@,[@,78]]|174,1,70,5,4,2,[[@,86,2,@,@,59,53],@,[@,78]]|175,1,70,22,4,2,[[@,86,2,@,@,59,53],@,[@,78]]|172,0,48,21,1,7,[[@,66,83]]|44,0,-25,-12,1,7,[[@,66,83]]|170,0,47,-12,1,7,[[@,66,83]]|104,0,-24,21,1,7,[[@,66,83]]|46,0,-51,-17,1,6,[[@,71,83]]|228,3,21,-20,1,6,[[@,71,@,@,@,71]]|229,3,-51,-17,1,6,[[@,71,@,@,@,71]]|227,3,21,-14,1,6,[[@,71,@,@,@,71]]|169,0,29,3,1,4,[[@,68,79,@,@,@,@,@,@,@,@,10]]|10,0,-38,-10,2,2,[[@,82,82,@,@,@,@,@,@,@,@,@,@,@,@,1],@,[@,80]]|168,0,34,-10,2,2,[[@,82,82,@,@,@,45,@,@,@,@,@,@,@,@,1],@,[@,80]]|185,0,4,3,1,4,[[@,62,75,@,@,@,@,@,@,@,@,10]]|167,0,75,18,1,4,[[@,76,82,@,@,@,@,@,@,@,@,@,@,@,@,0],@,[@,80]]|124,0,-43,3,1,4,[[@,68,79,@,@,@,@,@,@,@,@,10]]|159,0,51,-13,3,1,[[@,72,72]]|160,0,51,-5,3,1,[[@,72,72]]|161,0,64,28,3,1,[[@,72,72]]|162,0,57,-13,3,1,[[@,72,72]]|163,0,63,-5,3,1,[[@,72,72]]|164,0,57,-5,3,1,[[@,72,72]]|166,0,52,20,3,1,[[@,72,72]]|59,0,-15,-13,3,1,[[@,72,72]]|97,0,-8,28,3,1,[[@,72,72]]|53,0,-21,-5,3,1,[[@,72,72]]|102,0,-8,20,3,1,[[@,72,72]]|99,0,-20,28,3,1,[[@,72,72]]|60,0,-15,-5,3,1,[[@,72,72]]|98,0,-20,20,3,1,[[@,72,72]]|57,0,-9,-5,3,1,[[@,72,72]]|54,0,-21,-13,3,1,[[@,72,72]]|109,0,-43,26,1,3,[[@,83,83,@,@,10,@,@,10,10,@,@,@,@,@,1]]|101,0,-14,20,3,1,[[@,72,72]]|100,0,-14,28,3,1,[[@,72,72]]|165,0,52,28,3,1,[[@,72,72]]|155,0,64,20,3,1,[[@,72,72]]|156,0,58,28,3,1,[[@,72,72]]|157,0,58,20,3,1,[[@,72,72]]|158,0,29,26,1,3,[[@,83,83,@,@,10,@,@,10,10,@,@,@,@,@,1]]|237,0,29,-6,1,1,[[@,72,82,@,@,82,82,@,@,@,@,@,@,@,@,0],@,[@,80]]|236,0,25,-6,1,1,[[@,72,82,@,@,82,82,@,@,@,@,@,@,@,@,0],@,[@,80]]|238,0,25,-3,1,1,[[@,72,82,@,@,82,82,@,@,@,@,@,@,@,@,0],@,[@,80]]|239,0,29,-3,1,1,[[@,72,82,@,@,82,82,@,@,@,@,@,@,@,@,0],@,[@,80]]|235,4,72,9,0,0,[[@,77,@,@,@,@,35,36,@,@,@,@,@,@,@,@,@,@,@,@,@,@,@,@,@,0]]|154,4,72,-4,0,0,[[@,77,@,@,@,@,35,36,@,@,@,@,@,@,@,@,@,@,@,@,@,@,@,@,@,0]]|64,4,-44,-4,0,0,[[@,68]]|153,5,60,24,0,0,[[-90,64,@,@,@,3,181,@,127,@,183,163,201,@,@,@,@,75,57,56,60,71],[],[@,@,@,-30,-17],[],@,@,@,@,@,@,@,[]]|95,5,-12,24,0,0,[[-90,64,@,@,@,2,181,@,127,@,183,163,201,55,56,@,@,75,57,56,60,71],[],[@,@,@,42,-17],[],@,@,@,@,@,@,@,[]]|150,5,37,-17,0,0,[[0,68,@,@,@,1,100,30,100,252,100,178,7,@,@],@,@,[],@,@,@,@,@,@,[],[]]|94,5,-35,17,0,0,[[-180,68,@,@,@,@,100,@,100,@,100,178,216,69,51],@,@,[],@,@,@,@,@,@,[],[]]|151,5,59,-9,0,0,[[-90,64,@,@,@,3,181,@,127,@,183,163,201,@,@,@,@,75,57,56,60,71],[],[@,@,@,-29,16],[],@,@,@,@,@,@,@,[]]|152,5,35,29,0,0,[[-180,68,@,@,@,@,100,@,100,@,100,178,216,69,49],@,@,[],@,@,@,@,@,@,[],[]]|62,5,-13,-9,0,0,[[-90,64,@,@,@,2,181,@,127,@,183,163,201,55,56,@,@,75,57,56,60,71],[],[@,@,@,43,16],[],@,@,@,@,@,@,@,[]]|63,5,-36,-16,0,0,[[0,68,@,@,@,@,100,@,100,@,100,178,216,69,50],@,@,[],@,@,@,@,@,@,[],[]]|147,6,32,37,0,0,[[@,@,@,@,@,@,@,@,@,@,@,55,7]]|221,6,3,20,0,0,[[@,@,@,@,@,@,@,@,@,@,@,@,2]]|232,6,18,18,0,0,[[@,@,@,@,@,@,@,@,@,@,@,40,3]]|92,6,-40,37,0,0,[[@,@,@,@,@,@,@,@,@,@,@,55,7]]|88,6,-36,18,0,0,[[@,@,@,@,@,@,@,@,@,@,@,55,7]]|224,6,9,0,0,0,[[]]|225,6,10,-23,0,0,[[]]|226,6,7,16,0,0,[[]]|148,6,29,-13,0,0,[[@,@,@,@,@,@,@,@,@,@,@,35,0]]|149,6,36,22,0,0,[[@,@,@,@,@,@,@,@,@,@,@,30,8]]|223,6,3,-9,0,0,[[@,@,@,@,@,@,@,@,@,@,@,@,2]]|222,6,-3,5,0,0,[[@,@,@,@,@,@,@,@,@,@,@,@,2]]|91,6,-45,-15,0,0,[[@,@,@,@,@,@,@,@,@,@,@,35,3]]~140"))})};

}
/*
     FILE ARCHIVED ON 00:22:37 Nov 07, 2015 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 20:28:49 Jan 16, 2021.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
*/
/*
playback timings (ms):
  esindex: 0.028
  RedisCDXSource: 20.239
  exclusion.robots.policy: 0.344
  PetaboxLoader3.datanode: 403.834 (4)
  CDXLines.iter: 41.395 (3)
  captures_list: 388.543
  LoadShardBlock: 319.698 (3)
  load_resource: 254.098
  exclusion.robots: 0.364
  PetaboxLoader3.resolve: 110.611
*/